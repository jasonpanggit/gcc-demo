/**
 * Agent Communication - Backward Compatibility Wrapper
 * Loads ES module and exposes to global scope for legacy code
 * @deprecated Use ES module import instead
 */

(async function() {
    'use strict';

    try {
        // Import ES module
        const module = await import('./modules/agent-communication.js');

        // Expose classes and functions to window
        window.AgentCommunicationHandler = module.AgentCommunicationHandler;
        window.hasContent = module.hasContent;
        window.parseMaybeJson = module.parseMaybeJson;
        window.formatStatus = module.formatStatus;
        window.formatActionDescription = module.formatActionDescription;
        window.normalizeCommPayload = module.normalizeCommPayload;

        // Handlers registry
        window.agentCommHandlers = window.agentCommHandlers || {};
        window.agentCommDefaultOptions = window.agentCommDefaultOptions || { showFlow: true };

        /**
         * Noop handler for load-order safety
         */
        function makeNoopHandler(containerId) {
            return {
                __isAgentCommNoop: true,
                containerId: containerId || 'communicationsStream',
                taskStartTime: Date.now(),
                initialize() { this.taskStartTime = Date.now(); },
                addInteraction() { },
                clearDisplay() { },
                getInteractions() { return []; },
                addCompletionMessage() { },
                addTokenSummary() { },
                expandInteraction() { },
                clearInteractions() { },
                reset() { }
            };
        }

        /**
         * Create or retrieve handler
         */
        function createAgentCommHandler(containerId, opts = {}) {
            const key = containerId || 'communicationsStream';
            window.agentCommHandlers = window.agentCommHandlers || {};

            const mergedOpts = { ...window.agentCommDefaultOptions, ...opts };

            // Auto-detect chat-style containers
            const lowerKey = String(key).toLowerCase();
            if (lowerKey.includes('chat')) {
                mergedOpts.showFlow = false;
                mergedOpts.autoExpand = false;
            }

            // Return existing handler if available
            if (window.agentCommHandlers[key] && !window.agentCommHandlers[key].__isAgentCommNoop) {
                return window.agentCommHandlers[key];
            }

            try {
                const handler = new module.AgentCommunicationHandler({ ...mergedOpts, containerId: key });
                window.agentCommHandlers[key] = handler;
                return handler;
            } catch (err) {
                console.error('Failed to create AgentCommunicationHandler:', err);
                const fallback = makeNoopHandler(key);
                window.agentCommHandlers[key] = fallback;
                return fallback;
            }
        }

        /**
         * Toggle interaction expansion
         */
        function toggleInteraction(interactionId) {
            Object.values(window.agentCommHandlers || {}).forEach(h => {
                try {
                    if (typeof h.expandInteraction === 'function') {
                        h.expandInteraction(interactionId);
                    }
                } catch (e) {
                    // Ignore errors
                }
            });
        }

        /**
         * Display agent communications
         */
        function displayAgentCommunications(communications, options = {}) {
            const containerId = options.containerId || 'communicationsStream';
            const showFlow = options.showFlow ?? true;

            const handler = createAgentCommHandler(containerId, { showFlow });
            handler.initialize();

            if (!communications || communications.length === 0) {
                handler.clearDisplay();
                return;
            }

            // Filter communications
            const filteredCommunications = communications.filter(comm => {
                const agentName = comm.agent_name || comm.agentName || comm.agent || comm.name || '';
                const action = comm.action || '';

                if (agentName.toLowerCase().includes('orchestrator')) {
                    const isInternal = action.includes('_internal_init') || action.includes('_bootstrap');
                    return !isInternal;
                }

                return true;
            });

            if (filteredCommunications.length === 0) {
                handler.clearDisplay();
                return;
            }

            // Add summary
            handler.addInteraction(
                'üìã System',
                `Agent Framework Task Results (${filteredCommunications.length} entries)`,
                'summary'
            );

            // Process communications
            filteredCommunications.forEach((comm, index) => {
                try {
                    module.normalizeCommPayload(comm);

                    const agentName = comm.agent_name || comm.agentName || comm.agent || comm.name || `Agent ${index + 1}`;

                    let actualStatus = 'general';
                    const hasOutput = module.hasContent(comm._output);
                    if (hasOutput && !comm.error) {
                        actualStatus = 'completed';
                    } else if (comm.error) {
                        actualStatus = 'failed';
                    } else if (comm.action || module.hasContent(comm._input)) {
                        actualStatus = 'in_progress';
                    }

                    const inputData = comm._input || {};
                    const outputData = comm._output || {};
                    const inputHasContent = module.hasContent(inputData);
                    const outputHasContent = module.hasContent(outputData);
                    const shouldShowOutput = outputHasContent || (actualStatus === 'completed' && outputData !== null);

                    const content = `
                        <div class="generic-response">
                            ${comm.action ? `<div class="comm-action"><strong>Action:</strong> ${module.formatActionDescription(comm.action)}</div>` : ''}
                            ${inputHasContent ? `<div class="input-section">
                                <strong>Input:</strong>
                                <pre class="json-display">${typeof inputData === 'string' ? inputData : JSON.stringify(inputData, null, 2)}</pre>
                            </div>` : ''}
                            ${shouldShowOutput ? `<div class="output-section">
                                <strong>Output:</strong>
                                <pre class="json-display">${typeof outputData === 'string' ? outputData : JSON.stringify(outputData, null, 2)}</pre>
                            </div>` : ''}
                            <div><strong>Status:</strong> <span class="status-${actualStatus}">${module.formatStatus(actualStatus)}</span></div>
                        </div>
                    `;

                    handler.addInteraction(agentName, content, 'text', {
                        action: comm.action,
                        status: actualStatus,
                        timestamp: comm.timestamp,
                        input: inputData,
                        output: outputData
                    });

                } catch (error) {
                    console.error('Error processing communication:', error);
                    handler.addInteraction(
                        'üö® Error Handler',
                        `Error processing communication: ${error.message}`,
                        'error'
                    );
                }
            });

            // Add completion message
            if (filteredCommunications.length > 0) {
                const elapsedTime = Date.now() - handler.taskStartTime;
                handler.addCompletionMessage(elapsedTime);
            }
        }

        // Expose functions
        window.createAgentCommHandler = createAgentCommHandler;
        window.toggleInteraction = toggleInteraction;
        window.displayAgentCommunications = displayAgentCommunications;

        // Create default handler
        const agentCommHandler = createAgentCommHandler('communicationsStream');
        window.agentCommHandler = agentCommHandler;

        // Create AgentComm namespace
        window.AgentComm = {
            createHandler: createAgentCommHandler,
            display: displayAgentCommunications,
            toggle: toggleInteraction,
            handlers: window.agentCommHandlers,
            defaults: window.agentCommDefaultOptions,
            formatStatus: module.formatStatus,
            formatActionDescription: module.formatActionDescription,

            clearInteractions(containerId = 'communicationsStream') {
                const handler = window.agentCommHandlers?.[containerId];
                if (handler && typeof handler.clearInteractions === 'function') {
                    handler.clearInteractions();
                    return true;
                }
                return false;
            },

            clearAll() {
                let cleared = 0;
                Object.keys(window.agentCommHandlers || {}).forEach(containerId => {
                    if (this.clearInteractions(containerId)) {
                        cleared++;
                    }
                });
                return cleared > 0;
            },

            getAgentDisplay(agentName) {
                const tempHandler = new module.AgentCommunicationHandler();
                return tempHandler.formatAgentDisplay(agentName);
            }
        };

        console.log('‚úÖ Agent Communication (ES Module) loaded successfully');

    } catch (error) {
        console.error('‚ùå Failed to load Agent Communication ES module:', error);
        console.error('Falling back to inline implementation...');

        // Provide minimal fallback
        window.AgentCommunicationHandler = class {
            constructor() {
                console.warn('Using fallback AgentCommunicationHandler');
            }
            initialize() {}
            addInteraction() {}
            clearDisplay() {}
        };
    }
})();
