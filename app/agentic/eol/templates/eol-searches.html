{% extends "base.html" %}

{% block title %}EOL Search History - Azure Agentic Platform{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section fade-in">
    <div class="hero-content">
        <div class="row align-items-center">
            <div class="col-lg-12">
                <h1 class="hero-title">
                    <span class="hero-icon me-3"><i class="fas fa-history"></i></span>EOL Search History
                </h1>
                <p class="hero-subtitle">
                    Comprehensive history of all EOL searches from both Chat and EOL orchestrators. 
                    Track agent performance, response times, and search patterns across your infrastructure.
                </p>
                <div class="d-flex gap-3 justify-content-start flex-wrap">
                    <button class="btn btn-outline-light" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                    <button class="btn btn-outline-light" onclick="exportToCSV()">
                        <i class="fas fa-download me-2"></i>Export History
                    </button>
                    <button class="btn btn-outline-light" onclick="clearAllHistory()">
                        <i class="fas fa-trash me-2"></i>Clear All History
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Container -->
<div class="container-fluid px-0">

    <!-- Statistics Section -->
    <div class="stats-cards fade-in">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-search"></i>
            </div>
            <div class="stat-value" id="totalSearches">0</div>
            <div class="stat-label">Total Searches</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-value" id="successfulSearches">0</div>
            <div class="stat-label">Successful</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-value" id="failedSearches">0</div>
            <div class="stat-label">Failed</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-cube"></i>
            </div>
            <div class="stat-value" id="uniqueSoftware">0</div>
            <div class="stat-label">Unique Software</div>
        </div>
    </div>

    <!-- Content Container -->
    <div class="content-container">

        <!-- Search and Filter Controls -->
        <div class="modern-card fade-in">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Search & Filter
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="searchQuery" class="form-label">Search Software</label>
                    <input type="text" class="form-control" id="searchQuery" placeholder="Search by software name...">
                </div>
                <div class="col-md-3">
                    <label for="orchestratorFilter" class="form-label">Orchestrator</label>
                    <select class="form-select" id="orchestratorFilter">
                        <option value="">All Orchestrators</option>
                        <option value="eol_orchestrator">EOL Orchestrator</option>
                        <option value="inventory_asst_orchestrator">Inventory Assistant Orchestrator</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="successFilter" class="form-label">Result</label>
                    <select class="form-select" id="successFilter">
                        <option value="">All Results</option>
                        <option value="true">Successful</option>
                        <option value="false">Failed</option>
                    </select>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <label for="agentFilter" class="form-label">Agent Used</label>
                    <select class="form-select" id="agentFilter">
                        <option value="">All Agents</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="internetFilter" class="form-label">Internet Search Mode</label>
                    <select class="form-select" id="internetFilter">
                        <option value="">All Searches</option>
                        <option value="include">Agents + Internet</option>
                        <option value="internet_only">Internet Only</option>
                    </select>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <label for="sortBy" class="form-label">Sort By</label>
                    <select class="form-select" id="sortBy">
                        <option value="timestamp_desc">Newest First</option>
                        <option value="timestamp_asc">Oldest First</option>
                        <option value="software_name">Software Name</option>
                        <option value="response_time">Response Time</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

        <!-- Search Results -->
        <div class="modern-card fade-in">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Search Results <span id="resultsCount" class="badge bg-primary">0</span>
            </h5>
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="exportToCSV()">
                    <i class="fas fa-download me-1"></i>Export CSV
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="searchResults">
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h5>No Search History Found</h5>
                    <p>Perform some EOL searches to see the history here.</p>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-wrapper" id="paginationWrapper" style="display: none;">
                <nav>
                    <ul class="pagination" id="pagination">
                        <!-- Pagination items will be dynamically generated -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
    let allResponses = [];
    let filteredResponses = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        loadEOLResponses();
        setupEventListeners();
    });

    function setupEventListeners() {
        // Search and filter event listeners
        document.getElementById('searchQuery').addEventListener('input', applyFilters);
        document.getElementById('orchestratorFilter').addEventListener('change', applyFilters);
        document.getElementById('successFilter').addEventListener('change', applyFilters);
        document.getElementById('agentFilter').addEventListener('change', applyFilters);
        document.getElementById('internetFilter').addEventListener('change', applyFilters);
        document.getElementById('sortBy').addEventListener('change', applyFilters);
    }

    async function loadEOLResponses() {
        try {
            // console.log('ðŸ” [Frontend] Fetching EOL responses from /api/eol-agent-responses');
            const response = await fetch('/api/eol-agent-responses');
            // console.log('ðŸ” [Frontend] Response status:', response.status, response.statusText);
            
            const data = await response.json();
            // console.log('ðŸ” [Frontend] Response data:', data);
            // console.log('ðŸ” [Frontend] data.success:', data.success);
            // console.log('ðŸ” [Frontend] data.data:', data.data);
            // console.log('ðŸ” [Frontend] data.data length:', data.data ? data.data.length : 0);
            
            if (data.success) {
                // StandardResponse format: data is in the 'data' field
                allResponses = data.data || [];
                // console.log('ðŸ” [Frontend] allResponses set to:', allResponses.length, 'items');
                updateStatistics();
                populateAgentFilter();
                applyFilters();
            } else {
                console.error('Failed to load EOL responses:', data.error);
                showError('Failed to load search history: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error loading EOL responses:', error);
            showError('Error loading search history. Please try again.');
        }
    }

    function updateStatistics() {
        const totalSearches = allResponses.length;
        const successfulSearches = allResponses.filter(r => r.success).length;
        const failedSearches = totalSearches - successfulSearches;
        const uniqueSoftware = new Set(allResponses.map(r => r.software_name.toLowerCase())).size;

        document.getElementById('totalSearches').textContent = totalSearches;
        document.getElementById('successfulSearches').textContent = successfulSearches;
        document.getElementById('failedSearches').textContent = failedSearches;
        document.getElementById('uniqueSoftware').textContent = uniqueSoftware;
    }

    function populateAgentFilter() {
        const agents = new Set(allResponses.map(r => r.agent_name));
        const agentFilter = document.getElementById('agentFilter');
        
        // Clear existing options except the first one
        while (agentFilter.children.length > 1) {
            agentFilter.removeChild(agentFilter.lastChild);
        }

        // Add agent options
        agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent;
            option.textContent = formatAgentName(agent);
            agentFilter.appendChild(option);
        });
    }

    function applyFilters() {
        const searchQuery = document.getElementById('searchQuery').value.toLowerCase();
        const orchestratorFilter = document.getElementById('orchestratorFilter').value;
        const successFilter = document.getElementById('successFilter').value;
        const agentFilter = document.getElementById('agentFilter').value;
        const internetFilter = document.getElementById('internetFilter').value;
        const sortBy = document.getElementById('sortBy').value;

        // Apply filters
        filteredResponses = allResponses.filter(response => {
            // Search query filter
            if (searchQuery && !response.software_name.toLowerCase().includes(searchQuery)) {
                return false;
            }

            // Orchestrator filter
            if (orchestratorFilter) {
                const orchestratorType = response.orchestrator_type || 'inventory_asst_orchestrator';
                if (orchestratorType !== orchestratorFilter) {
                    return false;
                }
            }

            // Success filter
            if (successFilter !== '' && response.success.toString() !== successFilter) {
                return false;
            }

            // Agent filter
            if (agentFilter && response.agent_name !== agentFilter) {
                return false;
            }

            // Internet search mode filter
            const isInternetOnly = Boolean(response.search_internet_only);
            if (internetFilter === 'internet_only' && !isInternetOnly) {
                return false;
            }
            if (internetFilter === 'include' && isInternetOnly) {
                return false;
            }

            return true;
        });

        // Apply sorting
        sortResponses(filteredResponses, sortBy);

        // Reset to first page
        currentPage = 1;
        renderResults();
        renderPagination();
    }

    function sortResponses(responses, sortBy) {
        switch (sortBy) {
            case 'timestamp_desc':
                responses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                break;
            case 'timestamp_asc':
                responses.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                break;
            case 'software_name':
                responses.sort((a, b) => a.software_name.localeCompare(b.software_name));
                break;
            case 'response_time':
                responses.sort((a, b) => a.response_time - b.response_time);
                break;
        }
    }

    function renderResults() {
        const resultsContainer = document.getElementById('searchResults');
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageResults = filteredResponses.slice(start, end);

        document.getElementById('resultsCount').textContent = filteredResponses.length;

        if (pageResults.length === 0) {
            resultsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h5>No Results Found</h5>
                    <p>Try adjusting your search criteria.</p>
                </div>
            `;
            return;
        }

        const html = pageResults.map(response => createResponseHTML(response)).join('');
        resultsContainer.innerHTML = html;
    }

    function createResponseHTML(response) {
        const timestamp = new Date(response.timestamp).toLocaleString();
        const orchestratorType = response.orchestrator_type || 'inventory_asst_orchestrator';
        const successClass = response.success ? 'success' : 'failure';
        const responseTimeClass = getResponseTimeClass(response.response_time);
        const cacheBadge = buildCacheBadge(response);
        const searchModeBadge = buildSearchModeBadge(response);
        
        // Format EOL data
        let eolContent = '';
        if (response.success && response.eol_data) {
            const eolDate = response.eol_data.eol_date || response.eol_data.end_of_life;
            const supportDate = response.eol_data.support_end || response.eol_data.extended_support_end;
            
            // Extract source URL if it's an object
            let sourceUrl = response.eol_data.source_url;
            if (sourceUrl && typeof sourceUrl === 'object' && sourceUrl.url) {
                sourceUrl = sourceUrl.url;
            }
            
            eolContent = `
                <div class="mt-2">
                    <strong>EOL Information:</strong>
                    ${eolDate ? `<span class="eol-badge ${isDateExpired(eolDate) ? 'expired' : 'active'} ms-2">EOL: ${eolDate}</span>` : ''}
                    ${supportDate ? `<span class="eol-badge ${isDateExpired(supportDate) ? 'expired' : 'active'} ms-2">Support: ${supportDate}</span>` : ''}
                    ${sourceUrl ? `<br><small><a href="${sourceUrl}" target="_blank">Source</a></small>` : ''}
                </div>
            `;
        }

        return `
            <div class="response-item ${successClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2 flex-wrap">
                            <h6 class="mb-0 me-3">${response.software_name}</h6>
                            <div class="agent-info-container">
                                <span class="agent-badge ${orchestratorType}">
                                    <i class="fas fa-cogs"></i>
                                    ${formatOrchestratorType(orchestratorType)}
                                </span>
                                <span class="agent-badge ${response.agent_name}">
                                    <i class="fas fa-robot"></i>
                                    ${formatAgentName(response.agent_name)}
                                </span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Version: ${response.software_version}</small><br>
                                <small class="text-muted">Query Type: ${response.query_type}</small><br>
                                <small class="text-muted">Session: ${response.session_id ? response.session_id.substring(0, 8) + '...' : 'N/A'}</small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Timestamp: ${timestamp}</small><br>
                                <small class="response-time ${responseTimeClass}">Response Time: ${response.response_time.toFixed(2)}s</small><br>
                                ${response.confidence ? `<small class="text-muted">Confidence: ${(response.confidence * 100).toFixed(1)}%</small>` : ''}
                                ${cacheBadge}
                                ${searchModeBadge}
                            </div>
                        </div>
                        ${eolContent}
                        ${response.error && Object.keys(response.error).length > 0 ? `<div class="mt-2 text-danger"><small>Error: ${JSON.stringify(response.error)}</small></div>` : ''}
                    </div>
                    <div class="ms-3">
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleDetails('${response.session_id || Math.random()}')">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                <div class="collapse-content" id="details-${response.session_id || Math.random()}" style="display: none;">
                    <pre class="mb-0"><code>${JSON.stringify(response, null, 2)}</code></pre>
                </div>
            </div>
        `;
    }

    function formatOrchestratorType(type) {
        const types = {
            'eol_orchestrator': 'EOL Orchestrator',
            // 'eol-orchestrator': 'EOL Orchestrator',
            'inventory_asst_orchestrator': 'Inventory Assistant Orchestrator',
            // 'chat-orchestrator': 'Chat Orchestrator',
            'magentic_one': 'Magentic-One'
            // 'magentic-one': 'Magentic-One'
        };
        return types[type] || type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function formatAgentName(name) {
        const agentNames = {
            'microsoft_agent': 'Microsoft EOL',
            // 'microsoft-agent': 'Microsoft EOL',
            'endoflife_agent': 'EndOfLife.date',
            // 'endoflife-agent': 'EndOfLife.date',
            'ubuntu_agent': 'Ubuntu EOL',
            // 'ubuntu-agent': 'Ubuntu EOL',
            'redhat_agent': 'Red Hat EOL',
            // 'redhat-agent': 'Red Hat EOL',
            'oracle_agent': 'Oracle EOL',
            // 'oracle-agent': 'Oracle EOL',
            'vmware_agent': 'VMware EOL',
            // 'vmware-agent': 'VMware EOL',
            'apache_agent': 'Apache EOL',
            // 'apache-agent': 'Apache EOL',
            'nodejs_agent': 'Node.js EOL',
            // 'nodejs-agent': 'Node.js EOL',
            'python_agent': 'Python EOL',
            // 'python-agent': 'Python EOL',
            'php_agent': 'PHP EOL',
            // 'php-agent': 'PHP EOL',
            'postgresql_agent': 'PostgreSQL EOL',
            // 'postgresql-agent': 'PostgreSQL EOL',
            'azure_ai_agent': 'Azure AI Agent'
            // 'azure-ai-agent': 'Azure AI Agent',
            // 'azureai': 'Azure AI Agent'
        };
        
        return agentNames[name] || name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function getResponseTimeClass(time) {
        if (time < 1) return 'fast';
        if (time < 3) return 'medium';
        return 'slow';
    }

    function buildCacheBadge(response) {
        if (!response.cached && response.cache_source !== 'cosmos_eol_table') {
            return '';
        }
        const updated = response.cache_created_at ? new Date(response.cache_created_at).toLocaleString() : 'unknown';
        return `<small class="badge bg-success ms-1">EOL Table</small><br><small class="text-muted">Cached: ${updated}</small>`;
    }

    function buildSearchModeBadge(response) {
        const isInternetOnly = Boolean(response.search_internet_only);
        if (isInternetOnly) {
            return `<small class="badge bg-info ms-1">Internet Only</small>`;
        }
        // Explicitly show when internet search was included alongside agents
        return `<small class="badge bg-secondary ms-1">Agents + Internet</small>`;
    }

    function isDateExpired(dateStr) {
        if (!dateStr) return false;
        try {
            const date = new Date(dateStr);
            return date < new Date();
        } catch {
            return false;
        }
    }

    function toggleDetails(id) {
        const details = document.getElementById(`details-${id}`);
        if (details) {
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
        }
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredResponses.length / itemsPerPage);
        const paginationWrapper = document.getElementById('paginationWrapper');
        const pagination = document.getElementById('pagination');

        if (totalPages <= 1) {
            paginationWrapper.style.display = 'none';
            return;
        }

        paginationWrapper.style.display = 'block';
        pagination.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
        pagination.appendChild(prevLi);

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(li);
            }
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
        pagination.appendChild(nextLi);
    }

    function changePage(page) {
        const totalPages = Math.ceil(filteredResponses.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderResults();
            renderPagination();
        }
    }

    function refreshData() {
        loadEOLResponses();
    }

    async function clearAllHistory() {
        if (!confirm('Are you sure you want to clear all EOL search history? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch('/api/eol-agent-responses/clear', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.success) {
                allResponses = [];
                filteredResponses = [];
                updateStatistics();
                renderResults();
                renderPagination();
                showSuccess('All search history cleared successfully.');
            } else {
                showError('Failed to clear history: ' + data.error);
            }
        } catch (error) {
            console.error('Error clearing history:', error);
            showError('Error clearing history. Please try again.');
        }
    }

    function exportToCSV() {
        if (filteredResponses.length === 0) {
            showError('No data to export.');
            return;
        }

        const csvHeaders = [
            'Timestamp', 'Software Name', 'Version', 'Agent Used', 'Orchestrator',
            'Internet Only', 'Success', 'Query Type', 'Response Time', 'Confidence', 'EOL Date', 'Support End'
        ];

        const csvRows = filteredResponses.map(response => [
            response.timestamp,
            response.software_name,
            response.software_version,
            response.agent_name,
            response.orchestrator_type || 'inventory_asst_orchestrator',
            Boolean(response.search_internet_only),
            response.success,
            response.query_type,
            response.response_time,
            response.confidence || '',
            response.eol_data?.eol_date || response.eol_data?.end_of_life || '',
            response.eol_data?.support_end || response.eol_data?.extended_support_end || ''
        ]);

        const csvContent = [csvHeaders, ...csvRows]
            .map(row => row.map(field => `"${field}"`).join(','))
            .join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `eol-search-history-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    function showSuccess(message) {
        // Simple alert for now - could be replaced with a toast notification
        alert('Success: ' + message);
    }

    function showError(message) {
        // Simple alert for now - could be replaced with a toast notification
        alert('Error: ' + message);
    }
</script>

{% endblock %}