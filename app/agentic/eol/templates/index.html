{% extends "base.html" %}

{% block title %}Dashboard — Azure Agentic Platform{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-title">
        <h1>Dashboard</h1>
        <p class="text-muted">Welcome to Azure Agentic Platform</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
    </div>
</div>

<!-- Stats Grid -->
<div class="dashboard-grid">
    <!-- Active Agents Stat -->
    <div class="stat-widget glass hover-lift">
        <div class="stat-icon bg-primary">
            <i class="fas fa-robot"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Active Agents</div>
            <div class="stat-value" id="dash-active-agents">—</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i> <span id="agents-change">—</span>
            </div>
        </div>
        <div class="stat-sparkline">
            <canvas id="sparkline-agents" width="200" height="48"></canvas>
        </div>
    </div>

    <!-- Cached Items Stat -->
    <div class="stat-widget glass hover-lift">
        <div class="stat-icon bg-success">
            <i class="fas fa-database"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Cached Items</div>
            <div class="stat-value" id="dash-total-cache">—</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i> <span id="cache-change">—</span>
            </div>
        </div>
        <div class="stat-sparkline">
            <canvas id="sparkline-cache" width="200" height="48"></canvas>
        </div>
    </div>

    <!-- AI Sessions Stat -->
    <div class="stat-widget glass hover-lift">
        <div class="stat-icon bg-info">
            <i class="fas fa-comments"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">AI Sessions</div>
            <div class="stat-value" id="dash-chat-sessions">—</div>
            <div class="stat-change neutral">
                <i class="fas fa-minus"></i> <span id="sessions-change">—</span>
            </div>
        </div>
        <div class="stat-sparkline">
            <canvas id="sparkline-sessions" width="200" height="48"></canvas>
        </div>
    </div>

    <!-- Database Items Stat -->
    <div class="stat-widget glass hover-lift">
        <div class="stat-icon bg-warning">
            <i class="fas fa-box"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Database Items</div>
            <div class="stat-value" id="dash-cosmos-items">—</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i> <span id="cosmos-change">—</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions Widget -->
    <div class="widget glass hover-lift" style="grid-column: span 2;">
        <div class="widget-header">
            <h3 class="widget-title">
                <i class="fas fa-bolt"></i>Quick Actions
            </h3>
        </div>
        <div class="widget-body">
            <div class="quick-actions-grid">
                <a href="/azure-mcp" class="quick-action">
                    <div class="quick-action-icon bg-gradient-primary">
                        <i class="fas fa-magic"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Azure MCP</div>
                        <div class="quick-action-desc">AI Assistant</div>
                    </div>
                </a>

                <a href="/azure-ai-sre" class="quick-action">
                    <div class="quick-action-icon bg-gradient-success">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SRE Assistant</div>
                        <div class="quick-action-desc">Site Reliability</div>
                    </div>
                </a>

                <a href="/eol-search" class="quick-action">
                    <div class="quick-action-icon bg-gradient-warning">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">EOL Search</div>
                        <div class="quick-action-desc">Find Lifecycles</div>
                    </div>
                </a>

                <a href="/visualizations" class="quick-action">
                    <div class="quick-action-icon bg-gradient-info">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Analytics</div>
                        <div class="quick-action-desc">View Reports</div>
                    </div>
                </a>

                <a href="/resource-inventory" class="quick-action">
                    <div class="quick-action-icon bg-gradient-primary">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Resources</div>
                        <div class="quick-action-desc">Azure Inventory</div>
                    </div>
                </a>

                <a href="/inventory-assistant" class="quick-action">
                    <div class="quick-action-icon bg-gradient-success">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Inventory AI</div>
                        <div class="quick-action-desc">Smart Analysis</div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Recent Activity Widget -->
    <div class="widget glass hover-lift" style="grid-column: span 2;">
        <div class="widget-header">
            <h3 class="widget-title">
                <i class="fas fa-activity"></i>Recent Activity
            </h3>
            <div class="widget-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        <div class="widget-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Agent</th>
                            <th>Action</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody id="recent-activity">
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading activity...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Health Widget -->
    <div class="widget glass hover-lift">
        <div class="widget-header">
            <h3 class="widget-title">
                <i class="fas fa-heartbeat"></i>System Health
            </h3>
            <span class="badge bg-success" id="health-badge">Healthy</span>
        </div>
        <div class="widget-body">
            <div class="health-metrics">
                <div class="health-metric">
                    <div class="health-label">API Response</div>
                    <div class="health-value" id="health-api">—</div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-success" style="width: 85%" id="health-api-bar"></div>
                    </div>
                </div>
                <div class="health-metric">
                    <div class="health-label">Cache Hit Rate</div>
                    <div class="health-value" id="health-cache">—</div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-success" style="width: 92%" id="health-cache-bar"></div>
                    </div>
                </div>
                <div class="health-metric">
                    <div class="health-label">Database Load</div>
                    <div class="health-value" id="health-db">—</div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-info" style="width: 35%" id="health-db-bar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Status Widget -->
    <div class="widget glass hover-lift">
        <div class="widget-header">
            <h3 class="widget-title">
                <i class="fas fa-cogs"></i>Agent Status
            </h3>
        </div>
        <div class="widget-body">
            <div class="agent-status-list" id="agent-status">
                <div class="text-center text-muted py-3">
                    <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function fetchJson(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                console.error(`Failed to fetch ${url}: ${response.status}`);
                return null;
            }
            return await response.json();
        } catch (error) {
            console.error(`Error fetching ${url}:`, error);
            return null;
        }
    }

    async function refreshDashboard() {
        try {
            const [cacheStatus, inventoryStats, enhancedStats, health] = await Promise.all([
                fetchJson('/api/cache/status'),
                fetchJson('/api/cache/inventory/stats'),
                fetchJson('/api/cache/stats/enhanced'),
                fetchJson('/health')
            ]);

            updateStats(cacheStatus, inventoryStats, enhancedStats, health);
            updateRecentActivity(enhancedStats, cacheStatus);
            updateHealth(health, enhancedStats);
            updateAgentStatus(enhancedStats);
        } catch (error) {
            console.error('Dashboard refresh error:', error);
        }
    }

    function updateStats(cacheStatus, inventoryStats, enhancedStats, health) {
        const enhancedData = enhancedStats?.data?.[0];

        // Active Agents
        let activeAgents = 0;
        if (enhancedData?.agent_stats?.agents) {
            activeAgents = Object.keys(enhancedData.agent_stats.agents).length;
        }
        document.getElementById('dash-active-agents').textContent = activeAgents;
        document.getElementById('agents-change').textContent = activeAgents > 0 ? `${activeAgents} active` : 'None';

        // Total Cache
        let totalCache = 0;
        if (enhancedData?.agent_stats?.summary) {
            totalCache += enhancedData.agent_stats.summary.total_cache_hits || 0;
        }
        document.getElementById('dash-total-cache').textContent = totalCache.toLocaleString();
        document.getElementById('cache-change').textContent = `${totalCache} items`;

        // AI Sessions
        let sessions = 0;
        if (enhancedData?.performance_summary) {
            sessions = enhancedData.performance_summary.total_requests || 0;
        }
        document.getElementById('dash-chat-sessions').textContent = sessions;
        document.getElementById('sessions-change').textContent = `${sessions} total`;

        // Database Items
        let cosmosItems = 0;
        if (enhancedData?.cosmos_stats) {
            cosmosItems = enhancedData.cosmos_stats.total_requests || 0;
        }
        document.getElementById('dash-cosmos-items').textContent = cosmosItems.toLocaleString();
        document.getElementById('cosmos-change').textContent = `${cosmosItems} requests`;
    }

    function updateHealth(health, enhancedStats) {
        const enhancedData = enhancedStats?.data?.[0];

        // Health badge
        const isHealthy = health?.status === 'ok' || health?.status === 'healthy';
        const badge = document.getElementById('health-badge');
        badge.textContent = isHealthy ? 'Healthy' : 'Degraded';
        badge.className = isHealthy ? 'badge bg-success' : 'badge bg-danger';

        // API Response
        const apiResponse = enhancedData?.performance_summary?.avg_response_time_ms || 0;
        document.getElementById('health-api').textContent = apiResponse > 0 ? `${Math.round(apiResponse)}ms` : 'N/A';
        const apiPercent = Math.min(100, Math.max(0, 100 - (apiResponse / 10)));
        document.getElementById('health-api-bar').style.width = `${apiPercent}%`;

        // Cache Hit Rate
        const cacheHits = enhancedData?.agent_stats?.summary?.total_cache_hits || 0;
        const cacheMisses = enhancedData?.agent_stats?.summary?.total_cache_misses || 0;
        const hitRate = cacheHits + cacheMisses > 0 ? (cacheHits / (cacheHits + cacheMisses) * 100) : 0;
        document.getElementById('health-cache').textContent = hitRate > 0 ? `${Math.round(hitRate)}%` : 'N/A';
        document.getElementById('health-cache-bar').style.width = `${hitRate}%`;

        // Database Load
        document.getElementById('health-db').textContent = 'Low';
        document.getElementById('health-db-bar').style.width = '35%';
    }

    function updateRecentActivity(enhancedStats, cacheStatus) {
        const tbody = document.getElementById('recent-activity');
        tbody.innerHTML = '';

        const enhancedData = enhancedStats?.data?.[0];
        let recentActivity = [];

        if (enhancedData?.agent_stats?.agents) {
            const agents = enhancedData.agent_stats.agents;
            for (const [agentName, agentData] of Object.entries(agents)) {
                if (agentData.recent_requests?.length > 0) {
                    const recentRequests = agentData.recent_requests.slice(-3).map(req => ({
                        timestamp: req.timestamp,
                        agent: agentName,
                        action: req.cache_hit ? 'Cache Hit' : 'Cache Miss',
                        result: req.error ? `Error: ${req.error_message || 'Unknown'}` :
                               `${req.software || 'Request'} (${req.response_time_ms?.toFixed(1) || 0}ms)`
                    }));
                    recentActivity = [...recentActivity, ...recentRequests];
                }
            }
        }

        recentActivity.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (recentActivity.length > 0) {
            recentActivity.slice(0, 8).forEach(activity => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-muted small">${formatTime(activity.timestamp)}</td>
                    <td><span class="badge bg-primary">${formatAgentName(activity.agent)}</span></td>
                    <td><span class="badge ${activity.action.includes('Hit') ? 'bg-success' : 'bg-warning'}">${activity.action}</span></td>
                    <td class="small">${activity.result}</td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle me-2"></i>No recent activity
                    </td>
                </tr>
            `;
        }
    }

    function updateAgentStatus(enhancedStats) {
        const container = document.getElementById('agent-status');
        const enhancedData = enhancedStats?.data?.[0];

        if (enhancedData?.agent_stats?.agents) {
            const agents = enhancedData.agent_stats.agents;
            const agentNames = Object.keys(agents).slice(0, 5);

            if (agentNames.length > 0) {
                container.innerHTML = agentNames.map(name => `
                    <div class="agent-status-item">
                        <div class="agent-status-icon">
                            <i class="fas fa-circle text-success"></i>
                        </div>
                        <div class="agent-status-info">
                            <div class="agent-status-name">${formatAgentName(name)}</div>
                            <div class="agent-status-meta">${agents[name].total_requests || 0} requests</div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="text-center text-muted py-3">No active agents</div>';
            }
        } else {
            container.innerHTML = '<div class="text-center text-muted py-3">No data available</div>';
        }
    }

    function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString('en-US', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function formatAgentName(agentName) {
        const nameMap = {
            'inventory_cache': 'Inventory',
            'software_inventory': 'Software',
            'os_inventory': 'OS',
            'endoflife': 'EOL',
            'microsoft': 'Microsoft',
            'cosmos_db': 'Database'
        };
        return nameMap[agentName] || agentName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function refreshActivity() {
        refreshDashboard();
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
        refreshDashboard();
        // Auto-refresh every 2 minutes
        setInterval(refreshDashboard, 120000);
    });
</script>
{% endblock %}
