{% extends "base.html" %}

{% block title %}Dashboard — EOL Agentic Platform{% endblock %}

{% block extra_head %}
<style>
    /* Dashboard-specific styles */
    .action-buttons {
        display: flex;
        gap: var(--spacing-md);
        flex-wrap: wrap;
    }

    .action-btn {
        padding: var(--spacing-md) var(--spacing-xl);
        font-weight: 600;
        border-radius: var(--radius-lg);
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        min-width: 160px;
        justify-content: center;
    }

    .action-btn-primary {
        background: rgba(255, 255, 255, 0.95);
        color: var(--primary-color);
        border: 2px solid transparent;
    }

    .action-btn-primary:hover {
        background: white;
        color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .action-btn-secondary {
        background: transparent;
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .action-btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        transform: translateY(-2px);
    }

    /* White outline button styling for hero sections */
    .btn-outline-light {
        background: transparent;
        color: white;
        border: 2px solid white !important;
        padding: var(--spacing-md) var(--spacing-xl);
        font-weight: 600;
        border-radius: var(--radius-lg);
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        min-width: 160px;
        justify-content: center;
    }

    .btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid white !important;
        transform: translateY(-2px);
        text-decoration: none;
    }

    .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .feature-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .feature-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
        border-color: var(--primary-color);
    }

    .feature-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .feature-card:hover::before {
        transform: scaleX(1);
    }

    .feature-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: var(--spacing-lg);
        font-size: var(--font-size-2xl);
        color: white;
    }

    .feature-title {
        font-size: var(--font-size-xl);
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: var(--spacing-sm);
    }

    .feature-description {
        color: var(--gray-600);
        line-height: 1.6;
        margin-bottom: var(--spacing-lg);
    }

    .feature-link {
        color: var(--primary-color);
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        transition: all 0.2s ease;
    }

    .feature-link:hover {
        color: var(--primary-dark);
        transform: translateX(4px);
    }

    /* Stats grid layout - stat-card styles now in common-components.css */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    @media (max-width: 768px) {
        .d-flex {
            justify-content: flex-start !important;
        }

        .btn-outline-light {
            flex: 1;
            min-width: auto;
        }

        .feature-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section fade-in">
    <div class="hero-content">
        <div class="row align-items-center">
            <div class="col-lg-12">
                <h1 class="hero-title">
                    <i class="fas fa-shield-alt me-3"></i>
                    EOL Agentic Platform
                </h1>
                <p class="hero-subtitle">
                    Intelligent end-of-life analysis and inventory management powered by AI agents. 
                    Orchestrate multi-agent workflows, analyze software lifecycle data, and maintain 
                    comprehensive inventory insights through an advanced agentic architecture.<br/>
                    This platform is built using Azure App Service, Cosmos DB, FastAPI, OpenAI with 
                    Autogen Framework. It pulls real-time inventory data (captured by Azure Arc 
                    inventory features) from Log Analytics Workspace.
                </p>
                <div class="d-flex gap-3 justify-content-start flex-wrap">
                    <a href="/eol-search" class="btn btn-outline-light">
                        <i class="fas fa-search me-2"></i>Start EOL Analysis
                    </a>
                    <a href="/inventory" class="btn btn-outline-light">
                        <i class="fas fa-list-ul me-2"></i>View Inventory
                    </a>
                    <a href="/alerts" class="btn btn-outline-light">
                        <i class="fas fa-bell me-2"></i>Alert Management
                    </a>
                    <a href="/chat" class="btn btn-outline-light">
                        <i class="fas fa-robot me-2"></i>AI Assistant
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid fade-in">
    <div class="stat-card">
        <div class="stat-value" id="dash-active-agents">—</div>
        <div class="stat-label">Active Agents</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="dash-total-cache">—</div>
        <div class="stat-label">Cached Items</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="dash-autogen-sessions">—</div>
        <div class="stat-label">AI Sessions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="dash-cosmos-items">—</div>
        <div class="stat-label">Database Items</div>
    </div>
</div>

<!-- Feature Grid -->
<div class="feature-grid fade-in">
    <div class="feature-card">
        <div class="feature-icon">
            <i class="fas fa-search"></i>
        </div>
        <h3 class="feature-title">EOL Analysis</h3>
        <p class="feature-description">
            Comprehensive end-of-life analysis for software, operating systems, and dependencies. 
            Get accurate lifecycle information and security recommendations.
        </p>
        <a href="/eol-search" class="feature-link">
            Start Analysis <i class="fas fa-arrow-right"></i>
        </a>
    </div>

    <div class="feature-card">
        <div class="feature-icon">
            <i class="fas fa-history"></i>
        </div>
        <h3 class="feature-title">EOL Search History</h3>
        <p class="feature-description">
            Review comprehensive history of all EOL searches from both Chat and EOL orchestrators. 
            Track agent performance, response times, and search patterns.
        </p>
        <a href="/eol-searches" class="feature-link">
            View History <i class="fas fa-arrow-right"></i>
        </a>
    </div>

    <div class="feature-card">
        <div class="feature-icon">
            <i class="fas fa-list-ul"></i>
        </div>
        <h3 class="feature-title">Inventory Management</h3>
        <p class="feature-description">
            Centralized inventory tracking and management. Monitor software versions, 
            compliance status, and asset lifecycle across your infrastructure.
        </p>
        <a href="/inventory" class="feature-link">
            View Inventory <i class="fas fa-arrow-right"></i>
        </a>
    </div>

    <div class="feature-card">
        <div class="feature-icon">
            <i class="fas fa-bell"></i>
        </div>
        <h3 class="feature-title">Alert Management</h3>
        <p class="feature-description">
            Configure intelligent EOL alerts and notifications. Set up advance warning periods, 
            SMTP email delivery, and automated monitoring for proactive system management.
        </p>
        <a href="/alerts" class="feature-link">
            Manage Alerts <i class="fas fa-arrow-right"></i>
        </a>
    </div>

    <div class="feature-card">
        <div class="feature-icon">
            <i class="fas fa-robot"></i>
        </div>
        <h3 class="feature-title">AI Assistant</h3>
        <p class="feature-description">
            Intelligent conversational interface powered by multi-agent workflows. 
            Ask questions, get insights, and automate complex analysis tasks.
        </p>
        <a href="/chat" class="feature-link">
            Open Assistant <i class="fas fa-arrow-right"></i>
        </a>
    </div>

    <div class="feature-card">
        <div class="feature-icon">
            <i class="fas fa-database"></i>
        </div>
        <h3 class="feature-title">Cache Management</h3>
        <p class="feature-description">
            Monitor and manage intelligent caching systems. Optimize performance 
            and ensure data freshness across all analysis engines.
        </p>
        <a href="/cache" class="feature-link">
            Manage Cache <i class="fas fa-arrow-right"></i>
        </a>
    </div>

    <div class="feature-card">
        <div class="feature-icon">
            <i class="fas fa-cogs"></i>
        </div>
        <h3 class="feature-title">Agent Orchestration</h3>
        <p class="feature-description">
            Configure and monitor AI agents. Set up workflows, review performance, 
            and optimize agent collaboration for maximum efficiency.
        </p>
        <a href="/agents" class="feature-link">
            Manage Agents <i class="fas fa-arrow-right"></i>
        </a>
    </div>

    <div class="feature-card">
        <div class="feature-icon">
            <i class="fas fa-heartbeat"></i>
        </div>
        <h3 class="feature-title">System Health</h3>
        <p class="feature-description">
            Real-time monitoring of system performance, API health, and service availability. 
            Ensure optimal platform operations and reliability.
        </p>
        <a href="/health" target="_blank" class="feature-link">
            Check Health <i class="fas fa-external-link-alt"></i>
        </a>
    </div>
</div>

<!-- Recent Activity Section -->
<div class="row mb-4 fade-in">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-activity me-2"></i>Recent Activity
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Agent</th>
                                <th>Action</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity">
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading activity...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Health Status</span>
                        <span id="dash-health" class="badge bg-success">OK</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Cache Performance</span>
                        <span id="dash-cache-performance" class="badge bg-info">Good</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Avg Response</span>
                        <span id="dash-avg-response" class="text-primary">—</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Expiring Items</span>
                        <span id="dash-expiring" class="text-warning">—</span>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="checkHealth()">
                        <i class="fas fa-heartbeat me-1"></i>Check Health
                    </button>
                    <a href="/docs" target="_blank" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-book me-1"></i>Documentation
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    async function fetchJson(url) {
        try {
            const response = await fetch(url);
            
            if (!response.ok) {
                console.error(`Failed to fetch ${url}: ${response.status} ${response.statusText}`);
                return null;
            }
            
            const data = await response.json();
            return data;
        } catch (error) {
            console.error(`Error fetching ${url}:`, error);
            return null;
        }
    }

    async function refreshDashboard() {
        // Show loading indicators
        showLoadingState();

        try {
            // Fetch data from multiple endpoints
            const [cacheStatus, inventoryStats, enhancedStats, health] = await Promise.all([
                fetchJson('/api/cache/status'),
                fetchJson('/api/cache/inventory/stats'),
                fetchJson('/api/cache/stats/enhanced'),
                fetchJson('/health')
            ]);

            // Update stats
            updateStats(cacheStatus, inventoryStats, enhancedStats, health);
            
            // Update recent activity
            updateRecentActivity(enhancedStats, cacheStatus);
            
        } catch (error) {
            console.error('Dashboard refresh error:', error);
            showErrorState();
        }
    }

    function showLoadingState() {
        const loadingElements = ['dash-active-agents', 'dash-total-cache', 'dash-autogen-sessions', 'dash-cosmos-items'];
        loadingElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        });
    }

    function showErrorState() {
        const errorElements = ['dash-active-agents', 'dash-total-cache', 'dash-autogen-sessions', 'dash-cosmos-items'];
        errorElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = '—';
        });
    }

    function updateStats(cacheStatus, inventoryStats, enhancedStats, health) {
        // Extract actual data from response wrappers
        const enhancedData = enhancedStats && enhancedStats.data && enhancedStats.data.length > 0 ? enhancedStats.data[0] : null;
        const cacheData = cacheStatus && cacheStatus.data && cacheStatus.data.length > 0 ? cacheStatus.data[0] : null;
        const inventoryData = inventoryStats && inventoryStats.data ? inventoryStats.data : inventoryStats;
        
        // Active Agents - count from enhancedData.agent_stats.agents
        let activeAgents = 0;
        if (enhancedData && enhancedData.agent_stats && enhancedData.agent_stats.agents) {
            activeAgents = Object.keys(enhancedData.agent_stats.agents).length;
        }
        document.getElementById('dash-active-agents').textContent = activeAgents;

        // Total cached items - sum from multiple sources
        let totalCache = 0;
        
        // Add cache hits from enhanced stats (agent cache hits)
        if (enhancedData && enhancedData.agent_stats && enhancedData.agent_stats.summary) {
            totalCache += enhancedData.agent_stats.summary.total_cache_hits || 0;
        }
        
        // Add inventory cache items from inventoryData
        if (inventoryData && inventoryData.length > 0) {
            totalCache += inventoryData.length;
        } else if (inventoryStats && inventoryStats.count) {
            totalCache += inventoryStats.count || 0;
        }
        
        // Add cosmos cache hits
        if (enhancedData && enhancedData.cosmos_stats && enhancedData.cosmos_stats.hits) {
            totalCache += enhancedData.cosmos_stats.hits || 0;
        }
        
        // Add inventory stats hits
        if (enhancedData && enhancedData.inventory_stats && enhancedData.inventory_stats.hits) {
            totalCache += enhancedData.inventory_stats.hits || 0;
        }
        
        document.getElementById('dash-total-cache').textContent = totalCache.toLocaleString();

        // AI Sessions - get from enhanced stats performance summary total requests
        let sessions = 0;
        if (enhancedData && enhancedData.performance_summary) {
            sessions = enhancedData.performance_summary.total_requests || 0;
        }
        document.getElementById('dash-autogen-sessions').textContent = sessions;

        // Database items - get from enhanced stats cosmos total requests
        let cosmosItems = 0;
        if (enhancedData && enhancedData.cosmos_stats) {
            cosmosItems = enhancedData.cosmos_stats.total_requests || 0;
        }
        document.getElementById('dash-cosmos-items').textContent = cosmosItems.toLocaleString();

        // Health status
        const healthElement = document.getElementById('dash-health');
        const isHealthy = health && (health.status === 'ok' || health.status === 'healthy');
        healthElement.textContent = isHealthy ? 'OK' : (health && health.status) || 'Unknown';
        healthElement.className = isHealthy ? 'badge bg-success' : 'badge bg-danger';

        // Cache performance - from enhanced stats performance summary
        let cachePerformance = 'Good';
        let avgResponseTime = 0;
        
        if (enhancedData && enhancedData.performance_summary) {
            avgResponseTime = enhancedData.performance_summary.avg_response_time_ms || 0;
            if (avgResponseTime < 100) cachePerformance = 'Excellent';
            else if (avgResponseTime < 500) cachePerformance = 'Good';
            else if (avgResponseTime < 1000) cachePerformance = 'Fair';
            else cachePerformance = 'Slow';
        }
        
        document.getElementById('dash-cache-performance').textContent = cachePerformance;
        document.getElementById('dash-avg-response').textContent = avgResponseTime > 0 ? `${avgResponseTime.toFixed(0)}ms` : '—';

        // Expiring items - check if inventory cache is expired
        let expiring = 0;
        if (inventoryStats && inventoryStats.cached === false) {
            expiring += 1;  // Inventory cache not available
        }
        // Could also check cacheData for expired items if available
        if (cacheData && cacheData.eol_cache && cacheData.eol_cache.expired_items > 0) {
            expiring += cacheData.eol_cache.expired_items;
        }
        document.getElementById('dash-expiring').textContent = expiring || '0';
    }

    function updateRecentActivity(enhancedStats, cacheStatus) {
        const tbody = document.getElementById('recent-activity');
        tbody.innerHTML = '';

        let recentActivity = [];

        // Extract actual data from response wrapper
        const enhancedData = enhancedStats && enhancedStats.data && enhancedStats.data.length > 0 ? enhancedStats.data[0] : null;

        // Collect activity from enhanced stats
        if (enhancedData && enhancedData.agent_stats && enhancedData.agent_stats.agents) {
            const agents = enhancedData.agent_stats.agents;
            
            for (const [agentName, agentData] of Object.entries(agents)) {
                if (agentData.recent_requests && agentData.recent_requests.length > 0) {
                    const recentRequests = agentData.recent_requests.slice(-2).map(req => ({
                        timestamp: req.timestamp,
                        agent: agentName,
                        action: req.cache_hit ? 'cache_hit' : 'cache_miss',
                        result: req.error ? `Error: ${req.error_message || 'Unknown error'}` : 
                               `${req.software || 'Request'} (${req.response_time_ms.toFixed(1)}ms)`
                    }));
                    recentActivity = [...recentActivity, ...recentRequests];
                }
            }
        }

        // Sort by timestamp and show latest 8
        recentActivity.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (recentActivity.length > 0) {
            recentActivity.slice(0, 8).forEach(activity => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-muted">${formatTime(activity.timestamp)}</td>
                    <td><span class="badge ${getAgentBadgeClass(activity.agent)}">${formatAgentName(activity.agent)}</span></td>
                    <td><span class="badge ${getActionBadgeClass(activity.action)}">${activity.action}</span></td>
                    <td class="text-truncate" style="max-width: 200px;" title="${activity.result}">${activity.result}</td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle me-2"></i>No recent activity found
                    </td>
                </tr>
            `;
        }
    }

    function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString('en-US', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function formatAgentName(agentName) {
        const nameMap = {
            'inventory_cache': 'Inventory',
            'software_inventory': 'Software',
            'os_inventory': 'OS',
            'endoflife': 'EndOfLife',
            'microsoft': 'Microsoft',
            'redhat': 'Red Hat',
            'ubuntu': 'Ubuntu',
            'oracle': 'Oracle',
            'vmware': 'VMware',
            'cosmos_db': 'Database'
        };
        return nameMap[agentName] || agentName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function getAgentBadgeClass(agent) {
        if (agent.includes('inventory')) return 'bg-primary';
        if (agent.includes('endoflife')) return 'bg-success';
        if (agent.includes('cosmos') || agent.includes('database')) return 'bg-warning';
        return 'bg-secondary';
    }

    function getActionBadgeClass(action) {
        if (action.includes('cache_hit')) return 'bg-success';
        if (action.includes('cache_miss')) return 'bg-warning';
        if (action.includes('error')) return 'bg-danger';
        return 'bg-info';
    }

    async function checkHealth() {
        const health = await fetchJson('/health');
        const status = health && (health.status === 'ok' || health.status === 'healthy') ? 'OK' : 
                      health ? health.status || 'Unknown' : 'Unreachable';
        
        const alertClass = status === 'OK' ? 'alert-success' : 'alert-danger';
        
        // Show a toast-like notification instead of alert
        showNotification(`System Health: ${status}`, alertClass);
    }

    function showNotification(message, className) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert ${className} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
        refreshDashboard();
        
        // Auto-refresh every 2 minutes (reduced from 30 seconds to minimize Cosmos DB load)
        setInterval(refreshDashboard, 120000);
    });
</script>
{% endblock %}