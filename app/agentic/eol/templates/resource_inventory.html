{% extends "base.html" %}

{% block title %}Resource Inventory Browser - Azure Agentic Platform{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/resource_inventory.css">
<!-- DataTables via CDN -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section mb-4">
    <div class="hero-content">
        <h1 class="hero-title">
            <span class="hero-icon me-3"><i class="bi bi-boxes"></i></span>Azure Resource Inventory
        </h1>
        <p class="hero-subtitle">
            Browse and analyze Azure resources discovered via Resource Graph. Dual-layer caching (L1 in-memory + L2 Cosmos DB) for optimal performance.
        </p>
    </div>
</div>

<div class="container-fluid">
    <!-- Status Bar -->
        <div class="row mb-3">
            <div class="col-12">
                <div id="status-bar" class="alert alert-info d-flex align-items-center py-2">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="status-message">Loading inventory status...</span>
                    <div class="ms-auto d-flex gap-2">
                        <span class="badge bg-secondary" id="badge-total">0 resources</span>
                        <span class="badge bg-success" id="badge-cache-hit">0% hit rate</span>
                        <span class="badge bg-primary" id="badge-l2">L2: --</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card filter-card">
                    <div class="card-body py-2">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label form-label-sm mb-0">Subscription</label>
                                <select id="filter-subscription" class="form-select form-select-sm">
                                    <option value="">All Subscriptions</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label form-label-sm mb-0">Resource Type</label>
                                <select id="filter-resource-type" class="form-select form-select-sm">
                                    <option value="">-- All Types (load first) --</option>
                                    <option value="Microsoft.Compute/virtualMachines">Virtual Machines</option>
                                    <option value="Microsoft.Network/virtualNetworks">Virtual Networks</option>
                                    <option value="Microsoft.Storage/storageAccounts">Storage Accounts</option>
                                    <option value="Microsoft.Web/sites">App Services</option>
                                    <option value="Microsoft.ContainerService/managedClusters">AKS Clusters</option>
                                    <option value="Microsoft.App/containerApps" selected>Container Apps</option>
                                    <option value="Microsoft.Sql/servers">SQL Servers</option>
                                    <option value="Microsoft.KeyVault/vaults">Key Vaults</option>
                                    <option value="Microsoft.Network/networkSecurityGroups">NSGs</option>
                                    <option value="Microsoft.Network/loadBalancers">Load Balancers</option>
                                    <option value="Microsoft.DocumentDB/databaseAccounts">Cosmos DB</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label form-label-sm mb-0">Location</label>
                                <input type="text" id="filter-location" class="form-control form-control-sm" placeholder="e.g. eastus">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label form-label-sm mb-0">Resource Group</label>
                                <input type="text" id="filter-resource-group" class="form-control form-control-sm" placeholder="Filter by RG">
                            </div>
                            <div class="col-md-2 d-flex gap-1">
                                <button id="btn-search" class="btn btn-primary btn-sm flex-grow-1" onclick="searchResources()">
                                    <i class="bi bi-search"></i> Search
                                </button>
                                <button id="btn-refresh" class="btn btn-outline-warning btn-sm" onclick="triggerRefresh()" title="Refresh from Azure">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button id="btn-export" class="btn btn-outline-secondary btn-sm" onclick="exportData()" title="Export">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Search bar -->
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-funnel"></i></span>
                                    <input type="text" id="search-bar" class="form-control form-control-sm"
                                           placeholder="Quick search across all columns..." oninput="quickSearch(this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content: Grid + Details Panel -->
        <div class="row">
            <!-- Resource Grid -->
            <div id="grid-container" class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="resource-table" class="table table-striped table-hover table-sm mb-0" style="width:100%">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Resource Group</th>
                                        <th>Location</th>
                                        <th>Tags</th>
                                        <th>Discovered</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="resource-tbody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide-out Details Panel -->
            <div id="details-panel" class="details-panel">
                <div class="details-header">
                    <h6 class="mb-0" id="details-title">Resource Details</h6>
                    <button class="btn btn-sm btn-outline-light" onclick="closeDetailsPanel()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="details-body" id="details-body">
                    <p class="text-muted">Select a resource to view details.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Section: Summary Cards -->
        <div class="row mt-3" id="dashboard-section">
            <div class="col-md-3">
                <div class="card text-center stat-card">
                    <div class="card-body py-2">
                        <div class="stat-value" id="stat-total">--</div>
                        <div class="stat-label">Total Resources</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center stat-card">
                    <div class="card-body py-2">
                        <div class="stat-value" id="stat-types">--</div>
                        <div class="stat-label">Resource Types</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center stat-card">
                    <div class="card-body py-2">
                        <div class="stat-value" id="stat-hit-rate">--</div>
                        <div class="stat-label">Cache Hit Rate</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center stat-card">
                    <div class="card-body py-2">
                        <div class="stat-value" id="stat-l2">--</div>
                        <div class="stat-label">L2 Status</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Dashboard -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex align-items-center py-2">
                        <i class="bi bi-speedometer2 me-2"></i>
                        <strong>Monitoring Dashboard</strong>
                        <div class="ms-auto d-flex align-items-center gap-2">
                            <small class="text-light">Updated: <span id="dash-last-updated">--</span></small>
                            <button class="btn btn-sm btn-outline-light py-0" onclick="forceRefreshDashboard()" title="Refresh now">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light py-0" onclick="toggleDashboardPolling()">
                                <span id="dash-poll-btn-text">Stop Auto-Refresh</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Row 1: Cache metrics + Health -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-2">
                                <div class="dash-metric-card">
                                    <div class="dash-metric-value" id="dash-hit-rate">--</div>
                                    <div class="dash-metric-label">Overall Hit Rate</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="dash-metric-card">
                                    <div class="dash-metric-value" id="dash-l1-entries">--</div>
                                    <div class="dash-metric-label">L1 Entries</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="dash-metric-card">
                                    <div class="dash-metric-value" id="dash-l1-valid">--</div>
                                    <div class="dash-metric-label">L1 Valid</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="dash-metric-card">
                                    <div class="dash-metric-value" id="dash-total-reqs">--</div>
                                    <div class="dash-metric-label">Total Requests</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="dash-metric-card">
                                    <div class="dash-metric-value" id="dash-writes">--</div>
                                    <div class="dash-metric-label">Cache Writes</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="dash-metric-card">
                                    <div class="dash-metric-value" id="dash-miss-rate">--</div>
                                    <div class="dash-metric-label">Miss Rate</div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Charts -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <div class="chart-container" style="height:260px">
                                    <canvas id="cache-hit-chart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="chart-container" style="height:260px">
                                    <canvas id="resource-dist-chart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="chart-container" style="height:260px">
                                    <canvas id="location-dist-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Health & Config Status -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header py-1"><small class="fw-bold text-muted">System Health</small></div>
                                    <div class="card-body py-2">
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td class="text-muted">Status</td>
                                                <td><span id="dash-health-status">--</span></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Discovery Engine</td>
                                                <td><span class="indicator-dot" id="dash-engine-dot"></span> <span id="dash-engine-status">--</span></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">L2 (Cosmos DB)</td>
                                                <td><span class="indicator-dot" id="dash-l2-dot"></span> <span id="dash-l2-status">--</span></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Prometheus</td>
                                                <td><span class="indicator-dot" id="dash-prometheus-dot"></span> <span id="dash-prometheus-status">Standby</span></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Azure Monitor</td>
                                                <td><span class="indicator-dot" id="dash-azure-monitor-dot"></span> <span id="dash-azure-monitor-status">Standby</span></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header py-1"><small class="fw-bold text-muted">Discovery Configuration</small></div>
                                    <div class="card-body py-2">
                                        <table class="table table-sm mb-0">
                                            <tr><td class="text-muted">Full Scan</td><td id="dash-scan-schedule">--</td></tr>
                                            <tr><td class="text-muted">Incremental</td><td id="dash-incr-interval">--</td></tr>
                                            <tr><td class="text-muted">L1 TTL</td><td id="dash-l1-ttl">--</td></tr>
                                            <tr><td class="text-muted">L2 TTL</td><td id="dash-l2-ttl">--</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header py-1"><small class="fw-bold text-muted">Performance &amp; Discovery</small></div>
                                    <div class="card-body py-2">
                                        <table class="table table-sm mb-0">
                                            <tr><td class="text-muted">API Calls Saved</td><td id="dash-api-reduction">--</td></tr>
                                            <tr><td class="text-muted">Total Queries</td><td id="dash-param-rate">--</td></tr>
                                            <tr><td class="text-muted">Discoveries</td><td id="dash-discovery-count">--</td></tr>
                                            <tr><td class="text-muted">Success Rate</td><td id="dash-discovery-success-rate">--</td></tr>
                                            <tr><td class="text-muted">Avg Duration</td><td id="dash-discovery-avg-duration">--</td></tr>
                                            <tr><td class="text-muted">Last Discovery</td><td id="dash-last-discovery">--</td></tr>
                                            <tr><td class="text-muted">Last Status</td><td id="dash-last-discovery-status">--</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Modal -->
    <div class="modal fade" id="refreshModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title">Refresh Inventory</h6>
                    <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label form-label-sm">Mode</label>
                        <select id="refresh-mode" class="form-select form-select-sm">
                            <option value="full">Full Discovery</option>
                            <option value="incremental">Incremental</option>
                        </select>
                    </div>
                    <div id="refresh-progress" class="d-none">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width:100%"></div>
                        </div>
                        <small class="text-muted mt-1 d-block" id="refresh-status">Discovering resources...</small>
                    </div>
                </div>
                <div class="modal-footer py-1">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-sm btn-primary" id="btn-start-refresh" onclick="startRefresh()">
                        <i class="bi bi-arrow-clockwise"></i> Start
                    </button>
                </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Resource Inventory Scripts -->
<script src="/static/js/resource_inventory.js"></script>
<script src="/static/js/resource_inventory_dashboard.js"></script>
{% endblock %}    <script src="/static/js/resource_inventory_dashboard.js"></script>
</body>
</html>
