{% extends "base.html" %}

{% block title %}Azure MCP Server - Azure Agentic Platform{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-section::before"></div>
    <div class="hero-content">
        <div class="row align-items-center">
            <div class="col-lg-12">
                <h1 class="hero-title">
                    <i class="fab fa-microsoft me-3"></i>Azure MCP Assistant
                </h1>
                <p class="hero-subtitle">
                    Explore and manage Azure resources through the Azure Agentic Platform using Model Context Protocol tooling.
                </p>
                <div class="d-flex gap-3 justify-content-start flex-wrap">
                    <button class="btn action-btn action-btn-primary" onclick="refreshStatus()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Status
                    </button>
                    <button class="btn action-btn action-btn-secondary" onclick="listTools()">
                        <i class="fas fa-tools me-2"></i>List Tools
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Status & Tools Card (Combined) -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Status & Tools</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleStatusTools()" id="toggle-status-btn">
                        <i class="fas fa-chevron-down me-1"></i>Collapse
                    </button>
                </div>
                <div class="card-body" id="status-tools-section">
                    <div class="row">
                        <!-- Connection Status -->
                        <div class="col-md-6 mb-3">
                            <h6 class="mb-3"><i class="fas fa-signal me-2"></i>Connection Status</h6>
                            <div id="status-container">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Checking status...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Available Tools -->
                        <div class="col-md-6 mb-3">
                            <h6 class="mb-3"><i class="fas fa-tools me-2"></i>Available Tools</h6>
                            <div id="tools-container" style="max-height: 400px; overflow-y: auto;">
                                <p class="text-muted">Click "List Tools" to view available Azure MCP tools</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MCP Chat Interface -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Conversation</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">
                        <i class="fas fa-trash me-1"></i>Clear Chat
                    </button>
                </div>
                <div class="card-body" style="background-color: #f8f9fa;">
                    <!-- Chat History -->
                    <div id="chat-history" class="chat-container mb-3">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <p>Ask me anything about your Azure resources!</p>
                        </div>
                    </div>
                    
                    <!-- Quick Examples -->
                    <div class="mb-3">
                        <label class="form-label mb-2"><i class="fas fa-lightbulb me-1"></i>Quick Examples:</label>
                        <div class="row g-2">
                            <div class="col-md-5">
                                <select class="form-select" id="tool-selector" onchange="updateExamples()" disabled>
                                    <option value="">Loading tools...</option>
                                </select>
                            </div>
                            <div class="col-md-7">
                                <select class="form-select" id="example-selector" disabled>
                                    <option value="">Select a tool first...</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2 small" id="tool-doc-link"></div>
                        <div class="mt-2" id="tool-parameter-hints"></div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="input-group">
                        <input type="text" class="form-control" id="chat-input" 
                               placeholder="Type your question about Azure resources..."
                               onkeypress="if(event.key === 'Enter') sendMessage()">
                        <button class="btn btn-primary" onclick="sendMessage()" id="send-btn">
                            <i class="fas fa-paper-plane me-1"></i>Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Groups Section -->
    <!-- <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-folder me-2"></i>Azure Resource Groups</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadResourceGroups()">
                        <i class="fas fa-sync-alt me-1"></i>Load Resource Groups
                    </button>
                </div>
                <div class="card-body" id="resource-groups-container">
                    <p class="text-muted">Click "Load Resource Groups" to view your Azure resource groups</p>
                </div>
            </div>
        </div>
    </div> -->

    <!-- Agent Communication Section -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-project-diagram me-2"></i>Agent Communication & Reasoning
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleAgentComms()" id="toggle-comms-btn">
                            <i class="fas fa-eye me-1"></i>Show
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearAgentComms()">
                            <i class="fas fa-trash me-1"></i>Clear
                        </button>
                    </div>
                </div>
                <div class="card-body" id="agent-comms-section" style="display: none;">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Real-time Agent Activity:</strong> This section shows the agentic orchestrator's reasoning process, 
                        tool calls, and observations as they happen. Watch how the agent autonomously breaks down your questions 
                        and executes multi-step workflows.
                    </div>
                    
                    <!-- Reasoning Summary Stats -->
                    <div class="row mb-3" id="reasoning-stats" style="display: none;">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-iterations">0</div>
                                <div class="stat-label">Reasoning Iterations</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-tools">0</div>
                                <div class="stat-label">Tool Calls</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-strategy">-</div>
                                <div class="stat-label">Strategy</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-duration">0s</div>
                                <div class="stat-label">Duration</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Agent Communication Stream -->
                    <div id="agent-comms-stream" class="agent-comms-container" style="height: 500px; overflow-y: auto; background-color: #1e1e1e; border-radius: 8px; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-brain fa-3x mb-3" style="color: #6c757d;"></i>
                            <p style="color: #6c757d;">Agent activity will appear here when processing requests...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Azure Monitor Query Section -->
    <!-- <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-code me-2"></i>Azure Monitor Query</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="resource-query" class="form-label">KQL Query</label>
                        <textarea class="form-control font-monospace" id="resource-query" rows="4" placeholder="Heartbeat | take 10"></textarea>
                        <small class="form-text text-muted">
                            Enter a KQL query to search Azure Monitor / Log Analytics workspace. 
                            <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-query-overview" target="_blank">Learn more about Azure Monitor KQL</a>
                        </small>
                    </div>
                    <button class="btn btn-primary" onclick="executeQuery()">
                        <i class="fas fa-play me-1"></i>Execute Query
                    </button>
                    <button class="btn btn-outline-secondary" onclick="loadExampleQuery()">
                        <i class="fas fa-lightbulb me-1"></i>Load Example
                    </button>
                </div>
                <div class="card-footer" id="query-results-container" style="display: none;">
                    <h6>Query Results:</h6>
                    <pre id="query-results" class="mb-0"></pre>
                </div>
            </div>
        </div>
    </div> -->
</div>

<script>
    // Check status on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await loadToolMetadata();
        await listTools();
        refreshStatus();
    });

    function toggleStatusTools() {
        const section = document.getElementById('status-tools-section');
        const btn = document.getElementById('toggle-status-btn');
        
        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Collapse';
        } else {
            section.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Expand';
        }
    }

    async function refreshStatus() {
        const container = document.getElementById('status-container');
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Checking status...</p>
            </div>
        `;

        try {
            const response = await fetch('/api/azure-mcp/status');
            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                const status = data.data[0];
                const isConnected = status.connection_status === 'connected';

                const toolCounts = status.tool_counts || {};
                const activeClients = Array.isArray(status.active_clients) ? status.active_clients : [];
                const aggregatedToolCount = Object.values(toolCounts).reduce((total, value) => total + (typeof value === 'number' ? value : 0), 0) || Number(status.available_tools_count) || 0;
                const documentedToolCount = metadataTools.length || 0;
                const totalToolCount = aggregatedToolCount + microsoftLearnTools.length;

                const friendlyNameFor = (key) => {
                    if (!key) {
                        return 'Unknown';
                    }
                    return mcpSourceDisplayNames[key] || key.replace(/_/g, ' ');
                };

                const countsForDisplay = (activeClients.length
                    ? activeClients.map(label => [label, typeof toolCounts[label] === 'number' ? toolCounts[label] : 0])
                    : Object.entries(toolCounts)
                ).map(([label, count]) => ({
                    key: label,
                    label: friendlyNameFor(label),
                    count: typeof count === 'number' ? count : 0,
                })).sort((a, b) => a.label.localeCompare(b.label));

                const activeClientEntries = [...new Set(activeClients)]
                    .map(client => ({ key: client, label: friendlyNameFor(client) }))
                    .sort((a, b) => a.label.localeCompare(b.label));

                const serverList = countsForDisplay.length
                    ? countsForDisplay.map(({ label, count }) => `
                        <li class="d-flex justify-content-between align-items-center mb-1">
                            <span>${label}</span>
                            <span class="badge bg-secondary">${count} ${count === 1 ? 'tool' : 'tools'}</span>
                        </li>
                    `).join('')
                    : '<li class="text-muted small mb-0">No MCP servers registered</li>';

                const clientList = activeClientEntries.length
                    ? activeClientEntries.map(({ label }) => `
                        <li class="d-flex justify-content-between align-items-center mb-1">
                            <span>${label}</span>
                            <span class="badge bg-success">Active</span>
                        </li>
                    `).join('')
                    : '<li class="text-muted small mb-0">No active clients</li>';

                const toolMetrics = [
                    { label: 'Agent-ready tools', value: aggregatedToolCount },
                    { label: 'Microsoft Learn tools', value: microsoftLearnTools.length },
                    {
                        label: 'Documented tool metadata',
                        value: documentedToolCount,
                        href: 'https://learn.microsoft.com/en-us/azure/developer/azure-mcp-server/tools/'
                    },
                    { label: 'Total tools available', value: totalToolCount },
                ];

                const toolList = toolMetrics.map(({ label, value, href }) => `
                    <li class="d-flex justify-content-between align-items-center mb-1">
                        <span>${href ? `<a href="${href}" target="_blank" rel="noopener noreferrer">${label}</a>` : label}</span>
                        <span class="badge bg-primary">${value}</span>
                    </li>
                `).join('');

                const lazyPendingTools = lazyLoadedToolMetadata.filter(tool => {
                    if (!tool || !tool.namespace) {
                        return false;
                    }
                    return !runtimeAzureTools.some(runtimeTool => runtimeTool && runtimeTool.name === tool.namespace);
                });
                const lazyPendingCount = lazyPendingTools.length;

                const lazyNote = lazyPendingCount
                    ? `<div class="text-muted small mt-2"><i class="fas fa-clock me-1"></i>${lazyPendingCount} tools load on first use.</div>`
                    : '';

                container.innerHTML = `
                    <div class="card shadow-sm mb-0">
                        <div class="card-header d-flex justify-content-between align-items-center ${isConnected ? 'bg-success text-white' : 'bg-warning'}">
                            <span><i class="fas ${isConnected ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>${isConnected ? 'Connected to Azure MCP Orchestrator' : 'Disconnected from Azure MCP Orchestrator'}</span>
                            <span class="badge ${isConnected ? 'bg-light text-dark' : 'bg-dark text-white'}"><i class="fas fa-terminal me-1"></i>Stdio (npx)</span>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="border rounded p-3 h-100">
                                        <h6 class="text-uppercase text-muted small mb-2"><i class="fas fa-server me-2"></i>MCP Servers</h6>
                                        <ul class="list-unstyled mb-0">
                                            ${serverList}
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-3 h-100">
                                        <h6 class="text-uppercase text-muted small mb-2"><i class="fas fa-plug me-2"></i>Agent Clients</h6>
                                        <ul class="list-unstyled mb-0">
                                            ${clientList}
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-3 h-100">
                                        <h6 class="text-uppercase text-muted small mb-2"><i class="fas fa-toolbox me-2"></i>Tool Catalog</h6>
                                        <ul class="list-unstyled mb-0">
                                            ${toolList}
                                        </ul>
                                        ${lazyNote}
                                    </div>
                                </div>
                            </div>
                            <div class="pt-3 mt-3 border-top">
                                <small class="text-muted">
                                    ${isConnected ?
                                        '<i class="fas fa-check-circle text-success me-1"></i>MCP orchestrator running via composite stdio clients.' :
                                        '<i class="fas fa-exclamation-triangle text-warning me-1"></i>MCP orchestrator is not responding. Check server logs or restart the application.'}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                throw new Error('Invalid response format');
            }
        } catch (error) {
            console.error('Error loading status:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle me-2"></i>Error</h6>
                    <p class="mb-0">Failed to load Azure MCP status: ${error.message}</p>
                </div>
            `;
        }
    }

    async function listTools(showLoader = true) {
        const container = document.getElementById('tools-container');
        if (showLoader) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading tools...</p>
                </div>
            `;
        }

        try {
            const response = await fetch('/api/azure-mcp/tools');
            const data = await response.json();

            let html = '';
            runtimeAzureTools = Array.isArray(data.data) ? data.data : [];

            const toolsBySource = {};
            runtimeAzureTools.forEach(tool => {
                const source = tool.source || 'azure';
                if (!toolsBySource[source]) {
                    toolsBySource[source] = [];
                }
                toolsBySource[source].push(tool);
            });

            const preferredOrder = ['azure', 'inventory', 'os_eol', 'azure_cli'];
            const orderedSources = [
                ...preferredOrder.filter(source => Array.isArray(toolsBySource[source]) && toolsBySource[source].length > 0),
                ...Object.keys(toolsBySource).filter(source => !preferredOrder.includes(source) && toolsBySource[source].length > 0)
            ];

            if (data.success && orderedSources.length > 0) {
                orderedSources.forEach(source => {
                    const tools = toolsBySource[source] || [];
                    if (!tools.length) {
                        return;
                    }
                    const friendlySource = mcpSourceDisplayNames[source] || source;
                    html += `<h6 class="fw-semibold ${source === 'azure' ? 'text-primary' : 'text-secondary'}">${friendlySource}</h6>`;
                    html += '<div class="list-group mb-3">';
                    tools.forEach(tool => {
                        const originalName = tool.original_name && tool.original_name !== tool.name ? tool.original_name : null;
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1"><code>${tool.name}</code></h6>
                                    <div class="d-flex gap-2">
                                        ${originalName ? `<span class="badge bg-light text-dark">${escapeHtml(originalName)}</span>` : ''}
                                        <span class="badge bg-secondary text-uppercase" style="font-size: 0.7rem;">${friendlySource}</span>
                                    </div>
                                </div>
                                <p class="mb-1 text-muted small">${escapeHtml(tool.description || 'No description available')}</p>
                            </div>
                        `;
                    });
                    html += '</div>';
                });
            } else {
                html += '<div class="alert alert-warning">Azure MCP tools are currently unavailable.</div>';
            }

            const lazyPendingTools = lazyLoadedToolMetadata.filter(tool => {
                if (!tool || !tool.namespace) {
                    return false;
                }
                return !runtimeAzureTools.some(runtimeTool => runtimeTool && runtimeTool.name === tool.namespace);
            });

            if (lazyPendingTools.length > 0) {
                html += '<h6 class="text-warning fw-semibold">Loads On First Use</h6>';
                html += '<div class="list-group mb-3">';
                lazyPendingTools.forEach(tool => {
                    html += `
                        <div class="list-group-item list-group-item-warning">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><code>${tool.namespace}</code></h6>
                            </div>
                            <p class="mb-1 text-muted small">${escapeHtml(tool.description || 'This tool registers the first time you run one of its quick examples.')}</p>
                            <p class="mb-0 small text-muted">Tip: Use a matching Quick Example to initialize this tool and add it to the active list.</p>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (microsoftLearnTools.length > 0) {
                html += '<h6 class="text-success fw-semibold">Microsoft Learn MCP Server Tools</h6>';
                html += '<div class="list-group">';
                microsoftLearnTools.forEach(tool => {
                    html += `
                        <div class="list-group-item list-group-item-light">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><code>${tool.name}</code></h6>
                            </div>
                            <p class="mb-1 text-muted small">${tool.description}</p>
                        </div>
                    `;
                });
                html += '</div>';
            }

            container.innerHTML = html || '<div class="alert alert-warning">No tools available</div>';
        } catch (error) {
            console.error('Error loading tools:', error);
            runtimeAzureTools = [];
            container.innerHTML = `
                <div class="alert alert-danger">
                    <p class="mb-0">Failed to load tools: ${error.message}</p>
                </div>
            `;
        }
    }

    async function loadResourceGroups() {
        const container = document.getElementById('resource-groups-container');
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading resource groups...</p>
            </div>
        `;

        try {
            const response = await fetch('/api/azure-mcp/resource-groups');
            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                const result = data.data[0];
                container.innerHTML = `
                    <pre class="mb-0">${JSON.stringify(result.content, null, 2)}</pre>
                `;
            } else {
                container.innerHTML = '<div class="alert alert-warning">No resource groups found</div>';
            }
        } catch (error) {
            console.error('Error loading resource groups:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <p class="mb-0">Failed to load resource groups: ${error.message}</p>
                </div>
            `;
        }
    }

    function loadExampleQuery() {
        document.getElementById('resource-query').value = 'Heartbeat\n| where TimeGenerated > ago(1h)\n| summarize count() by Computer\n| top 10 by count_';
    }

    async function executeQuery() {
        const query = document.getElementById('resource-query').value.trim();
        if (!query) {
            alert('Please enter a query');
            return;
        }

        const resultsContainer = document.getElementById('query-results-container');
        const resultsElement = document.getElementById('query-results');
        
        resultsContainer.style.display = 'block';
        resultsElement.textContent = 'Executing query...';

        try {
            const response = await fetch('/api/azure-mcp/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            });

            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                const result = data.data[0];
                resultsElement.textContent = JSON.stringify(result.content, null, 2);
            } else {
                resultsElement.textContent = 'No results returned';
            }
        } catch (error) {
            console.error('Error executing query:', error);
            resultsElement.textContent = `Error: ${error.message}`;
        }
    }

    // ========================================================================
    // MCP CHAT FUNCTIONS
    // ========================================================================

    // Microsoft Learn MCP server tool metadata for status/list rendering
    const microsoftLearnTools = [
        { name: 'microsoft_learn.searchLearningPaths', description: 'Search Microsoft Learn for learning paths aligned to certification exams or keywords.' },
        { name: 'microsoft_learn.listModulesByTopic', description: 'List Microsoft Learn modules for a topic with duration and unit counts.' },
        { name: 'microsoft_learn.getModuleOutline', description: 'Retrieve the unit-by-unit outline for a Microsoft Learn module.' },
        { name: 'microsoft_learn.recommendContentForRole', description: 'Recommend Microsoft Learn content for a specific Azure job role and prerequisite knowledge.' }
    ];

    const mcpSourceDisplayNames = {
        azure: 'Azure MCP Server',
        inventory: 'Log Analytics Inventory',
        os_eol: 'Operating System EOL',
        azure_cli: 'Azure CLI Executor',
    };

    let runtimeAzureTools = [];

    const lazyLoadedToolMetadata = [
        {
            slug: 'azure-cli-executor-execute-command',
            display_name: 'Azure CLI Executor · Execute command',
            category: 'Agentic Utilities',
            namespace: 'azure_cli_execute_command',
            description: 'Execute Azure CLI commands using the dedicated MCP server with service principal authentication.',
            lazy_loaded: true,
            notes: [
                'Loads on first use—use a CLI example below to start the Azure CLI executor MCP server and add it to the tool list.'
            ],
            operations: [
                {
                    title: 'Run Azure CLI command',
                    description: 'Execute an Azure CLI command (must begin with "az") and return stdout, stderr, exit code, and duration.',
                    parameters: [
                        {
                            name: 'command',
                            required: true,
                            description: 'Complete Azure CLI command string starting with "az".'
                        },
                        {
                            name: 'working_directory',
                            required: false,
                            description: 'Optional working directory to run the command in.'
                        },
                        {
                            name: 'timeout_seconds',
                            required: false,
                            description: 'Maximum execution time in seconds (defaults to 300).'
                        }
                    ],
                    examples: [
                        {
                            label: 'Create a storage account',
                            prompt: 'execute cli command "az storage account create --name <storage-account-name> --resource-group <resource-group> --location <azure-region> --sku Standard_LRS"'
                        },
                        {
                            label: 'Show a resource group',
                            prompt: 'execute cli command "az group show --name <resource-group> --output json"'
                        },
                        {
                            label: 'List container apps',
                            prompt: 'execute cli command "az containerapp list --resource-group <resource-group> --query \"[].{name:name,location:location}\" --output table"'
                        }
                    ]
                }
            ]
        }
    ];

    const microsoftLearnToolMetadata = [
        {
            slug: 'microsoft-learn-search-learning-paths',
            display_name: 'Microsoft Learn · Search learning paths',
            category: 'Microsoft Learn',
            namespace: 'microsoft_learn.searchLearningPaths',
            description: 'Search Microsoft Learn for learning paths aligned to certification exams or keywords.',
            doc_url: 'https://learn.microsoft.com/en-us/training/browse/',
            operations: [
                {
                    title: 'Search learning paths',
                    description: 'Find Microsoft Learn learning paths by certification exam, Azure role, or topic keyword.',
                    parameters: [
                        {
                            name: 'Query',
                            required: true,
                            description: 'Keyword, certification exam number, or topic to match across Microsoft Learn learning paths.'
                        },
                        {
                            name: 'Role',
                            required: false,
                            description: 'Optional Azure job role focus, such as administrator, developer, or security-engineer.'
                        },
                        {
                            name: 'Language',
                            required: false,
                            description: 'Preferred content language code like en or fr for localized learning paths.'
                        }
                    ],
                    examples: [
                        {
                            label: 'Exam aligned learning paths',
                            prompt: 'Find Microsoft Learn learning paths to prepare for the <exam-number> exam using <query> for Query and <language> for Language.',
                            original_prompt: 'Find Microsoft Learn learning paths to prepare for the AZ-104 exam',
                            parameter_placeholders: ['<query>', '<language>']
                        },
                        {
                            label: 'Role focused learning paths',
                            prompt: 'Show learning paths for <azure-role> responsibilities using <query> for Query and <role> for Role.',
                            original_prompt: 'Show learning paths for Azure administrator responsibilities',
                            parameter_placeholders: ['<query>', '<role>']
                        },
                        {
                            label: 'Topic keyword search',
                            prompt: 'Search for learning paths that cover <topic> skills using <query> for Query.',
                            original_prompt: 'Search for learning paths that cover Azure monitoring skills',
                            parameter_placeholders: ['<query>']
                        }
                    ]
                }
            ]
        },
        {
            slug: 'microsoft-learn-list-modules-by-topic',
            display_name: 'Microsoft Learn · List modules by topic',
            category: 'Microsoft Learn',
            namespace: 'microsoft_learn.listModulesByTopic',
            description: 'List Microsoft Learn modules for a topic with duration and unit counts.',
            doc_url: 'https://learn.microsoft.com/en-us/training/browse/',
            operations: [
                {
                    title: 'List modules by topic',
                    description: 'Discover Microsoft Learn modules grouped by topic, difficulty, and estimated duration.',
                    parameters: [
                        {
                            name: 'Topic',
                            required: true,
                            description: 'Microsoft Learn topic or product focus, such as Azure networking or AI services.'
                        },
                        {
                            name: 'Level',
                            required: false,
                            description: 'Optional difficulty filter like beginner, intermediate, or advanced.'
                        },
                        {
                            name: 'Language',
                            required: false,
                            description: 'Preferred content language code like en or es for localized modules.'
                        }
                    ],
                    examples: [
                        {
                            label: 'Beginner modules for a topic',
                            prompt: 'List beginner modules about <topic> using <topic> for Topic and <level> for Level.',
                            original_prompt: 'List beginner modules about Azure networking',
                            parameter_placeholders: ['<topic>', '<level>']
                        },
                        {
                            label: 'Localized topic modules',
                            prompt: 'Show modules covering <topic> concepts using <topic> for Topic and <language> for Language.',
                            original_prompt: 'Show modules covering Azure OpenAI concepts in Japanese',
                            parameter_placeholders: ['<topic>', '<language>']
                        },
                        {
                            label: 'Topic catalog overview',
                            prompt: 'List Microsoft Learn modules for <topic> using <topic> for Topic.',
                            original_prompt: 'List Microsoft Learn modules for Azure governance',
                            parameter_placeholders: ['<topic>']
                        }
                    ]
                }
            ]
        },
        {
            slug: 'microsoft-learn-get-module-outline',
            display_name: 'Microsoft Learn · Get module outline',
            category: 'Microsoft Learn',
            namespace: 'microsoft_learn.getModuleOutline',
            description: 'Retrieve the unit-by-unit outline for a Microsoft Learn module.',
            doc_url: 'https://learn.microsoft.com/en-us/training/browse/',
            operations: [
                {
                    title: 'Get module outline',
                    description: 'Retrieve the unit names, durations, and prerequisites for a Microsoft Learn module.',
                    parameters: [
                        {
                            name: 'Module ID',
                            required: true,
                            description: 'The Microsoft Learn module ID or URL slug, such as learn.az-104.configure-virtual-networking.'
                        },
                        {
                            name: 'Language',
                            required: false,
                            description: 'Preferred content language code like en or de for localized module outlines.'
                        }
                    ],
                    examples: [
                        {
                            label: 'Module outline by slug',
                            prompt: 'Show the outline for the <module-slug> module using <module-slug> for Module ID.',
                            original_prompt: 'Show the outline for the learn.az-104.configure-virtual-networking module',
                            parameter_placeholders: ['<module-slug>']
                        },
                        {
                            label: 'Localized module outline',
                            prompt: 'Get the <module-slug> module outline in <language> using <module-slug> for Module ID and <language> for Language.',
                            original_prompt: 'Get the learn.azure.well-architected module outline in Spanish',
                            parameter_placeholders: ['<module-slug>', '<language>']
                        }
                    ]
                }
            ]
        },
        {
            slug: 'microsoft-learn-recommend-content-for-role',
            display_name: 'Microsoft Learn · Recommend content for role',
            category: 'Microsoft Learn',
            namespace: 'microsoft_learn.recommendContentForRole',
            description: 'Recommend Microsoft Learn content for a specific Azure job role and prerequisite knowledge.',
            doc_url: 'https://learn.microsoft.com/en-us/training/browse/',
            operations: [
                {
                    title: 'Recommend content for role',
                    description: 'Get personalized module and learning path recommendations for an Azure job role.',
                    parameters: [
                        {
                            name: 'Role',
                            required: true,
                            description: 'Target Azure or cloud job role such as administrator, solutions-architect, or developer.'
                        },
                        {
                            name: 'Experience level',
                            required: false,
                            description: 'Optional experience band like beginner, intermediate, or advanced to tune recommendations.'
                        },
                        {
                            name: 'Focus area',
                            required: false,
                            description: 'Optional specialization focus like security, networking, or data platform.'
                        }
                    ],
                    examples: [
                        {
                            label: 'Role based recommendations',
                            prompt: 'Recommend Microsoft Learn content for <role> responsibilities using <role> for Role.',
                            original_prompt: 'Recommend Microsoft Learn content for Azure security engineer responsibilities',
                            parameter_placeholders: ['<role>']
                        },
                        {
                            label: 'Experience tuned recommendations',
                            prompt: 'Suggest intermediate learning for <role> focusing on <focus-area> using <role> for Role, <experience-level> for Experience level, and <focus-area> for Focus area.',
                            original_prompt: 'Suggest intermediate learning for Azure developer focusing on AI integration',
                            parameter_placeholders: ['<role>', '<experience-level>', '<focus-area>']
                        }
                    ]
                }
            ]
        }
    ];

    // Tool metadata catalog populated from documentation crawler
    let metadataTools = [];
    let metadataBySlug = {};

    async function loadToolMetadata() {
        const selector = document.getElementById('tool-selector');
        const exampleSelector = document.getElementById('example-selector');
        try {
            const response = await fetch('/static/data/azure_mcp_tool_metadata.json', { cache: 'no-store' });
            const payload = await response.json();
            metadataTools = Array.isArray(payload.tools) ? payload.tools : [];
            metadataBySlug = {};
            metadataTools.forEach(tool => {
                if (tool && tool.slug) {
                    metadataBySlug[tool.slug] = tool;
                }
            });
            lazyLoadedToolMetadata.forEach(tool => {
                if (!tool || !tool.slug) {
                    return;
                }
                if (!metadataBySlug[tool.slug]) {
                    metadataTools.push(tool);
                    metadataBySlug[tool.slug] = tool;
                }
            });
            microsoftLearnToolMetadata.forEach(tool => {
                if (tool && tool.slug && !metadataBySlug[tool.slug]) {
                    metadataTools.push(tool);
                    metadataBySlug[tool.slug] = tool;
                }
            });
            populateToolSelector();
            if (selector) {
                selector.disabled = metadataTools.length === 0;
                if (!metadataTools.length) {
                    selector.innerHTML = '<option value="">No tools available</option>';
                }
            }
            if (exampleSelector) {
                exampleSelector.disabled = true;
                exampleSelector.innerHTML = '<option value="">Select a tool first...</option>';
            }
        } catch (error) {
            console.error('Failed to load tool metadata:', error);
            if (selector) {
                selector.disabled = true;
                selector.innerHTML = '<option value="">Failed to load tools</option>';
            }
        }
    }

    function populateToolSelector() {
        const selector = document.getElementById('tool-selector');
        if (!selector) {
            return;
        }
        selector.innerHTML = '<option value="">Select a tool...</option>';

        if (!metadataTools.length) {
            return;
        }

        const grouped = new Map();
        metadataTools.forEach(tool => {
            const category = (tool.category || 'Other').trim() || 'Other';
            if (!grouped.has(category)) {
                grouped.set(category, []);
            }
            grouped.get(category).push(tool);
        });

        const sortedCategories = Array.from(grouped.keys()).sort((a, b) => a.localeCompare(b));
        sortedCategories.forEach(category => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = category;
            grouped.get(category)
                .sort((a, b) => a.display_name.localeCompare(b.display_name))
                .forEach(tool => {
                    const option = document.createElement('option');
                    option.value = tool.slug;
                    option.textContent = tool.display_name;
                    optgroup.appendChild(option);
                });
            selector.appendChild(optgroup);
        });
    }

    function collectExamples(tool) {
        if (!tool) {
            return [];
        }

        const examples = [];

        if (Array.isArray(tool.operations) && tool.operations.length) {
            tool.operations.forEach(operation => {
                if (!operation || !Array.isArray(operation.examples)) {
                    return;
                }
                operation.examples.forEach(example => {
                    if (!example || !example.prompt) {
                        return;
                    }
                    examples.push({
                        label: example.label || example.prompt,
                        prompt: example.prompt,
                        operationTitle: operation.title || null,
                        parameters: Array.isArray(operation.parameters) ? operation.parameters : []
                    });
                });
            });
        }

        if (!examples.length && Array.isArray(tool.examples)) {
            const fallbackParams = Array.isArray(tool.parameters) ? tool.parameters : [];
            tool.examples.forEach(example => {
                if (!example || !example.prompt) {
                    return;
                }
                examples.push({
                    label: example.label || example.prompt,
                    prompt: example.prompt,
                    operationTitle: null,
                    parameters: fallbackParams
                });
            });
        }

        return examples;
    }

    function collectParameters(tool, example) {
        if (!example) {
            return [];
        }

        const seen = new Set();
        const unique = [];

        const addParams = (params) => {
            if (!Array.isArray(params)) {
                return;
            }
            params.forEach(param => {
                if (!param || !param.name) {
                    return;
                }
                const key = String(param.name).toLowerCase();
                if (seen.has(key)) {
                    return;
                }
                seen.add(key);
                unique.push(param);
            });
        };

        addParams(example.parameters);

        if (!unique.length && example.operationTitle && Array.isArray(tool.operations)) {
            const operation = tool.operations.find(op => op && op.title === example.operationTitle);
            if (operation) {
                addParams(operation.parameters);
            }
        }

        return unique;
    }

    function buildParameterHints(tool, example) {
        const params = collectParameters(tool, example);
        if (!params.length) {
            return '';
        }

        const heading = example && example.operationTitle
            ? `Parameters · ${escapeHtml(example.operationTitle)}`
            : 'Parameters';

        const items = params.map(param => {
            const requiredBadge = param.required ? '<span class="text-danger fw-semibold ms-2">required</span>' : '';
            const description = param.description ? ` - ${escapeHtml(param.description)}` : '';
            const options = Array.isArray(param.options) && param.options.length
                ? ` <span class="text-muted">(Options: ${param.options.map(option => escapeHtml(option)).join(', ')})</span>`
                : '';
            return `<li><code>${escapeHtml(param.name)}</code>${requiredBadge}${description}${options}</li>`;
        });

        return `<div class="alert alert-secondary mb-0"><strong>${heading}</strong><ul class="mb-0">${items.join('')}</ul></div>`;
    }

    function updateExamples() {
        const toolSelector = document.getElementById('tool-selector');
        const exampleSelector = document.getElementById('example-selector');
        const chatInput = document.getElementById('chat-input');
        const docLink = document.getElementById('tool-doc-link');
        const parameterHints = document.getElementById('tool-parameter-hints');

        if (!toolSelector || !exampleSelector) {
            return;
        }

        const selectedSlug = toolSelector.value;
        const metadata = selectedSlug ? metadataBySlug[selectedSlug] : null;

        if (docLink) {
            docLink.innerHTML = '';
            docLink.className = 'mt-2 small text-muted';
        }

        if (parameterHints) {
            parameterHints.innerHTML = '<div class="text-muted small">Select an example to see its documented parameters.</div>';
        }

        if (!metadata) {
            exampleSelector.disabled = true;
            exampleSelector.innerHTML = '<option value="">Select a tool first...</option>';
            if (chatInput) {
                chatInput.value = '';
            }
            return;
        }

        if (docLink) {
            const segments = [];
            if (metadata.description) {
                segments.push(escapeHtml(metadata.description));
            }
            if (Array.isArray(metadata.notes)) {
                metadata.notes.forEach(note => {
                    if (note) {
                        segments.push(`<span class="text-warning">${escapeHtml(note)}</span>`);
                    }
                });
            } else if (metadata.lazy_loaded) {
                segments.push('<span class="text-warning">Loads on first use — run a CLI example to register this tool.</span>');
            }
            if (metadata.doc_url) {
                segments.push(`<a href="${metadata.doc_url}" target="_blank" rel="noopener">View documentation</a>`);
            }

            docLink.innerHTML = segments.join(' · ') || '';
        }

        const examples = collectExamples(metadata);
        if (!examples.length) {
            exampleSelector.disabled = true;
            exampleSelector.innerHTML = '<option value="">No examples available for this tool yet.</option>';
            if (chatInput) {
                chatInput.value = '';
            }
            return;
        }

        exampleSelector.disabled = false;
        exampleSelector.innerHTML = '<option value="">Select an example...</option>';
        const exampleData = examples;

        exampleData.forEach((example, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = example.label;
            option.dataset.prompt = example.prompt;
            if (example.operationTitle) {
                option.dataset.operationTitle = example.operationTitle;
            }
            exampleSelector.appendChild(option);
        });

        exampleSelector.onchange = function() {
            const selectedOption = exampleSelector.selectedOptions[0];
            const rawValue = selectedOption ? selectedOption.value : '';
            const selectedIndex = rawValue === '' ? NaN : Number(rawValue);
            const selectedExample = Number.isInteger(selectedIndex) ? exampleData[selectedIndex] : null;

            if (selectedOption && selectedOption.dataset.prompt) {
                if (chatInput) {
                    chatInput.value = selectedOption.dataset.prompt;
                    chatInput.focus();
                }
            } else if (chatInput) {
                chatInput.value = '';
            }

            if (parameterHints) {
                if (selectedExample) {
                    parameterHints.innerHTML = buildParameterHints(metadata, selectedExample) || '<div class="text-muted small">No specific parameters documented for this example.</div>';
                } else {
                    parameterHints.innerHTML = '<div class="text-muted small">Select an example to see its documented parameters.</div>';
                }
            }
        };
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message) {
            return;
        }

        const sendBtn = document.getElementById('send-btn');
        const chatHistory = document.getElementById('chat-history');
        
        // Disable input while processing
        input.disabled = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Thinking...';

        // Clear welcome message if it's the first message
        if (chatHistory.querySelector('.text-muted.py-5')) {
            chatHistory.innerHTML = '';
        }
        
        // Add user message
        appendMessage('user', message);
        
        // Clear input
        input.value = '';
        
        try {
            const response = await fetch('/api/azure-mcp/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                const result = data.data[0];
                appendMessage('assistant', result.response);
            } else {
                appendMessage('error', data.error || 'Failed to get response');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            appendMessage('error', `Error: ${error.message}`);
        } finally {
            // Re-enable input
            input.disabled = false;
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
            input.focus();
        }
    }

    function appendMessage(role, content) {
        const chatHistory = document.getElementById('chat-history');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}-message mb-3`;

        let icon = '';
        let bgColor = '';
        let textColor = '';

        if (role === 'user') {
            icon = '<i class="fas fa-user me-2"></i>';
            bgColor = '#e3f2fd';
            textColor = '#1976d2';
        } else if (role === 'assistant') {
            icon = '<i class="fas fa-robot me-2"></i>';
            bgColor = '#f3e5f5';
            textColor = '#7b1fa2';
        } else if (role === 'error') {
            icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
            bgColor = '#ffebee';
            textColor = '#c62828';
        } else {
            bgColor = '#eceff1';
            textColor = '#37474f';
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'chat-message-wrapper';
        wrapper.style.backgroundColor = bgColor;
        wrapper.style.borderLeft = `4px solid ${textColor}`;

        const header = document.createElement('div');
        header.className = 'chat-message-header';
        header.style.color = textColor;
        header.innerHTML = `${icon}${role === 'user' ? 'You' : 'Assistant'}`;
        const body = document.createElement('div');
        body.className = 'chat-message-body';
        body.style.color = '#333';

        const { html, hasRichContent } = formatContent(content);

        if (hasRichContent) {
            body.classList.add('chat-html-content');
        } else {
            body.classList.add('chat-text-content');
        }

        body.innerHTML = html;
        deduplicateSequentialContent(body);

        wrapper.appendChild(header);
        wrapper.appendChild(body);
        messageDiv.appendChild(wrapper);

        chatHistory.appendChild(messageDiv);

        // Scroll to bottom
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function sanitizeHtml(html) {
        const template = document.createElement('template');
        template.innerHTML = html;

        const forbiddenTags = ['script', 'style', 'iframe', 'object', 'embed'];
        forbiddenTags.forEach(tag => {
            template.content.querySelectorAll(tag).forEach(node => node.remove());
        });

        template.content.querySelectorAll('*').forEach(node => {
            [...node.attributes].forEach(attr => {
                const name = attr.name.toLowerCase();
                if (name.startsWith('on') || name === 'formaction' || name === 'srcdoc') {
                    node.removeAttribute(attr.name);
                }
            });
        });

        return template.innerHTML;
    }

    function deduplicateSequentialContent(container) {
        const normalise = value => value.replace(/\s+/g, ' ').trim();

        let lastTableSignature = null;
        container.querySelectorAll('table').forEach(table => {
            const signature = normalise(table.textContent || '');
            if (signature && signature === lastTableSignature) {
                table.remove();
            } else {
                lastTableSignature = signature;
            }
        });

        let lastParagraphSignature = null;
        container.querySelectorAll('p').forEach(paragraph => {
            const signature = normalise(paragraph.textContent || '');
            if (signature && signature === lastParagraphSignature) {
                paragraph.remove();
            } else {
                lastParagraphSignature = signature;
            }
        });
    }

    function buildStructuredHtml(text) {
        const container = document.createElement('div');
        const lines = text.split('\n');
        let index = 0;
        let hasRichContent = false;

        const isMetadataHeader = (line) => /^Auto-filled parameters:/i.test(line) || /^Suggested parameter values:/i.test(line);
        const isListLine = (line) => {
            const trimmed = line.trim();
            return /^[-*+]\s+/.test(trimmed) || /^\d+\.\s+/.test(trimmed);
        };
        const isSpecialBlockStart = (position) => {
            if (position >= lines.length) {
                return false;
            }
            const current = lines[position];
            if (!current || !current.trim()) {
                return false;
            }
            const trimmed = current.trim();
            if (trimmed.startsWith('```')) {
                return true;
            }
            if (isMetadataHeader(trimmed)) {
                return true;
            }
            return isListLine(trimmed);
        };

        const parseCodeBlock = (startIndex) => {
            let idx = startIndex + 1;
            const codeLines = [];
            while (idx < lines.length && !lines[idx].trim().startsWith('```')) {
                codeLines.push(lines[idx]);
                idx++;
            }
            if (idx < lines.length && lines[idx].trim().startsWith('```')) {
                idx++;
            }
            const pre = document.createElement('pre');
            pre.className = 'mcp-pre';
            const code = document.createElement('code');
            code.textContent = codeLines.join('\n');
            pre.appendChild(code);
            return { node: pre, nextIndex: idx };
        };

        const parseMetadataBlock = (startIndex) => {
            const headerLine = lines[startIndex].trim();
            if (!isMetadataHeader(headerLine)) {
                return null;
            }
            const isAutofill = /^Auto-filled parameters:/i.test(headerLine);
            let idx = startIndex + 1;
            const wrapper = document.createElement('div');
            wrapper.className = `mcp-meta ${isAutofill ? 'mcp-meta-autofill' : 'mcp-meta-suggestions'}`;
            const title = document.createElement('strong');
            title.textContent = headerLine.replace(/:$/, '');
            wrapper.appendChild(title);
            const list = document.createElement('ul');
            wrapper.appendChild(list);

            let consumed = false;
            let currentItem = null;

            while (idx < lines.length) {
                const rawLine = lines[idx];
                if (!rawLine.trim()) {
                    break;
                }

                if (isAutofill) {
                    const trimmed = rawLine.trim();
                    if (!trimmed.startsWith('-')) {
                        break;
                    }
                    consumed = true;
                    const entryText = trimmed.replace(/^-\s*/, '');
                    const parts = entryText.split(':');
                    const li = document.createElement('li');
                    if (parts.length > 1) {
                        const key = parts.shift();
                        const value = parts.join(':').trim();
                        const code = document.createElement('code');
                        code.textContent = (key || '').trim();
                        li.appendChild(code);
                        if (value) {
                            li.appendChild(document.createTextNode(`: ${value}`));
                        }
                    } else {
                        li.textContent = entryText;
                    }
                    list.appendChild(li);
                    idx++;
                    continue;
                }

                const primaryMatch = rawLine.trim();
                if (/^-\s+/.test(primaryMatch)) {
                    consumed = true;
                    const li = document.createElement('li');
                    const strong = document.createElement('strong');
                    strong.textContent = primaryMatch.replace(/^-\s*/, '').replace(/:$/, '');
                    li.appendChild(strong);
                    list.appendChild(li);
                    currentItem = li;
                    idx++;
                    continue;
                }

                if (/^\s{2,}-\s+/.test(rawLine)) {
                    if (!currentItem) {
                        idx++;
                        continue;
                    }
                    consumed = true;
                    let nested = currentItem.querySelector('ul');
                    if (!nested) {
                        nested = document.createElement('ul');
                        currentItem.appendChild(nested);
                    }
                    const nestedItem = document.createElement('li');
                    nestedItem.textContent = rawLine.trim().replace(/^-+\s*/, '');
                    nested.appendChild(nestedItem);
                    idx++;
                    continue;
                }

                break;
            }

            if (!consumed) {
                return null;
            }

            return { node: wrapper, nextIndex: idx };
        };

        const parseListBlock = (startIndex) => {
            const firstLine = lines[startIndex];
            if (!firstLine || !isListLine(firstLine)) {
                return null;
            }

            const isOrdered = /^\d+\.\s+/.test(firstLine.trim());
            const list = document.createElement(isOrdered ? 'ol' : 'ul');
            let idx = startIndex;

            while (idx < lines.length) {
                const line = lines[idx];
                if (!line.trim()) {
                    break;
                }
                if (!isListLine(line)) {
                    break;
                }
                const trimmed = line.trim();
                const itemText = isOrdered
                    ? trimmed.replace(/^\d+\.\s+/, '')
                    : trimmed.replace(/^[-*+]\s+/, '');
                const li = document.createElement('li');
                li.textContent = itemText;
                list.appendChild(li);
                idx++;
            }

            if (!list.children.length) {
                return null;
            }

            return { node: list, nextIndex: idx };
        };

        const parseParagraphBlock = (startIndex) => {
            let idx = startIndex;
            const collectedLines = [];

            while (idx < lines.length) {
                const line = lines[idx];
                if (!line.trim()) {
                    break;
                }
                if (idx !== startIndex && isSpecialBlockStart(idx)) {
                    break;
                }
                collectedLines.push(line);
                idx++;
            }

            if (!collectedLines.length) {
                return { node: document.createTextNode(''), nextIndex: idx, hasRichContent: false };
            }

            const joined = collectedLines.join('\n');
            const multiLine = collectedLines.length > 1;
            const hasIndentation = collectedLines.some(line => /^\s{2,}/.test(line));
            const looksJsonLike = /^\s*[\[{]/.test(collectedLines[0]);

            if (multiLine && (hasIndentation || looksJsonLike)) {
                const pre = document.createElement('pre');
                pre.className = 'mcp-pre';
                pre.textContent = joined;
                return { node: pre, nextIndex: idx, hasRichContent: true };
            }

            const paragraph = document.createElement('p');
            collectedLines.forEach((line, lineIndex) => {
                if (lineIndex > 0) {
                    paragraph.appendChild(document.createElement('br'));
                }
                paragraph.appendChild(document.createTextNode(line.trim()));
            });
            return { node: paragraph, nextIndex: idx, hasRichContent: false };
        };

        while (index < lines.length) {
            if (!lines[index].trim()) {
                index++;
                continue;
            }

            if (lines[index].trim().startsWith('```')) {
                const block = parseCodeBlock(index);
                container.appendChild(block.node);
                index = block.nextIndex;
                hasRichContent = true;
                continue;
            }

            const metadataBlock = parseMetadataBlock(index);
            if (metadataBlock) {
                container.appendChild(metadataBlock.node);
                index = metadataBlock.nextIndex;
                hasRichContent = true;
                continue;
            }

            const listBlock = parseListBlock(index);
            if (listBlock) {
                container.appendChild(listBlock.node);
                index = listBlock.nextIndex;
                hasRichContent = true;
                continue;
            }

            const paragraphBlock = parseParagraphBlock(index);
            container.appendChild(paragraphBlock.node);
            index = paragraphBlock.nextIndex;
            if (paragraphBlock.hasRichContent) {
                hasRichContent = true;
            }
        }

        return { html: container.innerHTML, hasRichContent };
    }

    function formatContent(text) {
        if (!text) {
            return { html: '', hasRichContent: false };
        }

        const trimmed = text.trim();
        if (!trimmed) {
            return { html: '', hasRichContent: false };
        }

        const containsHtml = /<\/?[a-z][\s\S]*>/i.test(trimmed);
        const isTrustedHtml = /<table|class=["']mcp-meta|<pre|<ul|<ol/.test(trimmed);

        if (containsHtml && isTrustedHtml) {
            return {
                html: sanitizeHtml(trimmed),
                hasRichContent: true
            };
        }

        const { html, hasRichContent } = buildStructuredHtml(trimmed);
        return {
            html: sanitizeHtml(html || `<p>${escapeHtml(trimmed)}</p>`),
            hasRichContent
        };
    }

    async function clearChat() {
        if (!confirm('Are you sure you want to clear the chat history?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/azure-mcp/chat/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                const chatHistory = document.getElementById('chat-history');
                chatHistory.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <p>Ask me anything about your Azure resources!</p>
                        <p class="small">Examples: "List my resource groups", "What compute resources do I have?", "Show me all VMs in East US"</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error clearing chat:', error);
            alert('Failed to clear chat: ' + error.message);
        }
    }

    // Agent Communication Functions
    let agentCommStartTime = null;
    let agentCommStats = {
        iterations: 0,
        toolCalls: 0,
        strategy: '-',
        duration: 0
    };

    function toggleAgentComms() {
        const section = document.getElementById('agent-comms-section');
        const btn = document.getElementById('toggle-comms-btn');
        
        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide';
        } else {
            section.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-eye me-1"></i>Show';
        }
    }

    function clearAgentComms() {
        const stream = document.getElementById('agent-comms-stream');
        stream.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-brain fa-3x mb-3" style="color: #6c757d;"></i>
                <p style="color: #6c757d;">Agent activity will appear here when processing requests...</p>
            </div>
        `;
        
        // Reset stats
        agentCommStats = {
            iterations: 0,
            toolCalls: 0,
            strategy: '-',
            duration: 0
        };
        updateAgentStats();
        document.getElementById('reasoning-stats').style.display = 'none';
    }

    function updateAgentStats() {
        document.getElementById('stat-iterations').textContent = agentCommStats.iterations;
        document.getElementById('stat-tools').textContent = agentCommStats.toolCalls;
        document.getElementById('stat-strategy').textContent = agentCommStats.strategy;
        document.getElementById('stat-duration').textContent = agentCommStats.duration + 's';
    }

    function addAgentComm(phase, content, metadata = {}) {
        const stream = document.getElementById('agent-comms-stream');
        const statsDiv = document.getElementById('reasoning-stats');
        
        // Remove placeholder if present
        if (stream.querySelector('.text-center.text-muted')) {
            stream.innerHTML = '';
            statsDiv.style.display = 'flex';
            agentCommStartTime = Date.now();
        }
        
        // Update stats
        if (metadata.iteration) {
            agentCommStats.iterations = metadata.iteration;
        }
        if (metadata.strategy) {
            agentCommStats.strategy = metadata.strategy;
        }
        if (phase === 'action' && metadata.toolName) {
            agentCommStats.toolCalls++;
        }
        if (agentCommStartTime) {
            agentCommStats.duration = ((Date.now() - agentCommStartTime) / 1000).toFixed(1);
        }
        updateAgentStats();
        
        // Create comm entry
        const entry = document.createElement('div');
        entry.className = 'agent-comm-entry';
        
        const timestamp = new Date().toLocaleTimeString();
        const iteration = metadata.iteration ? `<span class="reasoning-iteration">Iteration ${metadata.iteration}</span>` : '';
        
        let html = `
            <div class="agent-comm-header">
                <div>
                    <span class="agent-comm-phase phase-${phase}">${phase}</span>
                    ${iteration}
                </div>
                <span class="agent-comm-timestamp">${timestamp}</span>
            </div>
            <div class="agent-comm-content">${escapeHtml(content)}</div>
        `;
        
        // Add tool call details
        if (phase === 'action' && metadata.toolName) {
            html += `
                <div class="tool-call">
                    <div class="tool-name">🔧 ${escapeHtml(metadata.toolName)}</div>
                    ${metadata.toolParams ? `<div class="tool-params">Parameters: ${escapeHtml(JSON.stringify(metadata.toolParams, null, 2))}</div>` : ''}
                </div>
            `;
        }
        
        // Add tool result
        if (phase === 'observation' && metadata.toolResult) {
            const resultClass = metadata.isError ? 'tool-error' : 'tool-result';
            const resultText = typeof metadata.toolResult === 'string' 
                ? metadata.toolResult 
                : JSON.stringify(metadata.toolResult, null, 2);
            html += `
                <div class="${resultClass}">
                    ${metadata.isError ? '❌' : '✅'} Result: ${escapeHtml(resultText)}
                </div>
            `;
        }
        
        entry.innerHTML = html;
        stream.appendChild(entry);
        
        // Auto-scroll to bottom
        stream.scrollTop = stream.scrollHeight;
    }

    // Connect to agent communication stream (SSE)
    let agentEventSource = null;

    function startAgentCommStream() {
        // Close existing connection if any
        if (agentEventSource) {
            agentEventSource.close();
        }

        agentEventSource = new EventSource('/api/azure-mcp/agent-stream');
        
        agentEventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                
                if (data.type === 'reasoning') {
                    addAgentComm('reasoning', data.content, {
                        iteration: data.iteration,
                        strategy: data.strategy
                    });
                } else if (data.type === 'action') {
                    addAgentComm('action', data.content, {
                        iteration: data.iteration,
                        toolName: data.tool_name,
                        toolParams: data.tool_params
                    });
                } else if (data.type === 'observation') {
                    addAgentComm('observation', data.content, {
                        iteration: data.iteration,
                        toolResult: data.tool_result,
                        isError: data.is_error
                    });
                } else if (data.type === 'reflection') {
                    addAgentComm('reflection', data.content, {
                        iteration: data.iteration
                    });
                } else if (data.type === 'synthesis') {
                    addAgentComm('synthesis', data.content, {
                        iteration: data.iteration
                    });
                } else if (data.type === 'planning') {
                    addAgentComm('planning', data.content, {
                        strategy: data.strategy
                    });
                }
            } catch (error) {
                console.error('Error parsing agent comm event:', error);
            }
        };
        
        agentEventSource.onerror = function(error) {
            console.error('Agent comm stream error:', error);
            // Will automatically reconnect
        };
    }

    // Start stream on page load
    window.addEventListener('load', function() {
        startAgentCommStream();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (agentEventSource) {
            agentEventSource.close();
        }
    });
</script>

<style>
    .action-btn {
        padding: var(--spacing-md) var(--spacing-xl);
        font-weight: 600;
        border-radius: var(--radius-lg);
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        min-width: 160px;
        justify-content: center;
        border: none;
    }

    .action-btn-primary {
        background: transparent;
        color: white;
        border: 2px solid white !important;
    }

    .action-btn-primary:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid white !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .action-btn-secondary {
        background: transparent;
        color: white;
        border: 2px solid white !important;
    }

    .action-btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid white !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    pre {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        max-height: 400px;
    }

    .font-monospace {
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.9rem;
    }

    /* Chat Interface Styles */
    .chat-container {
        border: 1px solid #dee2e6;
        height: 600px;
        overflow-y: auto;
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1rem;
    }

    .chat-container::-webkit-scrollbar {
        width: 8px;
    }

    .chat-container::-webkit-scrollbar-thumb {
        background: rgba(37, 99, 235, 0.35);
        border-radius: 4px;
    }

    .chat-message {
        animation: slideIn 0.3s ease-out;
    }

    .chat-message-wrapper {
        padding: 12px;
        border-radius: 8px;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.02);
    }

    .chat-message-header {
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chat-message-body {
        line-height: 1.6;
    }

    .chat-text-content {
        white-space: pre-line;
        word-wrap: break-word;
    }

    .chat-html-content {
        white-space: normal;
        overflow-x: auto;
    }

    .chat-html-content table {
        width: 100%;
        margin: 1rem 0;
        border-collapse: separate;
        border-spacing: 0;
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .chat-html-content th {
        background-color: #343a40;
        color: #ffffff;
        font-weight: 600;
        padding: 12px 16px;
        text-align: left;
        border-bottom: 2px solid #495057;
        border-right: 1px solid #495057;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .chat-html-content td {
        padding: 12px 16px;
        border-bottom: 1px solid #e9ecef;
        border-right: 1px solid #e9ecef;
        color: #374151;
        background-color: #ffffff;
    }

    .chat-html-content table tr:hover {
        background-color: #f8f9fa;
    }

    .chat-html-content table th:last-child,
    .chat-html-content table td:last-child {
        border-right: none;
    }

    .chat-html-content table tbody tr:last-child td {
        border-bottom: none;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #chat-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
    }

    .user-message {
        text-align: left;
    }

    .assistant-message {
        text-align: left;
    }

    .error-message {
        text-align: center;
    }

    .assistant-message .chat-message-wrapper {
        border-left-width: 4px;
    }

    /* Agent Communication Styles */
    .agent-comms-container {
        background-color: #1e1e1e;
        color: #d4d4d4;
    }
    
    .agent-comm-entry {
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        border-left: 3px solid #0078d4;
        background-color: #2d2d30;
        border-radius: 4px;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .agent-comm-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .agent-comm-phase {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
    }
    
    .phase-reasoning {
        background-color: #4ec9b0;
        color: #000;
    }
    
    .phase-action {
        background-color: #569cd6;
        color: #fff;
    }
    
    .phase-observation {
        background-color: #dcdcaa;
        color: #000;
    }
    
    .phase-reflection {
        background-color: #c586c0;
        color: #fff;
    }
    
    .phase-synthesis {
        background-color: #ce9178;
        color: #fff;
    }
    
    .phase-planning {
        background-color: #9cdcfe;
        color: #000;
    }
    
    .agent-comm-timestamp {
        font-size: 0.7rem;
        color: #858585;
    }
    
    .agent-comm-content {
        color: #d4d4d4;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .tool-call {
        background-color: #1e3a5f;
        padding: 0.5rem;
        border-radius: 3px;
        margin-top: 0.5rem;
        border-left: 3px solid #569cd6;
    }
    
    .tool-name {
        color: #4ec9b0;
        font-weight: bold;
    }
    
    .tool-params {
        color: #9cdcfe;
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }
    
    .tool-result {
        background-color: #1e401e;
        padding: 0.5rem;
        border-radius: 3px;
        margin-top: 0.5rem;
        border-left: 3px solid #4ec9b0;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .tool-error {
        background-color: #3f1e1e;
        padding: 0.5rem;
        border-radius: 3px;
        margin-top: 0.5rem;
        border-left: 3px solid #f48771;
        color: #f48771;
    }
    
    .stat-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    
    .stat-value {
        font-size: 1.75rem;
        font-weight: bold;
        color: #0078d4;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .reasoning-iteration {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background-color: #0078d4;
        color: white;
        border-radius: 3px;
        font-size: 0.75rem;
        margin-left: 0.5rem;
    }
</style>
{% endblock %}
