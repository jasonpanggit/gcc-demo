{% extends "base.html" %}
{% from "components/unified_chat.html" import render_chat, render_agent_comms, chat_init_script %}

{% block title %}Azure MCP Server - Azure Agentic Platform{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-content">
        <div class="row align-items-center">
            <div class="col-lg-12">
                <h1 class="hero-title">
                    <span class="hero-icon me-3"><i class="fab fa-microsoft"></i></span>Azure MCP Assistant
                </h1>
                <p class="hero-subtitle">
                    Explore and manage Azure resources through the Azure Agentic Platform using Model Context Protocol tooling.
                </p>
                <!-- <div class="d-flex gap-3 justify-content-start flex-wrap">
                    <button class="btn action-btn action-btn-primary" onclick="refreshStatus()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Status
                    </button>
                    <button class="btn action-btn action-btn-secondary" onclick="listTools()">
                        <i class="fas fa-tools me-2"></i>List Tools
                    </button>
                </div> -->
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container-fluid mt-4">
    <!-- MCP Chat Interface -->
    <div class="row">
        <div class="col-12 mb-4">
            {{ render_chat(mode='mcp') }}
        </div>
    </div>

    <!-- Agent Communication Section -->
    <div class="row">
        <div class="col-12 mb-4">
            {{ render_agent_comms(mode='mcp', custom_config={'show_flow': False}) }}
        </div>
    </div>

    <div class="row" id="status-tools-row">
        <!-- Status & Tools Card (Combined) -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>MCP Servers & Tools</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleStatusTools()" id="toggle-status-btn">
                        <i class="fas fa-chevron-down me-1"></i>Expand
                    </button>
                </div>
                <div class="card-body" id="status-tools-section" style="display: none;">
                    <!-- MCP Connection Status -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div id="status-container">
                                <p class="text-muted">Loading MCP status...</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Available Tools -->
                        <div class="col-12">
                            <h6 class="mb-3"><i class="fas fa-tools me-2"></i>List of Tools</h6>
                            <div id="tools-container" style="max-height: 400px; overflow-y: auto;">
                                <p class="text-muted">Tools will load automatically on startup</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Azure Monitor Community Resources -->
    <div class="row" id="monitor-resources-row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Azure Monitor Community Resources</h5>
                    <button class="btn btn-sm btn-outline-primary" id="toggle-monitor-btn" onclick="toggleMonitorResources()">
                        <i class="fas fa-chevron-down me-1"></i>Expand
                    </button>
                </div>
                <div class="card-body" id="monitor-resources-section" style="display: none;">
                    <div id="monitor-resources-container">
                        <p class="text-muted">Resources will load automatically on startup</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Groups Section -->
    <!-- <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-folder me-2"></i>Azure Resource Groups</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadResourceGroups()">
                        <i class="fas fa-sync-alt me-1"></i>Load Resource Groups
                    </button>
                </div>
                <div class="card-body" id="resource-groups-container">
                    <p class="text-muted">Click "Load Resource Groups" to view your Azure resource groups</p>
                </div>
            </div>
        </div>
    </div> -->

    <!-- Azure Monitor Query Section -->
    <!-- <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-code me-2"></i>Azure Monitor Query</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="resource-query" class="form-label">KQL Query</label>
                        <textarea class="form-control font-monospace" id="resource-query" rows="4" placeholder="Heartbeat | take 10"></textarea>
                        <small class="form-text text-muted">
                            Enter a KQL query to search Azure Monitor / Log Analytics workspace.
                            <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-query-overview" target="_blank">Learn more about Azure Monitor KQL</a>
                        </small>
                    </div>
                    <button class="btn btn-primary" onclick="executeQuery()">
                        <i class="fas fa-play me-1"></i>Execute Query
                    </button>
                    <button class="btn btn-outline-secondary" onclick="loadExampleQuery()">
                        <i class="fas fa-lightbulb me-1"></i>Load Example
                    </button>
                </div>
                <div class="card-footer" id="query-results-container" style="display: none;">
                    <h6>Query Results:</h6>
                    <pre id="query-results" class="mb-0"></pre>
                </div>
            </div>
        </div>
    </div> -->
</div>

<script>
    // Check status on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await loadToolMetadata();
        await listTools();
        await loadMonitorResources();
        refreshStatus();
    });

    async function loadMonitorResources() {
        const container = document.getElementById('monitor-resources-container');
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading Azure Monitor Community resources...</p>
            </div>
        `;

        try {
            const response = await fetch('/api/monitor-community/resources');
            const data = await response.json();

            if (data.success && data.metadata) {
                let html = '';
                
                // Summary card
                if (data.metadata.summary) {
                    const s = data.metadata.summary;
                    html += `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Repository Summary</h6>
                            <div class="row mt-2">
                                <div class="col-md-3"><strong>${s.total_categories}</strong> total categories</div>
                                <div class="col-md-3"><strong>${s.total_workbooks}</strong> workbooks in ${s.workbook_categories} categories</div>
                                <div class="col-md-3"><strong>${s.total_alerts}</strong> alerts in ${s.alert_categories} categories</div>
                                <div class="col-md-3"><strong>${s.total_queries}</strong> queries in ${s.query_categories} categories</div>
                            </div>
                        </div>
                    `;
                }
                
                html += '<div class="row">';
                
                // Workbooks
                if (data.metadata.workbooks && data.metadata.workbooks.length > 0) {
                    html += `
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-book me-2"></i>Workbooks (${data.metadata.workbooks.length} categories)</h6>
                                </div>
                                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                    <div class="accordion" id="workbooksAccordion">
                    `;
                    data.metadata.workbooks.forEach((wb, idx) => {
                        const collapseId = `workbook-${idx}`;
                        html += `
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                        <strong>${escapeHtml(wb.category)}</strong>
                                        <span class="badge bg-primary ms-2">${wb.count} file${wb.count !== 1 ? 's' : ''}</span>
                                    </button>
                                </h2>
                                <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#workbooksAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled mb-0">
                        `;
                        if (wb.files && wb.files.length > 0) {
                            wb.files.forEach(file => {
                                // Extract subfolder path from full path if it exists
                                const pathParts = file.path ? file.path.split('/') : [];
                                const folderHint = pathParts.length > 4 ? pathParts.slice(3, -1).join('/') : '';
                                const displayName = file.display_name || file.name;
                                const description = file.description;
                                html += `
                                    <li class="mb-3">
                                        <i class="fas fa-file me-2"></i>
                                        <a href="${escapeHtml(file.download_url)}" target="_blank"><strong>${escapeHtml(displayName)}</strong></a>
                                        ${folderHint ? `<small class="text-muted ms-2"> ${escapeHtml(folderHint)}</small>` : ''}
                                        ${description ? `<br><small class="text-muted ms-4 fst-italic">${escapeHtml(description)}</small>` : ''}
                                    </li>
                                `;
                            });
                        } else {
                            html += '<li class="text-muted">No files</li>';
                        }
                        html += `
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Alerts
                if (data.metadata.alerts && data.metadata.alerts.length > 0) {
                    html += `
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header bg-warning">
                                    <h6 class="mb-0"><i class="fas fa-bell me-2"></i>Alerts (${data.metadata.alerts.length} categories)</h6>
                                </div>
                                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                    <div class="accordion" id="alertsAccordion">
                    `;
                    data.metadata.alerts.forEach((alert, idx) => {
                        const collapseId = `alert-${idx}`;
                        html += `
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                        <strong>${escapeHtml(alert.category)}</strong>
                                        <span class="badge bg-warning ms-2">${alert.count} file${alert.count !== 1 ? 's' : ''}</span>
                                    </button>
                                </h2>
                                <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#alertsAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled mb-0">
                        `;
                        if (alert.files && alert.files.length > 0) {
                            alert.files.forEach(file => {
                                const pathParts = file.path ? file.path.split('/') : [];
                                const folderHint = pathParts.length > 4 ? pathParts.slice(3, -1).join('/') : '';
                                const displayName = file.display_name || file.name;
                                const description = file.description;
                                html += `
                                    <li class="mb-3">
                                        <i class="fas fa-file me-2"></i>
                                        <a href="${escapeHtml(file.download_url)}" target="_blank"><strong>${escapeHtml(displayName)}</strong></a>
                                        ${folderHint ? `<small class="text-muted ms-2"> ${escapeHtml(folderHint)}</small>` : ''}
                                        ${description ? `<br><small class="text-muted ms-4 fst-italic">${escapeHtml(description)}</small>` : ''}
                                    </li>
                                `;
                            });
                        } else {
                            html += '<li class="text-muted">No files</li>';
                        }
                        html += `
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Queries
                if (data.metadata.queries && data.metadata.queries.length > 0) {
                    html += `
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-code me-2"></i>Queries (${data.metadata.queries.length} categories)</h6>
                                </div>
                                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                    <div class="accordion" id="queriesAccordion">
                    `;
                    data.metadata.queries.forEach((query, idx) => {
                        const collapseId = `query-${idx}`;
                        html += `
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                        <strong>${escapeHtml(query.category)}</strong>
                                        <span class="badge bg-success ms-2">${query.count} file${query.count !== 1 ? 's' : ''}</span>
                                    </button>
                                </h2>
                                <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#queriesAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled mb-0">
                        `;
                        if (query.files && query.files.length > 0) {
                            query.files.forEach(file => {
                                const pathParts = file.path ? file.path.split('/') : [];
                                const folderHint = pathParts.length > 4 ? pathParts.slice(3, -1).join('/') : '';
                                const displayName = file.display_name || file.name;
                                const description = file.description;
                                html += `
                                    <li class="mb-3">
                                        <i class="fas fa-file me-2"></i>
                                        <a href="${escapeHtml(file.download_url)}" target="_blank"><strong>${escapeHtml(displayName)}</strong></a>
                                        ${folderHint ? `<small class="text-muted ms-2"> ${escapeHtml(folderHint)}</small>` : ''}
                                        ${description ? `<br><small class="text-muted ms-4 fst-italic">${escapeHtml(description)}</small>` : ''}
                                    </li>
                                `;
                            });
                        } else {
                            html += '<li class="text-muted">No files</li>';
                        }
                        html += `
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                
                if (!data.metadata.workbooks?.length && !data.metadata.alerts?.length && !data.metadata.queries?.length) {
                    html = '<div class="alert alert-warning">No Azure Monitor Community resources found</div>';
                }

                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-warning">No resources found</div>';
            }
        } catch (error) {
            console.error('Error loading Azure Monitor Community resources:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <p class="mb-0">Failed to load resources: ${error.message}</p>
                </div>
            `;
        }
    }

    function toggleStatusTools() {
        const section = document.getElementById('status-tools-section');
        const btn = document.getElementById('toggle-status-btn');

        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Collapse';
        } else {
            section.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Expand';
        }
    }

    function toggleMonitorResources() {
        const section = document.getElementById('monitor-resources-section');
        const btn = document.getElementById('toggle-monitor-btn');

        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Collapse';
        } else {
            section.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Expand';
        }
    }

    async function refreshStatus() {
        const container = document.getElementById('status-container');
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Checking status...</p>
            </div>
        `;

        try {
            const response = await fetch('/api/azure-mcp/status');
            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                const status = data.data[0];
                const isConnected = status.connection_status === 'connected';

                const toolCounts = status.tool_counts || {};
                const activeClients = Array.isArray(status.active_clients) ? status.active_clients : [];
                const aggregatedToolCount = Object.values(toolCounts).reduce((total, value) => total + (typeof value === 'number' ? value : 0), 0) || Number(status.available_tools_count) || 0;
                const documentedToolCount = metadataTools.length || 0;
                const totalToolCount = aggregatedToolCount + microsoftLearnTools.length;

                const friendlyNameFor = (key) => {
                    if (!key) {
                        return 'Unknown';
                    }
                    return mcpSourceDisplayNames[key] || key.replace(/_/g, ' ');
                };

                const countsForDisplay = (activeClients.length
                    ? activeClients.map(label => [label, typeof toolCounts[label] === 'number' ? toolCounts[label] : 0])
                    : Object.entries(toolCounts)
                ).map(([label, count]) => ({
                    key: label,
                    label: friendlyNameFor(label),
                    count: typeof count === 'number' ? count : 0,
                })).sort((a, b) => a.label.localeCompare(b.label));

                const activeClientEntries = [...new Set(activeClients)]
                    .map(client => ({ key: client, label: friendlyNameFor(client) }))
                    .sort((a, b) => a.label.localeCompare(b.label));

                const serverList = countsForDisplay.length
                    ? countsForDisplay.map(({ label, count }) => `
                        <li class="d-flex justify-content-between align-items-center mb-1">
                            <span>${label}</span>
                            <span class="badge bg-secondary">${count} ${count === 1 ? 'tool' : 'tools'}</span>
                        </li>
                    `).join('')
                    : '<li class="text-muted small mb-0">No MCP servers registered</li>';

                const clientList = activeClientEntries.length
                    ? activeClientEntries.map(({ label }) => `
                        <li class="d-flex justify-content-between align-items-center mb-1">
                            <span>${label}</span>
                            <span class="badge bg-success">Active</span>
                        </li>
                    `).join('')
                    : '<li class="text-muted small mb-0">No active clients</li>';

                const toolMetrics = [
                    { label: 'Agent-ready tools', value: aggregatedToolCount },
                    { label: 'Microsoft Learn tools', value: microsoftLearnTools.length },
                    {
                        label: 'Documented tool metadata',
                        value: documentedToolCount,
                        href: 'https://learn.microsoft.com/en-us/azure/developer/azure-mcp-server/tools/'
                    },
                    { label: 'Total tools available', value: totalToolCount },
                ];

                const toolList = toolMetrics.map(({ label, value, href }) => `
                    <li class="d-flex justify-content-between align-items-center mb-1">
                        <span>${href ? `<a href="${href}" target="_blank" rel="noopener noreferrer">${label}</a>` : label}</span>
                        <span class="badge bg-primary">${value}</span>
                    </li>
                `).join('');

                const lazyPendingTools = lazyLoadedToolMetadata.filter(tool => {
                    if (!tool || !tool.namespace) {
                        return false;
                    }
                    return !runtimeAzureTools.some(runtimeTool => runtimeTool && runtimeTool.name === tool.namespace);
                });
                const lazyPendingCount = lazyPendingTools.length;

                const lazyNote = lazyPendingCount
                    ? `<div class="text-muted small mt-2"><i class="fas fa-clock me-1"></i>${lazyPendingCount} tools load on first use.</div>`
                    : '';

                container.innerHTML = `
                    <div class="card shadow-sm mb-0">
                        <div class="card-header d-flex justify-content-between align-items-center ${isConnected ? 'bg-success text-white' : 'bg-warning'}">
                            <span><i class="fas ${isConnected ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>${isConnected ? 'Connected to Azure MCP Orchestrator' : 'Disconnected from Azure MCP Orchestrator'}</span>
                            <span class="badge ${isConnected ? 'bg-light' : 'bg-dark text-white'}"><i class="fas fa-terminal me-1"></i>Stdio (npx)</span>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="border rounded p-3 h-100">
                                        <h6 class="text-uppercase text-muted small mb-2"><i class="fas fa-server me-2"></i>MCP Servers</h6>
                                        <ul class="list-unstyled mb-0">
                                            ${serverList}
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-3 h-100">
                                        <h6 class="text-uppercase text-muted small mb-2"><i class="fas fa-plug me-2"></i>Agent Clients</h6>
                                        <ul class="list-unstyled mb-0">
                                            ${clientList}
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-3 h-100">
                                        <h6 class="text-uppercase text-muted small mb-2"><i class="fas fa-toolbox me-2"></i>Tool Catalog</h6>
                                        <ul class="list-unstyled mb-0">
                                            ${toolList}
                                        </ul>
                                        ${lazyNote}
                                    </div>
                                </div>
                            </div>
                            <div class="pt-3 mt-3 border-top">
                                <small class="text-muted">
                                    ${isConnected ?
                                        '<i class="fas fa-check-circle text-success me-1"></i>MCP orchestrator running via composite stdio clients.' :
                                        '<i class="fas fa-exclamation-triangle text-warning me-1"></i>MCP orchestrator is not responding. Check server logs or restart the application.'}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                throw new Error('Invalid response format');
            }
        } catch (error) {
            console.error('Error loading status:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle me-2"></i>Error</h6>
                    <p class="mb-0">Failed to load Azure MCP status: ${error.message}</p>
                </div>
            `;
        }
    }

    async function listTools(showLoader = true) {
        const container = document.getElementById('tools-container');
        if (showLoader) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading tools...</p>
                </div>
            `;
        }

        try {
            const response = await fetch('/api/azure-mcp/tools');
            const data = await response.json();

            let html = '';
            runtimeAzureTools = Array.isArray(data.data) ? data.data : [];

            const toolsBySource = {};
            runtimeAzureTools.forEach(tool => {
                const source = tool.source || 'azure';
                if (!toolsBySource[source]) {
                    toolsBySource[source] = [];
                }
                toolsBySource[source].push(tool);
            });

            const preferredOrder = ['azure', 'inventory', 'os_eol', 'azure_cli'];
            const orderedSources = [
                ...preferredOrder.filter(source => Array.isArray(toolsBySource[source]) && toolsBySource[source].length > 0),
                ...Object.keys(toolsBySource).filter(source => !preferredOrder.includes(source) && toolsBySource[source].length > 0)
            ];

            if (data.success && orderedSources.length > 0) {
                orderedSources.forEach(source => {
                    const tools = toolsBySource[source] || [];
                    if (!tools.length) {
                        return;
                    }
                    const friendlySource = mcpSourceDisplayNames[source] || source;
                    html += `<h6 class="fw-semibold ${source === 'azure' ? 'text-primary' : 'text-secondary'}">${friendlySource}</h6>`;
                    html += '<div class="list-group mb-3">';
                    tools.forEach(tool => {
                        const originalName = tool.original_name && tool.original_name !== tool.name ? tool.original_name : null;
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1"><code>${tool.name}</code></h6>
                                    <div class="d-flex gap-2">
                                        ${originalName ? `<span class="badge bg-light">${escapeHtml(originalName)}</span>` : ''}
                                        <span class="badge bg-secondary text-uppercase" style="font-size: 0.7rem;">${friendlySource}</span>
                                    </div>
                                </div>
                                <p class="mb-1 text-muted small">${escapeHtml(tool.description || 'No description available')}</p>
                            </div>
                        `;
                    });
                    html += '</div>';
                });
            } else {
                html += '<div class="alert alert-warning">Azure MCP tools are currently unavailable.</div>';
            }

            const lazyPendingTools = lazyLoadedToolMetadata.filter(tool => {
                if (!tool || !tool.namespace) {
                    return false;
                }
                return !runtimeAzureTools.some(runtimeTool => runtimeTool && runtimeTool.name === tool.namespace);
            });

            if (lazyPendingTools.length > 0) {
                html += '<h6 class="text-warning fw-semibold">Loads On First Use</h6>';
                html += '<div class="list-group mb-3">';
                lazyPendingTools.forEach(tool => {
                    html += `
                        <div class="list-group-item list-group-item-warning">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><code>${tool.namespace}</code></h6>
                            </div>
                            <p class="mb-1 text-muted small">${escapeHtml(tool.description || 'This tool registers the first time you run one of its quick examples.')}</p>
                            <p class="mb-0 small text-muted">Tip: Use a matching Quick Example to initialize this tool and add it to the active list.</p>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Refresh server selector after loading runtime tools
            populateServerSelector();

            if (microsoftLearnTools.length > 0) {
                html += '<h6 class="text-success fw-semibold">Microsoft Learn MCP Server Tools</h6>';
                html += '<div class="list-group">';
                microsoftLearnTools.forEach(tool => {
                    html += `
                        <div class="list-group-item list-group-item-light">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><code>${tool.name}</code></h6>
                            </div>
                            <p class="mb-1 text-muted small">${tool.description}</p>
                        </div>
                    `;
                });
                html += '</div>';
            }

            container.innerHTML = html || '<div class="alert alert-warning">No tools available</div>';
        } catch (error) {
            console.error('Error loading tools:', error);
            runtimeAzureTools = [];
            container.innerHTML = `
                <div class="alert alert-danger">
                    <p class="mb-0">Failed to load tools: ${error.message}</p>
                </div>
            `;
        }
    }

    async function loadResourceGroups() {
        const container = document.getElementById('resource-groups-container');
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading resource groups...</p>
            </div>
        `;

        try {
            const response = await fetch('/api/azure-mcp/resource-groups');
            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                const result = data.data[0];
                container.innerHTML = `
                    <pre class="mb-0">${JSON.stringify(result.content, null, 2)}</pre>
                `;
            } else {
                container.innerHTML = '<div class="alert alert-warning">No resource groups found</div>';
            }
        } catch (error) {
            console.error('Error loading resource groups:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <p class="mb-0">Failed to load resource groups: ${error.message}</p>
                </div>
            `;
        }
    }

    function loadExampleQuery() {
        document.getElementById('resource-query').value = 'Heartbeat\n| where TimeGenerated > ago(1h)\n| summarize count() by Computer\n| top 10 by count_';
    }

    async function executeQuery() {
        const query = document.getElementById('resource-query').value.trim();
        if (!query) {
            alert('Please enter a query');
            return;
        }

        const resultsContainer = document.getElementById('query-results-container');
        const resultsElement = document.getElementById('query-results');
        
        resultsContainer.style.display = 'block';
        resultsElement.textContent = 'Executing query...';

        try {
            const response = await fetch('/api/azure-mcp/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            });

            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                const result = data.data[0];
                resultsElement.textContent = JSON.stringify(result.content, null, 2);
            } else {
                resultsElement.textContent = 'No results returned';
            }
        } catch (error) {
            console.error('Error executing query:', error);
            resultsElement.textContent = `Error: ${error.message}`;
        }
    }

    // ========================================================================
    // MCP CHAT FUNCTIONS
    // ========================================================================

    // Microsoft Learn MCP server tool metadata for status/list rendering
    const microsoftLearnTools = [
        { name: 'microsoft_learn.searchLearningPaths', description: 'Search Microsoft Learn for learning paths aligned to certification exams or keywords.' },
        { name: 'microsoft_learn.listModulesByTopic', description: 'List Microsoft Learn modules for a topic with duration and unit counts.' },
        { name: 'microsoft_learn.getModuleOutline', description: 'Retrieve the unit-by-unit outline for a Microsoft Learn module.' },
        { name: 'microsoft_learn.recommendContentForRole', description: 'Recommend Microsoft Learn content for a specific Azure job role and prerequisite knowledge.' }
    ];

    const mcpSourceDisplayNames = {
        azure: 'Azure MCP Server',
        inventory: 'Log Analytics Inventory',
        os_eol: 'Operating System EOL',
        azure_cli: 'Azure CLI Executor',
        monitor: 'Azure Monitor Community Resources',
        sre: 'SRE MCP Server',
        microsoft_learn: 'Microsoft Learn',
    };

    let runtimeAzureTools = [];

    const lazyLoadedToolMetadata = [
        {
            slug: 'azure-cli-executor-execute-command',
            display_name: 'Azure CLI Executor 路 Execute command',
            category: 'Agentic Utilities',
            namespace: 'azure_cli_execute_command',
            description: 'Execute Azure CLI commands using the dedicated MCP server with service principal authentication.',
            lazy_loaded: true,
            notes: [
                'Loads on first useuse a CLI example below to start the Azure CLI executor MCP server and add it to the tool list.'
            ],
            operations: [
                {
                    title: 'Run Azure CLI command',
                    description: 'Execute an Azure CLI command (must begin with "az") and return stdout, stderr, exit code, and duration.',
                    parameters: [
                        {
                            name: 'command',
                            required: true,
                            description: 'Complete Azure CLI command string starting with "az".'
                        },
                        {
                            name: 'working_directory',
                            required: false,
                            description: 'Optional working directory to run the command in.'
                        },
                        {
                            name: 'timeout_seconds',
                            required: false,
                            description: 'Maximum execution time in seconds (defaults to 300).'
                        }
                    ],
                    examples: [
                        {
                            label: 'Create a storage account',
                            prompt: 'execute cli command "az storage account create --name <storage-account-name> --resource-group <resource-group> --location <azure-region> --sku Standard_LRS"'
                        },
                        {
                            label: 'Show a resource group',
                            prompt: 'execute cli command "az group show --name <resource-group> --output json"'
                        },
                        {
                            label: 'List container apps',
                            prompt: 'execute cli command "az containerapp list --resource-group <resource-group> --query \"[].{name:name,location:location}\" --output table"'
                        }
                    ]
                }
            ]
        },
        // ======================================================================
        // Azure Monitor Community Resources
        // ======================================================================
        {
            slug: 'monitor-get-service-resources',
            display_name: 'Azure Monitor Community 路 Get service resources',
            category: 'Azure Monitor Community Resources',
            namespace: 'get_service_monitor_resources',
            description: 'Find ALL Azure Monitor resources (workbooks, alerts, queries) for a service in one call.',
            operations: [
                {
                    title: 'Get service monitor resources',
                    examples: [
                        { label: 'Container Apps monitoring', prompt: 'Find all Azure Monitor resources for Container Apps' },
                        { label: 'Virtual Machines monitoring', prompt: 'Show me workbooks and alerts for Virtual Machines' },
                        { label: 'Storage monitoring', prompt: 'What Monitor Community resources exist for Azure Storage?' }
                    ]
                }
            ]
        },
        {
            slug: 'monitor-search-categories',
            display_name: 'Azure Monitor Community 路 Search categories',
            category: 'Azure Monitor Community Resources',
            namespace: 'search_categories',
            description: 'Search for Azure service categories by keyword.',
            operations: [
                {
                    title: 'Search categories',
                    examples: [
                        { label: 'Search for SQL', prompt: 'Search Azure Monitor categories for SQL' },
                        { label: 'Search for Kubernetes', prompt: 'Find Kubernetes-related Monitor Community categories' }
                    ]
                }
            ]
        },
        {
            slug: 'monitor-list-resources',
            display_name: 'Azure Monitor Community 路 List resources',
            category: 'Azure Monitor Community Resources',
            namespace: 'list_resources',
            description: 'List specific resources (workbooks, alerts, queries) in a category.',
            operations: [
                {
                    title: 'List resources',
                    examples: [
                        { label: 'List VM workbooks', prompt: 'List all workbooks in the Virtual Machines category' },
                        { label: 'List Container Apps alerts', prompt: 'Show alerts available for Container Apps' }
                    ]
                }
            ]
        },
        {
            slug: 'monitor-deploy-workbook',
            display_name: 'Azure Monitor Community 路 Deploy workbook',
            category: 'Azure Monitor Community Resources',
            namespace: 'deploy_workbook',
            description: 'Deploy an Azure Monitor Community workbook to Azure.',
            operations: [
                {
                    title: 'Deploy workbook',
                    examples: [
                        { label: 'Deploy VM workbook', prompt: 'Deploy the Virtual Machines At-Scale workbook to my-rg in eastus' }
                    ]
                }
            ]
        },
        {
            slug: 'monitor-deploy-query',
            display_name: 'Azure Monitor Community 路 Deploy query',
            category: 'Azure Monitor Community Resources',
            namespace: 'deploy_query',
            description: 'Deploy a KQL query as a saved search in Log Analytics.',
            operations: [
                {
                    title: 'Deploy query',
                    examples: [
                        { label: 'Deploy Container Apps query', prompt: 'Deploy the Container Apps console logs query to my workspace' }
                    ]
                }
            ]
        },
        {
            slug: 'monitor-deploy-alert',
            display_name: 'Azure Monitor Community 路 Deploy alert',
            category: 'Azure Monitor Community Resources',
            namespace: 'deploy_alert',
            description: 'Deploy a KQL alert rule as a scheduled query alert.',
            operations: [
                {
                    title: 'Deploy alert',
                    examples: [
                        { label: 'Deploy high CPU alert', prompt: 'Deploy the high CPU alert for Container Apps' }
                    ]
                }
            ]
        },
        // ======================================================================
        // SRE MCP Server
        // ======================================================================
        {
            slug: 'sre-capabilities',
            display_name: 'Azure SRE 路 Capabilities',
            category: 'SRE MCP Server',
            namespace: 'describe_capabilities',
            description: 'Get comprehensive overview of SRE Agent capabilities and features.',
            operations: [
                {
                    title: 'Describe capabilities',
                    examples: [
                        { label: 'What can you help with?', prompt: 'What can you help me with as an agent?' },
                        { label: 'Show capabilities', prompt: 'What are your key capabilities?' },
                        { label: 'Supported services', prompt: 'Which Azure services do you support?' },
                        { label: 'Getting started', prompt: 'How do I get started with SRE Agent?' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-prompt-examples',
            display_name: 'Azure SRE 路 Prompt examples',
            category: 'SRE MCP Server',
            namespace: 'get_prompt_examples',
            description: 'Get example prompts for specific Azure service categories.',
            operations: [
                {
                    title: 'Get prompt examples',
                    examples: [
                        { label: 'App Service examples', prompt: 'Show me example prompts for App Service' },
                        { label: 'Container Apps examples', prompt: 'Show me example prompts for Container Apps' },
                        { label: 'AKS examples', prompt: 'Show me example prompts for AKS' },
                        { label: 'All examples', prompt: 'Show me all prompt examples' }
                    ]
                }
            ]
        },
        // --- Resource Configuration Discovery ---
        {
            slug: 'sre-query-app-service',
            display_name: 'Azure SRE 路 Query App Service',
            category: 'SRE MCP Server',
            namespace: 'query_app_service_configuration',
            description: 'Query App Service configuration across multiple web apps with filtering.',
            operations: [
                {
                    title: 'Query App Services',
                    examples: [
                        { label: 'List all web apps', prompt: 'List all my web apps' },
                        { label: 'Linux vs Windows', prompt: 'Which apps are hosted on Linux versus Windows in my environment?' },
                        { label: 'Deprecated runtimes', prompt: 'Are any of my web apps still running on deprecated or unsupported runtime versions?' },
                        { label: 'ARR affinity', prompt: 'Do any apps in my subscription have ARR affinity enabled?' },
                        { label: 'Health checks', prompt: 'Which apps have health checks enabled, and what are their probe paths?' },
                        { label: 'Diagnostic logging', prompt: 'Which apps have diagnostic logging turned on?' },
                        { label: 'Specific runtime', prompt: 'Show me all web apps that use the .NET 6 runtime' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-query-container-apps',
            display_name: 'Azure SRE 路 Query Container Apps',
            category: 'SRE MCP Server',
            namespace: 'query_container_app_configuration',
            description: 'Query Container Apps configuration with filtering by Dapr, ingress, autoscaling.',
            operations: [
                {
                    title: 'Query Container Apps',
                    examples: [
                        { label: 'List all container apps', prompt: 'List all my container apps' },
                        { label: 'Dapr enabled', prompt: 'Which apps have Dapr enabled?' },
                        { label: 'Container images', prompt: 'What container images are used by each of my container apps?' },
                        { label: 'Autoscaling', prompt: 'Which of my container apps has autoscaling enabled?' },
                        { label: 'Public ingress', prompt: 'Show me all apps with public ingress enabled' },
                        { label: 'Managed identities', prompt: 'Which of my container apps use managed identities?' },
                        { label: 'Multiple revisions', prompt: 'Which apps use multiple revisions at once?' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-query-aks',
            display_name: 'Azure SRE 路 Query AKS',
            category: 'SRE MCP Server',
            namespace: 'query_aks_configuration',
            description: 'Query AKS cluster configuration with filtering by K8s version, autoscaling, RBAC.',
            operations: [
                {
                    title: 'Query AKS Clusters',
                    examples: [
                        { label: 'K8s version', prompt: 'What version of Kubernetes is my cluster running?' },
                        { label: 'Autoscaling', prompt: 'Which node pools are configured for my AKS cluster?' },
                        { label: 'Pod count', prompt: 'How many pods are currently running in my cluster?' },
                        { label: 'Failed workloads', prompt: 'Which workloads are in a crash loop or failed state?' },
                        { label: 'Pending pods', prompt: 'Do I have any pending or unscheduled pods?' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-query-apim',
            display_name: 'Azure SRE 路 Query APIM',
            category: 'SRE MCP Server',
            namespace: 'query_apim_configuration',
            description: 'Query API Management configuration with filtering by SKU, VNet, managed identity.',
            operations: [
                {
                    title: 'Query APIM Instances',
                    examples: [
                        { label: 'Show APIM instances', prompt: 'Can you show me my API Management instances?' },
                        { label: 'VNet integration', prompt: 'Which APIM instances are connected to a virtual network?' },
                        { label: 'Managed identities', prompt: 'Which APIM instances use managed identities?' }
                    ]
                }
            ]
        },
        // --- Health Checks & Diagnostics ---
        {
            slug: 'sre-check-resource-health',
            display_name: 'Azure SRE 路 Check resource health',
            category: 'SRE MCP Server',
            namespace: 'check_resource_health',
            description: 'Check health status of an Azure resource using Resource Health API.',
            operations: [
                {
                    title: 'Check resource health',
                    examples: [
                        { label: 'Check VM health', prompt: 'What is the health status of my VM named web-vm-01?' },
                        { label: 'Check SQL health', prompt: 'Check the health of my SQL database' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-check-container-app',
            display_name: 'Azure SRE 路 Check Container App',
            category: 'SRE MCP Server',
            namespace: 'check_container_app_health',
            description: 'Check Container App health with replica status and ingress configuration.',
            operations: [
                {
                    title: 'Check Container App',
                    examples: [
                        { label: 'Ingress config', prompt: 'What is the ingress configuration for my container app?' },
                        { label: 'Active revision', prompt: 'Which revision of my container app is currently active?' },
                        { label: 'Activation failed', prompt: 'My container app is stuck in an activation failed state. Investigate for me' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-check-aks-cluster',
            display_name: 'Azure SRE 路 Check AKS Cluster',
            category: 'SRE MCP Server',
            namespace: 'check_aks_cluster_health',
            description: 'Check AKS cluster health with node and pod status analysis.',
            operations: [
                {
                    title: 'Check AKS health',
                    examples: [
                        { label: 'OOM condition', prompt: 'Is an OOM condition in my deployment?' },
                        { label: 'Resource limits', prompt: 'Analyze requests and limits in my namespace' },
                        { label: 'Deployment down', prompt: 'Why is my deployment down?' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-diagnose-app-service',
            display_name: 'Azure SRE 路 Diagnose App Service',
            category: 'SRE MCP Server',
            namespace: 'diagnose_app_service',
            description: 'Comprehensive App Service diagnostics including deployment logs and HTTP errors.',
            operations: [
                {
                    title: 'Diagnose App Service',
                    examples: [
                        { label: 'App availability', prompt: 'Can you analyze my app\'s availability over the last 24 hours?' },
                        { label: 'Slow endpoints', prompt: 'Give me slow endpoints for my APIs' },
                        { label: 'Timeouts', prompt: 'Why is my web app timed out?' },
                        { label: '500 errors', prompt: 'Why is my web app throwing 500 errors?' },
                        { label: 'App down', prompt: 'My web app is down. Can you analyze it?' },
                        { label: 'Not loading', prompt: 'My web app is stuck and isn\'t loading. Investigate for me' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-diagnose-apim',
            display_name: 'Azure SRE 路 Diagnose APIM',
            category: 'SRE MCP Server',
            namespace: 'diagnose_apim',
            description: 'Comprehensive APIM diagnostics including backend health and policy validation.',
            operations: [
                {
                    title: 'Diagnose APIM',
                    examples: [
                        { label: '500 errors', prompt: 'Why am I getting 500 errors in my API Management instance?' },
                        { label: 'API failures', prompt: 'Can you help me figure out why requests to our API are failing?' },
                        { label: 'Recent changes', prompt: 'Show me recent changes to our API Management instance' },
                        { label: 'Performance', prompt: 'Why is my API Management instance slow?' },
                        { label: 'Failure logs', prompt: 'Can you show me the recent failure logs for my API Management instance?' },
                        { label: 'Failure rate', prompt: 'What\'s the failure rate for my API operations in my API Management instance?' }
                    ]
                }
            ]
        },
        // --- Incident Response ---
        {
            slug: 'sre-triage-incident',
            display_name: 'Azure SRE 路 Triage incident',
            category: 'SRE MCP Server',
            namespace: 'triage_incident',
            description: 'Analyze an incident with log correlation and root cause investigation.',
            operations: [
                {
                    title: 'Triage incident',
                    examples: [
                        { label: 'Container App down', prompt: 'My container app is down. Can you analyze it?' },
                        { label: 'Timeout errors', prompt: 'Why is my container app timed out?' },
                        { label: '500 errors', prompt: 'Why is my container app throwing 500 errors?' },
                        { label: 'Not loading', prompt: 'My container app is stuck and isn\'t loading. Investigate for me' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-get-diagnostic-logs',
            display_name: 'Azure SRE 路 Get diagnostic logs',
            category: 'SRE MCP Server',
            namespace: 'get_diagnostic_logs',
            description: 'Retrieve diagnostic logs from Log Analytics for a resource.',
            operations: [
                {
                    title: 'Get diagnostic logs',
                    examples: [
                        { label: 'Get Container App logs', prompt: 'Show me the diagnostic logs for my Container App in the last 24 hours' },
                        { label: 'Get error logs', prompt: 'Retrieve error logs from my resource for the past 6 hours' }
                    ]
                }
            ]
        },
        // --- Performance Monitoring ---
        {
            slug: 'sre-get-performance-metrics',
            display_name: 'Azure SRE 路 Get performance metrics',
            category: 'SRE MCP Server',
            namespace: 'get_performance_metrics',
            description: 'Retrieve performance metrics (CPU, memory, requests) for a resource.',
            operations: [
                {
                    title: 'Get performance metrics',
                    examples: [
                        { label: 'CPU and memory', prompt: 'What\'s the CPU and memory utilization of my app?' },
                        { label: 'Memory utilization', prompt: 'Show me a visualization of memory utilization percentage for my container app for last week' },
                        { label: 'CPU utilization', prompt: 'Show me a visualization of CPU utilization percentage for my container app for last week' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-identify-bottlenecks',
            display_name: 'Azure SRE 路 Identify bottlenecks',
            category: 'SRE MCP Server',
            namespace: 'identify_bottlenecks',
            description: 'Analyze performance metrics to identify resource bottlenecks.',
            operations: [
                {
                    title: 'Identify bottlenecks',
                    examples: [
                        { label: 'Find bottlenecks', prompt: 'Analyze my Container App for performance bottlenecks' },
                        { label: 'Why slow?', prompt: 'What is causing my app to be slow?' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-search-logs-by-error',
            display_name: 'Azure SRE 路 Search logs by error',
            category: 'SRE MCP Server',
            namespace: 'search_logs_by_error',
            description: 'Search diagnostic logs for specific error messages.',
            operations: [
                {
                    title: 'Search logs',
                    examples: [
                        { label: 'Find OutOfMemory errors', prompt: 'Search logs for OutOfMemory errors in my Container App' },
                        { label: 'Find 500 errors', prompt: 'Show me all HTTP 500 errors in the logs' }
                    ]
                }
            ]
        },
        // --- Remediation & Notifications ---
        {
            slug: 'sre-plan-remediation',
            display_name: 'Azure SRE 路 Plan remediation',
            category: 'SRE MCP Server',
            namespace: 'plan_remediation',
            description: 'Generate a remediation plan for resource issues.',
            operations: [
                {
                    title: 'Plan remediation',
                    examples: [
                        { label: 'Plan restart', prompt: 'Create a plan to safely restart my Container App' },
                        { label: 'Plan scaling', prompt: 'What is the best way to scale up my app?' }
                    ]
                }
            ]
        },
        {
            slug: 'sre-send-teams-alert',
            display_name: 'Azure SRE 路 Send Teams alert',
            category: 'SRE MCP Server',
            namespace: 'send_teams_alert',
            description: 'Send a critical incident alert to Microsoft Teams channel.',
            operations: [
                {
                    title: 'Send Teams alert',
                    examples: [
                        { label: 'Alert on-call team', prompt: 'Send an alert to Teams about the critical Container App outage' }
                    ]
                }
            ]
        },
        // ======================================================================
        // Log Analytics Inventory
        // ======================================================================
        {
            slug: 'inventory-get-os-summary',
            display_name: 'Log Analytics Inventory 路 Get OS summary',
            category: 'Log Analytics Inventory',
            namespace: 'law_get_os_summary',
            description: 'Get a summary of operating systems from Log Analytics inventory.',
            operations: [
                {
                    title: 'Get OS summary',
                    examples: [
                        { label: 'Show OS distribution', prompt: 'What operating systems are in my environment?' },
                        { label: 'Count by OS', prompt: 'Show me a summary of OS types and counts' }
                    ]
                }
            ]
        },
        {
            slug: 'inventory-get-os-vendor-summary',
            display_name: 'Log Analytics Inventory 路 Get OS vendor summary',
            category: 'Log Analytics Inventory',
            namespace: 'law_get_os_vendor_summary',
            description: 'Get OS inventory grouped by vendor (Microsoft, Red Hat, Ubuntu, etc.).',
            operations: [
                {
                    title: 'Get vendor summary',
                    examples: [
                        { label: 'Group by vendor', prompt: 'Show me OS inventory grouped by vendor' },
                        { label: 'Count Windows vs Linux', prompt: 'How many Windows vs Linux machines do I have?' }
                    ]
                }
            ]
        },
        {
            slug: 'inventory-get-os-inventory',
            display_name: 'Log Analytics Inventory 路 Get OS inventory',
            category: 'Log Analytics Inventory',
            namespace: 'law_get_os_inventory',
            description: 'Get detailed OS inventory with computer names, versions, and editions.',
            operations: [
                {
                    title: 'Get OS inventory',
                    examples: [
                        { label: 'List all machines', prompt: 'Show me all computers with OS details' },
                        { label: 'Filter by OS type', prompt: 'List all Ubuntu machines in my inventory' }
                    ]
                }
            ]
        },
        {
            slug: 'inventory-get-software-inventory',
            display_name: 'Log Analytics Inventory 路 Get software inventory',
            category: 'Log Analytics Inventory',
            namespace: 'law_get_software_inventory',
            description: 'Get installed software inventory from Log Analytics.',
            operations: [
                {
                    title: 'Get software inventory',
                    examples: [
                        { label: 'List installed software', prompt: 'What software is installed across my machines?' },
                        { label: 'Find specific software', prompt: 'Which machines have SQL Server installed?' }
                    ]
                }
            ]
        },
        {
            slug: 'inventory-get-top-software',
            display_name: 'Log Analytics Inventory 路 Get top software',
            category: 'Log Analytics Inventory',
            namespace: 'law_get_top_software_packages',
            description: 'Get the most commonly installed software packages.',
            operations: [
                {
                    title: 'Get top software',
                    examples: [
                        { label: 'Most common software', prompt: 'What are the top 10 most installed software packages?' },
                        { label: 'Popular applications', prompt: 'Show me the most common applications' }
                    ]
                }
            ]
        },
        // ======================================================================
        // Operating System EOL
        // ======================================================================
        {
            slug: 'os-eol-lookup',
            display_name: 'OS EOL 路 Lookup single OS',
            category: 'Operating System EOL',
            namespace: 'os_eol_lookup',
            description: 'Check end-of-life status for a single operating system.',
            operations: [
                {
                    title: 'Lookup OS EOL',
                    examples: [
                        { label: 'Check Windows Server 2016', prompt: 'What is the EOL date for Windows Server 2016?' },
                        { label: 'Check Ubuntu 20.04', prompt: 'Is Ubuntu 20.04 still supported?' },
                        { label: 'Check Red Hat 7', prompt: 'When does Red Hat Enterprise Linux 7 reach end of life?' }
                    ]
                }
            ]
        },
        {
            slug: 'os-eol-bulk-lookup',
            display_name: 'OS EOL 路 Bulk lookup',
            category: 'Operating System EOL',
            namespace: 'os_eol_bulk_lookup',
            description: 'Check EOL status for multiple operating systems at once.',
            operations: [
                {
                    title: 'Bulk EOL lookup',
                    examples: [
                        { label: 'Check inventory for EOL', prompt: 'Check all OS in my inventory for end-of-life status' },
                        { label: 'Bulk EOL analysis', prompt: 'Which operating systems in my environment are end-of-life?' }
                    ]
                }
            ]
        }
    ];

    const microsoftLearnToolMetadata = [
        {
            slug: 'microsoft-learn-search-learning-paths',
            display_name: 'Microsoft Learn 路 Search learning paths',
            category: 'Microsoft Learn',
            namespace: 'microsoft_learn.searchLearningPaths',
            description: 'Search Microsoft Learn for learning paths aligned to certification exams or keywords.',
            doc_url: 'https://learn.microsoft.com/en-us/training/browse/',
            operations: [
                {
                    title: 'Search learning paths',
                    description: 'Find Microsoft Learn learning paths by certification exam, Azure role, or topic keyword.',
                    parameters: [
                        {
                            name: 'Query',
                            required: true,
                            description: 'Keyword, certification exam number, or topic to match across Microsoft Learn learning paths.'
                        },
                        {
                            name: 'Role',
                            required: false,
                            description: 'Optional Azure job role focus, such as administrator, developer, or security-engineer.'
                        },
                        {
                            name: 'Language',
                            required: false,
                            description: 'Preferred content language code like en or fr for localized learning paths.'
                        }
                    ],
                    examples: [
                        {
                            label: 'Exam aligned learning paths',
                            prompt: 'Find Microsoft Learn learning paths to prepare for the <exam-number> exam using <query> for Query and <language> for Language.',
                            original_prompt: 'Find Microsoft Learn learning paths to prepare for the AZ-104 exam',
                            parameter_placeholders: ['<query>', '<language>']
                        },
                        {
                            label: 'Role focused learning paths',
                            prompt: 'Show learning paths for <azure-role> responsibilities using <query> for Query and <role> for Role.',
                            original_prompt: 'Show learning paths for Azure administrator responsibilities',
                            parameter_placeholders: ['<query>', '<role>']
                        },
                        {
                            label: 'Topic keyword search',
                            prompt: 'Search for learning paths that cover <topic> skills using <query> for Query.',
                            original_prompt: 'Search for learning paths that cover Azure monitoring skills',
                            parameter_placeholders: ['<query>']
                        }
                    ]
                }
            ]
        },
        {
            slug: 'microsoft-learn-list-modules-by-topic',
            display_name: 'Microsoft Learn 路 List modules by topic',
            category: 'Microsoft Learn',
            namespace: 'microsoft_learn.listModulesByTopic',
            description: 'List Microsoft Learn modules for a topic with duration and unit counts.',
            doc_url: 'https://learn.microsoft.com/en-us/training/browse/',
            operations: [
                {
                    title: 'List modules by topic',
                    description: 'Discover Microsoft Learn modules grouped by topic, difficulty, and estimated duration.',
                    parameters: [
                        {
                            name: 'Topic',
                            required: true,
                            description: 'Microsoft Learn topic or product focus, such as Azure networking or AI services.'
                        },
                        {
                            name: 'Level',
                            required: false,
                            description: 'Optional difficulty filter like beginner, intermediate, or advanced.'
                        },
                        {
                            name: 'Language',
                            required: false,
                            description: 'Preferred content language code like en or es for localized modules.'
                        }
                    ],
                    examples: [
                        {
                            label: 'Beginner modules for a topic',
                            prompt: 'List beginner modules about <topic> using <topic> for Topic and <level> for Level.',
                            original_prompt: 'List beginner modules about Azure networking',
                            parameter_placeholders: ['<topic>', '<level>']
                        },
                        {
                            label: 'Localized topic modules',
                            prompt: 'Show modules covering <topic> concepts using <topic> for Topic and <language> for Language.',
                            original_prompt: 'Show modules covering Azure OpenAI concepts in Japanese',
                            parameter_placeholders: ['<topic>', '<language>']
                        },
                        {
                            label: 'Topic catalog overview',
                            prompt: 'List Microsoft Learn modules for <topic> using <topic> for Topic.',
                            original_prompt: 'List Microsoft Learn modules for Azure governance',
                            parameter_placeholders: ['<topic>']
                        }
                    ]
                }
            ]
        },
        {
            slug: 'microsoft-learn-get-module-outline',
            display_name: 'Microsoft Learn 路 Get module outline',
            category: 'Microsoft Learn',
            namespace: 'microsoft_learn.getModuleOutline',
            description: 'Retrieve the unit-by-unit outline for a Microsoft Learn module.',
            doc_url: 'https://learn.microsoft.com/en-us/training/browse/',
            operations: [
                {
                    title: 'Get module outline',
                    description: 'Retrieve the unit names, durations, and prerequisites for a Microsoft Learn module.',
                    parameters: [
                        {
                            name: 'Module ID',
                            required: true,
                            description: 'The Microsoft Learn module ID or URL slug, such as learn.az-104.configure-virtual-networking.'
                        },
                        {
                            name: 'Language',
                            required: false,
                            description: 'Preferred content language code like en or de for localized module outlines.'
                        }
                    ],
                    examples: [
                        {
                            label: 'Module outline by slug',
                            prompt: 'Show the outline for the <module-slug> module using <module-slug> for Module ID.',
                            original_prompt: 'Show the outline for the learn.az-104.configure-virtual-networking module',
                            parameter_placeholders: ['<module-slug>']
                        },
                        {
                            label: 'Localized module outline',
                            prompt: 'Get the <module-slug> module outline in <language> using <module-slug> for Module ID and <language> for Language.',
                            original_prompt: 'Get the learn.azure.well-architected module outline in Spanish',
                            parameter_placeholders: ['<module-slug>', '<language>']
                        }
                    ]
                }
            ]
        },
        {
            slug: 'microsoft-learn-recommend-content-for-role',
            display_name: 'Microsoft Learn 路 Recommend content for role',
            category: 'Microsoft Learn',
            namespace: 'microsoft_learn.recommendContentForRole',
            description: 'Recommend Microsoft Learn content for a specific Azure job role and prerequisite knowledge.',
            doc_url: 'https://learn.microsoft.com/en-us/training/browse/',
            operations: [
                {
                    title: 'Recommend content for role',
                    description: 'Get personalized module and learning path recommendations for an Azure job role.',
                    parameters: [
                        {
                            name: 'Role',
                            required: true,
                            description: 'Target Azure or cloud job role such as administrator, solutions-architect, or developer.'
                        },
                        {
                            name: 'Experience level',
                            required: false,
                            description: 'Optional experience band like beginner, intermediate, or advanced to tune recommendations.'
                        },
                        {
                            name: 'Focus area',
                            required: false,
                            description: 'Optional specialization focus like security, networking, or data platform.'
                        }
                    ],
                    examples: [
                        {
                            label: 'Role based recommendations',
                            prompt: 'Recommend Microsoft Learn content for <role> responsibilities using <role> for Role.',
                            original_prompt: 'Recommend Microsoft Learn content for Azure security engineer responsibilities',
                            parameter_placeholders: ['<role>']
                        },
                        {
                            label: 'Experience tuned recommendations',
                            prompt: 'Suggest intermediate learning for <role> focusing on <focus-area> using <role> for Role, <experience-level> for Experience level, and <focus-area> for Focus area.',
                            original_prompt: 'Suggest intermediate learning for Azure developer focusing on AI integration',
                            parameter_placeholders: ['<role>', '<experience-level>', '<focus-area>']
                        }
                    ]
                }
            ]
        }
    ];

    // Tool metadata catalog populated from documentation crawler
    let metadataTools = [];
    let metadataBySlug = {};
    let toolsByServer = {}; // Track tools by server source

    async function loadToolMetadata() {
        const serverSelector = document.getElementById('server-selector');
        const selector = document.getElementById('tool-selector');
        const exampleSelector = document.getElementById('example-selector');
        try {
            const response = await fetch('/static/data/azure_mcp_tool_metadata.json', { cache: 'no-store' });
            const payload = await response.json();
            metadataTools = Array.isArray(payload.tools) ? payload.tools : [];
            metadataBySlug = {};
            toolsByServer = {}; // Reset

            metadataTools.forEach(tool => {
                if (tool && tool.slug) {
                    metadataBySlug[tool.slug] = tool;

                    // Extract server source from namespace or category
                    const source = getToolSource(tool);
                    if (!toolsByServer[source]) {
                        toolsByServer[source] = [];
                    }
                    toolsByServer[source].push(tool);
                }
            });

            lazyLoadedToolMetadata.forEach(tool => {
                if (!tool || !tool.slug) {
                    return;
                }
                if (!metadataBySlug[tool.slug]) {
                    metadataTools.push(tool);
                    metadataBySlug[tool.slug] = tool;

                    const source = getToolSource(tool);
                    if (!toolsByServer[source]) {
                        toolsByServer[source] = [];
                    }
                    toolsByServer[source].push(tool);
                }
            });

            microsoftLearnToolMetadata.forEach(tool => {
                if (tool && tool.slug && !metadataBySlug[tool.slug]) {
                    metadataTools.push(tool);
                    metadataBySlug[tool.slug] = tool;

                    const source = getToolSource(tool);
                    if (!toolsByServer[source]) {
                        toolsByServer[source] = [];
                    }
                    toolsByServer[source].push(tool);
                }
            });

            populateServerSelector();

            if (selector) {
                selector.disabled = true;
                selector.innerHTML = '<option value="">Select a server first...</option>';
            }
            if (exampleSelector) {
                exampleSelector.disabled = true;
                exampleSelector.innerHTML = '<option value="">Select a tool first...</option>';
            }
        } catch (error) {
            console.error('Failed to load tool metadata:', error);
            if (serverSelector) {
                serverSelector.disabled = true;
                serverSelector.innerHTML = '<option value="">Failed to load servers</option>';
            }
            if (selector) {
                selector.disabled = true;
                selector.innerHTML = '<option value="">Failed to load tools</option>';
            }
        }
    }

    function getToolSource(tool) {
        // Determine server source from tool namespace or category
        if (tool.namespace) {
            if (tool.namespace.startsWith('azure_cli')) return 'azure_cli';
            if (tool.namespace.startsWith('microsoft_learn')) return 'microsoft_learn';
            if (tool.namespace.startsWith('inventory')) return 'inventory';
            if (tool.namespace.startsWith('os_eol')) return 'os_eol';
            if (tool.namespace.startsWith('monitor')) return 'monitor';
            if (tool.namespace.startsWith('sre_') || tool.namespace.includes('sre')) return 'sre';
        }

        // Check tool name if namespace doesn't help
        if (tool.name) {
            if (tool.name.startsWith('sre_') || tool.name.includes('sre')) return 'sre';
        }

        // Check category
        if (tool.category) {
            if (tool.category.includes('Microsoft Learn')) return 'microsoft_learn';
            if (tool.category.includes('Agentic Utilities')) return 'azure_cli';
            if (tool.category.includes('Inventory')) return 'inventory';
            if (tool.category.includes('Monitor')) return 'monitor';
            if (tool.category.includes('SRE')) return 'sre';
        }

        // Default to azure
        return 'azure';
    }

    function populateServerSelector() {
        const serverSelector = document.getElementById('server-selector');
        if (!serverSelector) {
            return;
        }

        serverSelector.innerHTML = '<option value="">Select a server...</option>';

        // Get all available servers (from toolsByServer and runtime tools)
        const allServers = new Set(Object.keys(toolsByServer));

        // Add servers from runtime tools
        runtimeAzureTools.forEach(tool => {
            const source = tool.source || 'azure';
            allServers.add(source);
        });

        // Sort and create options with friendly names
        const sortedServers = Array.from(allServers).sort((a, b) => {
            const nameA = mcpSourceDisplayNames[a] || a;
            const nameB = mcpSourceDisplayNames[b] || b;
            return nameA.localeCompare(nameB);
        });

        sortedServers.forEach(server => {
            const option = document.createElement('option');
            option.value = server;
            option.textContent = mcpSourceDisplayNames[server] || server.replace(/_/g, ' ');
            serverSelector.appendChild(option);
        });

        serverSelector.disabled = sortedServers.length === 0;
    }

    function updateToolsByServer() {
        const serverSelector = document.getElementById('server-selector');
        const toolSelector = document.getElementById('tool-selector');
        const exampleSelector = document.getElementById('example-selector');
        const chatInput = document.getElementById('chat-input');
        const docLink = document.getElementById('tool-doc-link');
        const parameterHints = document.getElementById('tool-parameter-hints');

        if (!serverSelector || !toolSelector) {
            return;
        }

        const selectedServer = serverSelector.value;

        // Reset tool selector
        if (docLink) {
            docLink.innerHTML = '';
        }
        if (parameterHints) {
            parameterHints.innerHTML = '<div class="text-muted small">Select a server to see available tools.</div>';
        }
        if (exampleSelector) {
            exampleSelector.disabled = true;
            exampleSelector.innerHTML = '<option value="">Select a tool first...</option>';
        }
        if (chatInput) {
            chatInput.value = '';
        }

        if (!selectedServer) {
            toolSelector.disabled = true;
            toolSelector.innerHTML = '<option value="">Select a server first...</option>';
            return;
        }

        // Get tools for selected server (from metadata and runtime)
        const serverTools = [];

        // Add from metadata
        if (toolsByServer[selectedServer]) {
            serverTools.push(...toolsByServer[selectedServer]);
        }

        // Add from runtime tools (may have examples in metadata)
        runtimeAzureTools.forEach(tool => {
            const source = tool.source || 'azure';
            if (source === selectedServer) {
                // Check if we already have metadata for this tool
                const hasMetadata = serverTools.some(t => t.namespace === tool.name);
                if (!hasMetadata) {
                    // Create basic metadata entry
                    serverTools.push({
                        slug: tool.name.replace(/_/g, '-'),
                        display_name: tool.name.replace(/_/g, ' '),
                        namespace: tool.name,
                        description: tool.description || 'No description available',
                        category: mcpSourceDisplayNames[source] || source
                    });
                }
            }
        });

        if (serverTools.length === 0) {
            toolSelector.disabled = true;
            toolSelector.innerHTML = '<option value="">No tools available for this server</option>';
            return;
        }

        // Populate tool selector
        populateToolSelectorForServer(serverTools);
    }

    function populateToolSelectorForServer(tools) {
        const selector = document.getElementById('tool-selector');
        if (!selector) {
            return;
        }

        selector.innerHTML = '<option value="">Select a tool...</option>';

        if (!tools || tools.length === 0) {
            selector.disabled = true;
            return;
        }

        // Group by category
        const grouped = new Map();
        tools.forEach(tool => {
            const category = (tool.category || 'Other').trim() || 'Other';
            if (!grouped.has(category)) {
                grouped.set(category, []);
            }
            grouped.get(category).push(tool);
        });

        const sortedCategories = Array.from(grouped.keys()).sort((a, b) => a.localeCompare(b));
        sortedCategories.forEach(category => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = category;
            grouped.get(category)
                .sort((a, b) => a.display_name.localeCompare(b.display_name))
                .forEach(tool => {
                    const option = document.createElement('option');
                    option.value = tool.slug;
                    option.textContent = tool.display_name;
                    optgroup.appendChild(option);
                });
            selector.appendChild(optgroup);
        });

        selector.disabled = false;
    }

    function collectExamples(tool) {
        if (!tool) {
            return [];
        }

        const examples = [];

        if (Array.isArray(tool.operations) && tool.operations.length) {
            tool.operations.forEach(operation => {
                if (!operation || !Array.isArray(operation.examples)) {
                    return;
                }
                operation.examples.forEach(example => {
                    if (!example || !example.prompt) {
                        return;
                    }
                    examples.push({
                        label: example.label || example.prompt,
                        prompt: example.prompt,
                        operationTitle: operation.title || null,
                        parameters: Array.isArray(operation.parameters) ? operation.parameters : []
                    });
                });
            });
        }

        if (!examples.length && Array.isArray(tool.examples)) {
            const fallbackParams = Array.isArray(tool.parameters) ? tool.parameters : [];
            tool.examples.forEach(example => {
                if (!example || !example.prompt) {
                    return;
                }
                examples.push({
                    label: example.label || example.prompt,
                    prompt: example.prompt,
                    operationTitle: null,
                    parameters: fallbackParams
                });
            });
        }

        return examples;
    }

    function collectParameters(tool, example) {
        if (!example) {
            return [];
        }

        const seen = new Set();
        const unique = [];

        const addParams = (params) => {
            if (!Array.isArray(params)) {
                return;
            }
            params.forEach(param => {
                if (!param || !param.name) {
                    return;
                }
                const key = String(param.name).toLowerCase();
                if (seen.has(key)) {
                    return;
                }
                seen.add(key);
                unique.push(param);
            });
        };

        addParams(example.parameters);

        if (!unique.length && example.operationTitle && Array.isArray(tool.operations)) {
            const operation = tool.operations.find(op => op && op.title === example.operationTitle);
            if (operation) {
                addParams(operation.parameters);
            }
        }

        return unique;
    }

    function buildParameterHints(tool, example) {
        const params = collectParameters(tool, example);
        if (!params.length) {
            return '';
        }

        const heading = example && example.operationTitle
            ? `Parameters 路 ${escapeHtml(example.operationTitle)}`
            : 'Parameters';

        const items = params.map(param => {
            const requiredBadge = param.required ? '<span class="text-danger fw-semibold ms-2">required</span>' : '';
            const description = param.description ? ` - ${escapeHtml(param.description)}` : '';
            const options = Array.isArray(param.options) && param.options.length
                ? ` <span class="text-muted">(Options: ${param.options.map(option => escapeHtml(option)).join(', ')})</span>`
                : '';
            return `<li><code>${escapeHtml(param.name)}</code>${requiredBadge}${description}${options}</li>`;
        });

        return `<div class="alert alert-secondary mb-0"><strong>${heading}</strong><ul class="mb-0">${items.join('')}</ul></div>`;
    }

    function updateExamples() {
        const toolSelector = document.getElementById('tool-selector');
        const exampleSelector = document.getElementById('example-selector');
        const chatInput = document.getElementById('chat-input');
        const docLink = document.getElementById('tool-doc-link');
        const parameterHints = document.getElementById('tool-parameter-hints');

        if (!toolSelector || !exampleSelector) {
            return;
        }

        const selectedSlug = toolSelector.value;
        const metadata = selectedSlug ? metadataBySlug[selectedSlug] : null;

        if (docLink) {
            docLink.innerHTML = '';
            docLink.className = 'mt-2 small text-muted';
        }

        if (parameterHints) {
            parameterHints.innerHTML = '<div class="text-muted small">Select an example to see its documented parameters.</div>';
        }

        if (!metadata) {
            exampleSelector.disabled = true;
            exampleSelector.innerHTML = '<option value="">Select a tool first...</option>';
            if (chatInput) {
                chatInput.value = '';
            }
            return;
        }

        if (docLink) {
            const segments = [];
            if (metadata.description) {
                segments.push(escapeHtml(metadata.description));
            }
            if (Array.isArray(metadata.notes)) {
                metadata.notes.forEach(note => {
                    if (note) {
                        segments.push(`<span class="text-warning">${escapeHtml(note)}</span>`);
                    }
                });
            } else if (metadata.lazy_loaded) {
                segments.push('<span class="text-warning">Loads on first use  run a CLI example to register this tool.</span>');
            }
            if (metadata.doc_url) {
                segments.push(`<a href="${metadata.doc_url}" target="_blank" rel="noopener">View documentation</a>`);
            }

            docLink.innerHTML = segments.join(' 路 ') || '';
        }

        const examples = collectExamples(metadata);
        if (!examples.length) {
            exampleSelector.disabled = true;
            exampleSelector.innerHTML = '<option value="">No examples available for this tool yet.</option>';
            if (chatInput) {
                chatInput.value = '';
            }
            return;
        }

        exampleSelector.disabled = false;
        exampleSelector.innerHTML = '<option value="">Select an example...</option>';
        const exampleData = examples;

        exampleData.forEach((example, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = example.label;
            option.dataset.prompt = example.prompt;
            if (example.operationTitle) {
                option.dataset.operationTitle = example.operationTitle;
            }
            exampleSelector.appendChild(option);
        });

        exampleSelector.onchange = function() {
            const selectedOption = exampleSelector.selectedOptions[0];
            const rawValue = selectedOption ? selectedOption.value : '';
            const selectedIndex = rawValue === '' ? NaN : Number(rawValue);
            const selectedExample = Number.isInteger(selectedIndex) ? exampleData[selectedIndex] : null;

            if (selectedOption && selectedOption.dataset.prompt) {
                if (chatInput) {
                    chatInput.value = selectedOption.dataset.prompt;
                    chatInput.focus();
                }
            } else if (chatInput) {
                chatInput.value = '';
            }

            if (parameterHints) {
                if (selectedExample) {
                    parameterHints.innerHTML = buildParameterHints(metadata, selectedExample) || '<div class="text-muted small">No specific parameters documented for this example.</div>';
                } else {
                    parameterHints.innerHTML = '<div class="text-muted small">Select an example to see its documented parameters.</div>';
                }
            }
        };
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message) {
            return;
        }

        const sendBtn = document.getElementById('send-btn');
        const chatHistory = document.getElementById('chat-history');
        
        // Disable input while processing
        input.disabled = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Thinking...';

        // Clear welcome message if it's the first message
        if (chatHistory.querySelector('.text-muted.py-5')) {
            chatHistory.innerHTML = '';
        }
        
        // Add user message
        appendMessage('user', message);
        
        // Clear input
        input.value = '';
        
        try {
            const response = await fetch('/api/azure-mcp/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                const result = data.data[0];
                appendMessage('assistant', result.response);
                addAgentComm('synthesis', result.response || 'Response generated', {
                    strategy: 'direct-response'
                });
            } else {
                appendMessage('error', data.error || 'Failed to get response');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            appendMessage('error', `Error: ${error.message}`);
        } finally {
            // Re-enable input
            input.disabled = false;
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
            input.focus();
        }
    }

    function appendMessage(role, content) {
        const chatHistory = document.getElementById('chat-history');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}-message mb-3`;

        let icon = '';
        let roleLabel = 'Assistant';

        if (role === 'user') {
            icon = '<i class="fas fa-user me-2"></i>';
            roleLabel = 'You';
        } else if (role === 'assistant') {
            icon = '<i class="fas fa-robot me-2"></i>';
            roleLabel = 'Assistant';
        } else if (role === 'error') {
            icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
            roleLabel = 'Error';
        }

        const wrapper = document.createElement('div');
        wrapper.className = `chat-message-wrapper ${role}-card`;

        const header = document.createElement('div');
        header.className = `chat-message-header ${role}-header`;
        header.innerHTML = `${icon}${roleLabel}`;
        const body = document.createElement('div');
        body.className = 'chat-message-body';

        const { html, hasRichContent } = formatContent(content);

        if (hasRichContent) {
            body.classList.add('chat-html-content');
        } else {
            body.classList.add('chat-text-content');
        }

        body.innerHTML = html;
        deduplicateSequentialContent(body);

        wrapper.appendChild(header);
        wrapper.appendChild(body);
        messageDiv.appendChild(wrapper);

        chatHistory.appendChild(messageDiv);

        // Scroll to bottom
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function sanitizeHtml(html) {
        const template = document.createElement('template');
        template.innerHTML = html;

        const forbiddenTags = ['script', 'style', 'iframe', 'object', 'embed'];
        forbiddenTags.forEach(tag => {
            template.content.querySelectorAll(tag).forEach(node => node.remove());
        });

        template.content.querySelectorAll('*').forEach(node => {
            [...node.attributes].forEach(attr => {
                const name = attr.name.toLowerCase();
                if (name.startsWith('on') || name === 'formaction' || name === 'srcdoc') {
                    node.removeAttribute(attr.name);
                }
            });
        });

        return template.innerHTML;
    }

    function deduplicateSequentialContent(container) {
        const normalise = value => value.replace(/\s+/g, ' ').trim().toLowerCase();

        // Collect all seen signatures across the entire container to catch
        // non-consecutive duplicates as well as consecutive ones.
        const seenSignatures = new Set();

        let lastTableSignature = null;
        container.querySelectorAll('table').forEach(table => {
            const signature = normalise(table.textContent || '');
            if (signature && (signature === lastTableSignature || seenSignatures.has(signature))) {
                table.remove();
            } else if (signature) {
                lastTableSignature = signature;
                seenSignatures.add(signature);
            }
        });

        // Deduplicate identical lists (ul/ol)  consecutive or not
        let lastListSignature = null;
        container.querySelectorAll('ul, ol').forEach(list => {
            const signature = normalise(list.textContent || '');
            if (signature && (signature === lastListSignature || seenSignatures.has(signature))) {
                list.remove();
            } else if (signature) {
                lastListSignature = signature;
                seenSignatures.add(signature);
            }
        });

        // Deduplicate paragraphs, headings, divs  consecutive or not
        // Also catch near-duplicates where one is a substring of the other
        const paragraphSignatures = [];
        container.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6').forEach(node => {
            const signature = normalise(node.textContent || '');
            if (!signature) return;
            // Exact duplicate anywhere
            if (seenSignatures.has(signature)) {
                node.remove();
                return;
            }
            // Near-duplicate: check if this text is 80% contained in a previous paragraph
            let isNearDup = false;
            for (const prev of paragraphSignatures) {
                if (prev.includes(signature) || signature.includes(prev)) {
                    // One is a substring of the other  keep the longer one
                    if (signature.length <= prev.length) {
                        node.remove();
                        isNearDup = true;
                    }
                    break;
                }
            }
            if (!isNearDup) {
                seenSignatures.add(signature);
                paragraphSignatures.push(signature);
            }
        });
    }

    function buildStructuredHtml(text) {
        const container = document.createElement('div');
        const lines = text.split('\n');
        let index = 0;
        let hasRichContent = false;

        const isMetadataHeader = (line) => /^Auto-filled parameters:/i.test(line) || /^Suggested parameter values:/i.test(line);
        const isListLine = (line) => {
            const trimmed = line.trim();
            return /^[-*+]\s+/.test(trimmed) || /^\d+\.\s+/.test(trimmed);
        };
        const isSpecialBlockStart = (position) => {
            if (position >= lines.length) {
                return false;
            }
            const current = lines[position];
            if (!current || !current.trim()) {
                return false;
            }
            const trimmed = current.trim();
            if (trimmed.startsWith('```')) {
                return true;
            }
            if (isMetadataHeader(trimmed)) {
                return true;
            }
            return isListLine(trimmed);
        };

        const parseCodeBlock = (startIndex) => {
            let idx = startIndex + 1;
            const codeLines = [];
            while (idx < lines.length && !lines[idx].trim().startsWith('```')) {
                codeLines.push(lines[idx]);
                idx++;
            }
            if (idx < lines.length && lines[idx].trim().startsWith('```')) {
                idx++;
            }
            const pre = document.createElement('pre');
            pre.className = 'mcp-pre';
            const code = document.createElement('code');
            code.textContent = codeLines.join('\n');
            pre.appendChild(code);
            return { node: pre, nextIndex: idx };
        };

        const parseMetadataBlock = (startIndex) => {
            const headerLine = lines[startIndex].trim();
            if (!isMetadataHeader(headerLine)) {
                return null;
            }
            const isAutofill = /^Auto-filled parameters:/i.test(headerLine);
            let idx = startIndex + 1;
            const wrapper = document.createElement('div');
            wrapper.className = `mcp-meta ${isAutofill ? 'mcp-meta-autofill' : 'mcp-meta-suggestions'}`;
            const title = document.createElement('strong');
            title.textContent = headerLine.replace(/:$/, '');
            wrapper.appendChild(title);
            const list = document.createElement('ul');
            wrapper.appendChild(list);

            let consumed = false;
            let currentItem = null;

            while (idx < lines.length) {
                const rawLine = lines[idx];
                if (!rawLine.trim()) {
                    break;
                }

                if (isAutofill) {
                    const trimmed = rawLine.trim();
                    if (!trimmed.startsWith('-')) {
                        break;
                    }
                    consumed = true;
                    const entryText = trimmed.replace(/^-\s*/, '');
                    const parts = entryText.split(':');
                    const li = document.createElement('li');
                    if (parts.length > 1) {
                        const key = parts.shift();
                        const value = parts.join(':').trim();
                        const code = document.createElement('code');
                        code.textContent = (key || '').trim();
                        li.appendChild(code);
                        if (value) {
                            li.appendChild(document.createTextNode(`: ${value}`));
                        }
                    } else {
                        li.textContent = entryText;
                    }
                    list.appendChild(li);
                    idx++;
                    continue;
                }

                const primaryMatch = rawLine.trim();
                if (/^-\s+/.test(primaryMatch)) {
                    consumed = true;
                    const li = document.createElement('li');
                    const strong = document.createElement('strong');
                    strong.textContent = primaryMatch.replace(/^-\s*/, '').replace(/:$/, '');
                    li.appendChild(strong);
                    list.appendChild(li);
                    currentItem = li;
                    idx++;
                    continue;
                }

                if (/^\s{2,}-\s+/.test(rawLine)) {
                    if (!currentItem) {
                        idx++;
                        continue;
                    }
                    consumed = true;
                    let nested = currentItem.querySelector('ul');
                    if (!nested) {
                        nested = document.createElement('ul');
                        currentItem.appendChild(nested);
                    }
                    const nestedItem = document.createElement('li');
                    nestedItem.textContent = rawLine.trim().replace(/^-+\s*/, '');
                    nested.appendChild(nestedItem);
                    idx++;
                    continue;
                }

                break;
            }

            if (!consumed) {
                return null;
            }

            return { node: wrapper, nextIndex: idx };
        };

        const parseListBlock = (startIndex) => {
            const firstLine = lines[startIndex];
            if (!firstLine || !isListLine(firstLine)) {
                return null;
            }

            const isOrdered = /^\d+\.\s+/.test(firstLine.trim());
            const list = document.createElement(isOrdered ? 'ol' : 'ul');
            let idx = startIndex;

            while (idx < lines.length) {
                const line = lines[idx];
                if (!line.trim()) {
                    break;
                }
                if (!isListLine(line)) {
                    break;
                }
                const trimmed = line.trim();
                const itemText = isOrdered
                    ? trimmed.replace(/^\d+\.\s+/, '')
                    : trimmed.replace(/^[-*+]\s+/, '');
                const li = document.createElement('li');
                li.textContent = itemText;
                list.appendChild(li);
                idx++;
            }

            if (!list.children.length) {
                return null;
            }

            return { node: list, nextIndex: idx };
        };

        const parseParagraphBlock = (startIndex) => {
            let idx = startIndex;
            const collectedLines = [];

            while (idx < lines.length) {
                const line = lines[idx];
                if (!line.trim()) {
                    break;
                }
                if (idx !== startIndex && isSpecialBlockStart(idx)) {
                    break;
                }
                collectedLines.push(line);
                idx++;
            }

            if (!collectedLines.length) {
                return { node: document.createTextNode(''), nextIndex: idx, hasRichContent: false };
            }

            const joined = collectedLines.join('\n');
            const multiLine = collectedLines.length > 1;
            const hasIndentation = collectedLines.some(line => /^\s{2,}/.test(line));
            const looksJsonLike = /^\s*[\[{]/.test(collectedLines[0]);

            if (multiLine && (hasIndentation || looksJsonLike)) {
                const pre = document.createElement('pre');
                pre.className = 'mcp-pre';
                pre.textContent = joined;
                return { node: pre, nextIndex: idx, hasRichContent: true };
            }

            const paragraph = document.createElement('p');
            collectedLines.forEach((line, lineIndex) => {
                if (lineIndex > 0) {
                    paragraph.appendChild(document.createElement('br'));
                }
                paragraph.appendChild(document.createTextNode(line.trim()));
            });
            return { node: paragraph, nextIndex: idx, hasRichContent: false };
        };

        while (index < lines.length) {
            if (!lines[index].trim()) {
                index++;
                continue;
            }

            if (lines[index].trim().startsWith('```')) {
                const block = parseCodeBlock(index);
                container.appendChild(block.node);
                index = block.nextIndex;
                hasRichContent = true;
                continue;
            }

            const metadataBlock = parseMetadataBlock(index);
            if (metadataBlock) {
                container.appendChild(metadataBlock.node);
                index = metadataBlock.nextIndex;
                hasRichContent = true;
                continue;
            }

            const listBlock = parseListBlock(index);
            if (listBlock) {
                container.appendChild(listBlock.node);
                index = listBlock.nextIndex;
                hasRichContent = true;
                continue;
            }

            const paragraphBlock = parseParagraphBlock(index);
            container.appendChild(paragraphBlock.node);
            index = paragraphBlock.nextIndex;
            if (paragraphBlock.hasRichContent) {
                hasRichContent = true;
            }
        }

        return { html: container.innerHTML, hasRichContent };
    }

    function formatContent(text) {
        if (!text) {
            return { html: '', hasRichContent: false };
        }

        const trimmed = text.trim();
        if (!trimmed) {
            return { html: '', hasRichContent: false };
        }

        const containsHtml = /<\/?[a-z][\s\S]*>/i.test(trimmed);
        const isTrustedHtml = /<table|class=["']mcp-meta|<pre|<ul|<ol|<p[\s>]|<strong|<em|<h[1-6][\s>]|<a\s/.test(trimmed);

        if (containsHtml && isTrustedHtml) {
            return {
                html: sanitizeHtml(trimmed),
                hasRichContent: true
            };
        }

        const { html, hasRichContent } = buildStructuredHtml(trimmed);
        return {
            html: sanitizeHtml(html || `<p>${escapeHtml(trimmed)}</p>`),
            hasRichContent
        };
    }

    async function clearChat() {
        if (!confirm('Are you sure you want to clear the chat history?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/azure-mcp/chat/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                const chatHistory = document.getElementById('chat-history');
                chatHistory.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <p>Ask me anything about your Azure resources!</p>
                        <p class="small">Examples: "List my resource groups", "What compute resources do I have?", "Show me all VMs in East US"</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error clearing chat:', error);
            alert('Failed to clear chat: ' + error.message);
        }
    }

    // Agent Communication Functions
    let agentCommStartTime = null;
    let agentCommStats = {
        iterations: 0,
        toolCalls: 0,
        strategy: '-',
        duration: 0
    };

    function toggleAgentComms() {
        const section = document.getElementById('agent-comms-section');
        const btn = document.getElementById('toggle-comms-btn');
        
        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide';
        } else {
            section.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-eye me-1"></i>Show';
        }
    }

    function clearAgentComms() {
        if (window.AgentComm && typeof window.AgentComm.clearAllCommunications === 'function') {
            window.AgentComm.clearAllCommunications('communicationsStream');
        } else if (window.agentCommHandler && typeof window.agentCommHandler.clearAllCommunications === 'function') {
            window.agentCommHandler.clearAllCommunications();
        }
        
        // Reset stats
        agentCommStats = {
            iterations: 0,
            toolCalls: 0,
            strategy: '-',
            duration: 0
        };
        updateAgentStats();

        const statsContainer = document.getElementById('reasoning-stats');
        if (statsContainer) {
            statsContainer.style.display = 'none';
        }
    }

    function updateAgentStats() {
        const statIterations = document.getElementById('stat-iterations');
        const statTools = document.getElementById('stat-tools');
        const statStrategy = document.getElementById('stat-strategy');
        const statDuration = document.getElementById('stat-duration');

        if (statIterations) statIterations.textContent = agentCommStats.iterations;
        if (statTools) statTools.textContent = agentCommStats.toolCalls;
        if (statStrategy) statStrategy.textContent = agentCommStats.strategy;
        if (statDuration) statDuration.textContent = agentCommStats.duration + 's';
    }

    function ensureAgentCommsVisible() {
        const section = document.getElementById('agent-comms-section');
        const btn = document.getElementById('toggle-comms-btn');

        if (section && section.style.display === 'none') {
            section.style.display = 'block';
        }

        if (btn) {
            btn.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide';
        }
    }

    function addAgentComm(phase, content, metadata = {}) {
        ensureAgentCommsVisible();

        const statsDiv = document.getElementById('reasoning-stats');
        if (statsDiv && statsDiv.style.display === 'none') {
            statsDiv.style.display = 'flex';
            agentCommStartTime = Date.now();
        }
        
        // Update stats
        if (metadata.iteration) {
            agentCommStats.iterations = metadata.iteration;
        }
        if (metadata.strategy) {
            agentCommStats.strategy = metadata.strategy;
        }
        if (phase === 'action') {
            // Count tools from array (new format) or single tool (legacy format)
            if (metadata.toolDetails && Array.isArray(metadata.toolDetails)) {
                agentCommStats.toolCalls += metadata.toolDetails.length;
            } else if (metadata.toolName) {
                agentCommStats.toolCalls++;
            }
        }
        if (agentCommStartTime) {
            agentCommStats.duration = ((Date.now() - agentCommStartTime) / 1000).toFixed(1);
        }
        updateAgentStats();

        const handler = (window.AgentComm && typeof window.AgentComm.createHandler === 'function')
            ? window.AgentComm.createHandler('communicationsStream', { showFlow: true, autoExpand: false, autoScroll: true })
            : window.agentCommHandler;

        if (!handler || typeof handler.addInteraction !== 'function') {
            return;
        }

        const toolDetailsHtml = Array.isArray(metadata.toolDetails) && metadata.toolDetails.length > 0
            ? `<div><strong>Tools:</strong><br>${metadata.toolDetails.map(detail => ` ${escapeHtml(String(detail))}`).join('<br>')}</div>`
            : '';

        const toolResultText = metadata.toolResult
            ? (typeof metadata.toolResult === 'string'
                ? metadata.toolResult
                : JSON.stringify(metadata.toolResult, null, 2))
            : '';

        const resultHtml = toolResultText
            ? `<div><strong>Result:</strong><pre class="json-display">${escapeHtml(toolResultText)}</pre></div>`
            : '';

        const interactionHtml = `
            <div class="generic-response">
                <div class="comm-action"><strong>Phase:</strong> ${escapeHtml(String(phase || 'unknown'))}</div>
                <div class="text-content mt-2">${escapeHtml(String(content || ''))}</div>
                ${toolDetailsHtml}
                ${resultHtml}
            </div>
        `;

        const interactionType = phase === 'error' || metadata.isError ? 'error' : 'text';
        const status = phase === 'error' || metadata.isError
            ? 'failed'
            : (phase === 'action' ? 'in_progress' : 'completed');

        handler.addInteraction('mcp-orchestrator', interactionHtml, interactionType, {
            action: phase,
            status,
            input: metadata.toolParams || metadata.toolDetails || null,
            output: metadata.toolResult || null,
            timestamp: new Date().toISOString(),
        });

        const normalizedPhase = String(phase || '').toLowerCase();
        const isTerminalPhase = ['synthesis', 'complete', 'completed', 'done', 'final', 'finalize', 'finished'].includes(normalizedPhase);
        if (isTerminalPhase) {
            handler.taskCompleted = true;
            if (typeof handler.displayInteractions === 'function') {
                handler.displayInteractions();
            }
        }
    }

    // Connect to agent communication stream (SSE)
    let agentEventSource = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    const baseReconnectDelay = 1000; // 1 second
    const maxReconnectDelay = 30000; // 30 seconds cap

    function startAgentCommStream() {
        // Close existing connection if any
        if (agentEventSource) {
            agentEventSource.close();
            agentEventSource = null;
        }

        try {
            agentEventSource = new EventSource('/api/azure-mcp/agent-stream');
            
            agentEventSource.onopen = function() {
                console.log(' Agent communication stream connected');
                reconnectAttempts = 0; // Reset counter on successful connection
            };
            
            agentEventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    // Handle different event types
                    if (data.type === 'connected') {
                        console.log('Agent stream:', data.message);
                    } else if (data.type === 'error') {
                        console.error('Agent stream error message:', data.message);
                        addAgentComm('error', data.message, {});
                    } else if (data.type === 'reasoning') {
                        addAgentComm('reasoning', data.content, {
                            iteration: data.iteration,
                            strategy: data.strategy
                        });
                    } else if (data.type === 'action') {
                        addAgentComm('action', data.content, {
                            iteration: data.iteration,
                            toolName: data.tool_name,
                            toolParams: data.tool_params,
                            toolDetails: data.tool_details  // CLI commands and detailed tool info
                        });
                    } else if (data.type === 'observation') {
                        addAgentComm('observation', data.content, {
                            iteration: data.iteration,
                            toolResult: data.tool_result,
                            isError: data.is_error
                        });
                    } else if (data.type === 'reflection') {
                        addAgentComm('reflection', data.content, {
                            iteration: data.iteration
                        });
                    } else if (data.type === 'synthesis') {
                        addAgentComm('synthesis', data.content, {
                            iteration: data.iteration
                        });
                    } else if (data.type === 'planning') {
                        addAgentComm('planning', data.content, {
                            strategy: data.strategy
                        });
                    }
                } catch (error) {
                    console.error('Error parsing agent comm event:', error);
                }
            };
            
            agentEventSource.onerror = function(error) {
                console.warn('Agent comm stream disconnected (readyState=' + agentEventSource.readyState + ')');
                
                // Close the failed connection
                if (agentEventSource) {
                    agentEventSource.close();
                    agentEventSource = null;
                }
                
                // Always attempt to reconnect with exponential backoff (capped)
                reconnectAttempts++;
                const delay = Math.min(baseReconnectDelay * Math.pow(2, reconnectAttempts - 1), maxReconnectDelay);
                console.log(`Reconnecting agent stream (attempt ${reconnectAttempts}) in ${delay/1000}s...`);
                
                setTimeout(() => {
                    startAgentCommStream();
                }, delay);
            };
        } catch (error) {
            console.error('Failed to create EventSource:', error);
            // Retry after a delay
            setTimeout(() => { startAgentCommStream(); }, 5000);
        }
    }

    // Start stream on page load
    window.addEventListener('load', function() {
        startAgentCommStream();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (agentEventSource) {
            agentEventSource.close();
        }
    });
</script>

{# Initialize unified chat component #}
{{ chat_init_script(mode='mcp', agent_name='mcp-orchestrator') }}

<style>
    .action-btn {
        padding: var(--spacing-md) var(--spacing-xl);
        font-weight: 600;
        border-radius: var(--radius-lg);
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        min-width: 160px;
        justify-content: center;
        border: none;
    }

    .action-btn-primary {
        background: transparent;
        color: white;
        border: 2px solid white !important;
    }

    .action-btn-primary:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid white !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .action-btn-secondary {
        background: transparent;
        color: white;
        border: 2px solid white !important;
    }

    .action-btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid white !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    pre {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        max-height: 400px;
    }

    .font-monospace {
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.9rem;
    }

    /* Chat Interface Styles */
    .chat-container {
        border: 1px solid #dee2e6;
        height: 600px;
        overflow-y: auto;
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1rem;
    }

    .chat-container::-webkit-scrollbar {
        width: 8px;
    }

    .chat-container::-webkit-scrollbar-thumb {
        background: rgba(37, 99, 235, 0.35);
        border-radius: 4px;
    }

    .chat-message {
        animation: slideIn 0.3s ease-out;
    }

    .chat-message-wrapper {
        padding: 12px;
        border-radius: 8px;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.02);
        border-left-width: 4px;
        border-left-style: solid;
    }


    .chat-message-header {
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chat-message-body {
        line-height: 1.6;
    }

    html.dark-mode #monitor-resources-container .accordion-item {
        background: var(--bg-secondary) !important;
        border-color: var(--border-primary) !important;
    }

    html.dark-mode #monitor-resources-container .accordion-button {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
    }

    html.dark-mode #monitor-resources-container .accordion-button:not(.collapsed) {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        box-shadow: inset 0 -1px 0 var(--border-primary) !important;
    }

    html.dark-mode #monitor-resources-container .accordion-button strong {
        color: inherit !important;
    }

    html.dark-mode #monitor-resources-container .accordion-button::after {
        filter: brightness(1.2);
    }

    html.dark-mode #monitor-resources-container .accordion-body {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
    }

    #chat-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
    }

    .user-message {
        text-align: left;
    }

    .assistant-message {
        text-align: left;
    }

    .error-message {
        text-align: center;
    }

    /* Agent Communication Styles */
    .agent-comms-container {
        background-color: #1e1e1e;
        color: #d4d4d4;
    }
    
    .agent-comm-entry {
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        border-left: 3px solid #0078d4;
        background-color: #2d2d30;
        border-radius: 4px;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .agent-comm-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .agent-comm-header-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .agent-comm-phase {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
    }
    
    .phase-reasoning {
        background-color: #4ec9b0;
        color: #000;
    }
    
    .phase-action {
        background-color: #569cd6;
        color: #fff;
    }
    
    .phase-observation {
        background-color: #dcdcaa;
        color: #000;
    }
    
    .phase-reflection {
        background-color: #c586c0;
        color: #fff;
    }
    
    .phase-synthesis {
        background-color: #ce9178;
        color: #fff;
    }
    
    .phase-planning {
        background-color: #9cdcfe;
        color: #000;
    }
    
    .agent-comm-timestamp {
        font-size: 0.7rem;
        color: #858585;
    }
    
    .agent-comm-content {
        color: #d4d4d4;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .tool-call {
        background-color: #1e3a5f;
        padding: 0.5rem;
        border-radius: 3px;
        margin-top: 0.5rem;
        border-left: 3px solid #569cd6;
    }
    
    .tool-call-details {
        margin-top: 0.5rem;
    }
    
    .cli-command-display {
        background-color: #1e1e1e;
        padding: 0.75rem;
        border-radius: 4px;
        margin-top: 0.5rem;
        border-left: 3px solid #569cd6;
    }
    
    .cli-command-label {
        color: #4ec9b0;
        font-size: 0.75rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
    }
    
    .cli-command {
        display: block;
        background-color: #2d2d2d;
        color: #dcdcaa;
        padding: 0.5rem;
        border-radius: 3px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        word-break: break-all;
        line-height: 1.4;
    }
    
    .tool-detail {
        background-color: #1e3a5f;
        padding: 0.5rem;
        border-radius: 3px;
        margin-top: 0.5rem;
        border-left: 3px solid #569cd6;
        color: #9cdcfe;
        font-size: 0.85rem;
    }
    
    .tool-name {
        color: #4ec9b0;
        font-weight: bold;
    }
    
    .tool-params {
        color: #9cdcfe;
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }
    
    .tool-result {
        background-color: #1e401e;
        padding: 0.5rem;
        border-radius: 3px;
        margin-top: 0.5rem;
        border-left: 3px solid #4ec9b0;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .tool-error {
        background-color: #3f1e1e;
        padding: 0.5rem;
        border-radius: 3px;
        margin-top: 0.5rem;
        border-left: 3px solid #f48771;
        color: #f48771;
    }
    
    .stat-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    
    .stat-value {
        font-size: 1.75rem;
        font-weight: bold;
        color: #0078d4;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .reasoning-iteration {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background-color: #0078d4;
        color: white;
        border-radius: 3px;
        font-size: 0.75rem;
        margin-left: 0.5rem;
    }
</style>

<link rel="stylesheet" href="/static/css/agent_communication.css">

<!-- Agent Communication Handler -->
<script src="/static/js/agent-communication.js"></script>

{% endblock %}
