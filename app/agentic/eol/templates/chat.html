{% extends "base.html" %}

{% block title %}AI Assistant — EOL Agentic Platform{% endblock %}

{% block extra_head %}
<style>
    /* Chat Interface Styles - Consistent with platform design */
    .chat-container {
        padding: 0;
        margin-bottom: var(--spacing-xl);
        display: flex;
        gap: var(--spacing-lg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
        height: calc(100vh - 300px);
        min-height: 600px;
        max-height: 800px;
    }

    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        min-height: 0;
    }

    .chat-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        padding: var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-messages {
        flex: 1;
        padding: var(--spacing-lg);
        overflow-y: auto;
        background: var(--gray-50);
        min-height: 200px;
        max-height: calc(100% - 200px);
    }

    .message-group {
        margin-bottom: var(--spacing-lg);
        width: 100%;
    }

    .message-user {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        margin-left: auto;
    }

    .message-assistant {
        background: white;
        border: 1px solid var(--gray-200);
        color: var(--gray-800);
    }

    .message-bubble {
        width: 100%;
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-sm);
        position: relative;
        animation: fadeIn 0.3s ease;
    }

    .message-user .message-bubble {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        margin-left: auto;
        text-align: left;
    }

    .message-assistant .message-bubble {
        background: white;
        color: #374151;
        border: 1px solid #e5e7eb;
        margin-right: auto;
    }

    .message-system {
        background: var(--gray-100);
        border: 1px solid var(--gray-300);
        color: var(--gray-700);
        font-style: italic;
    }

    .message-header {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-size-sm);
        font-weight: 600;
    }

    .message-time {
        font-size: var(--font-size-xs);
        color: var(--gray-500);
        margin-left: auto;
    }

    .message-user .message-time {
        color: rgba(255, 255, 255, 0.8);
    }

    .message-assistant .message-time {
        color: #9ca3af;
    }

    .message-system .message-time {
        color: #6b7280;
    }

    .message-content {
        line-height: 1.6;
    }

    .message-content pre {
        background: var(--gray-800);
        color: var(--gray-100);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        overflow-x: auto;
        font-size: var(--font-size-sm);
        margin: var(--spacing-sm) 0;
    }

    .chat-input-area {
        background: white;
        border-top: 1px solid var(--gray-200);
        padding: var(--spacing-lg);
        flex-shrink: 0;
        /* Prevent input area from shrinking */
        position: relative;
        /* Ensure it stays in place */
        min-height: 120px;
        /* Ensure minimum height for visibility */
        z-index: 10;
        /* Ensure it stays on top */
    }

    .input-group-modern {
        display: flex;
        gap: var(--spacing-sm);
        align-items: end;
    }

    .chat-input {
        flex: 1;
        min-height: 50px;
        max-height: 120px;
        resize: none;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        transition: all 0.2s ease;
    }

    .chat-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .send-button {
        height: 50px;
        width: 50px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .send-button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .typing-indicator {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        color: var(--gray-500);
        padding: var(--spacing-md);
    }

    .typing-dots {
        display: flex;
        gap: 2px;
    }

    .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--gray-400);
        animation: typingAnimation 1.4s infinite;
    }

    .typing-dot:nth-child(1) {
        animation-delay: 0ms;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 200ms;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 400ms;
    }

    @keyframes typingAnimation {

        0%,
        60%,
        100% {
            opacity: 0.3;
            transform: translateY(0);
        }

        30% {
            opacity: 1;
            transform: translateY(-4px);
        }
    }

    .quick-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
        flex-wrap: wrap;
        padding: var(--spacing-sm) 0;
        /* Add some vertical padding for better visibility */
    }

    .quick-action {
        background: linear-gradient(135deg, var(--gray-100), var(--gray-50));
        border: 1px solid var(--gray-300);
        color: var(--gray-700);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-lg);
        font-size: var(--font-size-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        /* Add subtle shadow for better visibility */
        font-weight: 500;
        /* Make text slightly bolder */
    }

    .quick-action:hover {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        border-color: var(--primary-color);
        transform: translateY(-1px);
        /* Slight lift effect */
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        /* Enhanced shadow on hover */
    }

    @media (max-width: 768px) {
        .chat-messages {
            height: calc(100vh - 250px);
            min-height: 300px;
        }

        .message-user .message-bubble {
            max-width: 85%;
        }

        .message-assistant .message-bubble {
            max-width: 85%;
        }

        .quick-actions {
            justify-content: center;
        }

        .quick-action {
            flex: 1;
            min-width: 0;
            text-align: center;
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
    }

    /* Inventory Table Styles - matching inventory.html */
    .inventory-table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        margin: 1rem 0;
        width: 100%;
    }

    .table-responsive {
        overflow-x: auto;
        max-height: 70vh;
        width: 100%;
    }

    .inventory-table {
        margin: 0;
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .inventory-table th {
        background-color: #343a40;
        color: white;
        font-weight: 600;
        border: none;
        padding: 12px 16px;
        position: sticky;
        top: 0;
        z-index: 10;
        text-align: left;
        white-space: nowrap;
        border-bottom: 2px solid #495057;
    }

    .inventory-table td {
        padding: 12px 16px;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
        border-right: 1px solid #e9ecef;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }

    .inventory-table td:last-child {
        border-right: none;
    }

    .inventory-table tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.001);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .inventory-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Status badges matching inventory.html */
    .status-active {
        background-color: #f0fdf4;
        color: #16a34a;
        border: 1px solid #bbf7d0;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-eol {
        background-color: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-warning {
        background-color: #fffbeb;
        color: #d97706;
        border: 1px solid #fed7aa;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-unknown {
        background-color: #f3f4f6;
        color: #6b7280;
        border: 1px solid #d1d5db;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Legacy status styles for backward compatibility */
    .inventory-table .status-cell {
        text-align: center;
    }

    .inventory-table .status-ok {
        color: #28a745;
        font-weight: 600;
    }

    .inventory-table .status-warning {
        color: #ffc107;
        font-weight: 600;
    }

    .inventory-table .status-danger {
        color: #dc3545;
        font-weight: 600;
    }

    .inventory-section {
        margin: 1.5rem 0;
    }

    .inventory-section h4 {
        color: #495057;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
        font-size: 1.1rem;
    }

    @media (max-width: 768px) {
        .inventory-table {
            font-size: 0.8rem;
        }

        .inventory-table th,
        .inventory-table td {
            padding: 8px 4px;
        }
    }
</style>
<!-- Use shared agent communications stylesheet to avoid duplication -->
<link rel="stylesheet" href="/static/css/agent_communication.css">
{% endblock %}

{% block content %}
<style>
    /* Additional page-specific styles */
    .token-stat {
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 3px solid #17a2b8;
        font-size: 0.85rem;
    }

    /* Agent Flow Visualization */
    .agent-flow-visual {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: center;
        padding: 1rem 0;
    }

    .message-communication,
    .general-communication {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 0.75rem;
    }

    .action-info,
    .input-info,
    .output-info {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .basic-communication {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        padding: 0.75rem;
    }

    .basic-communication .comm-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    .basic-communication .comm-content {
        font-size: 0.85rem;
        color: #495057;
    }

    .basic-communication .timestamp {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .agent-communication {
        margin-bottom: 1rem;
        padding: 1rem;
        border-left: 3px solid #6c757d;
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        word-wrap: break-word;
        clear: both;
    }

    .agent-communication.inventory-agent {
        border-left-color: #0d6efd;
    }

    .agent-communication.microsoft-agent {
        border-left-color: #dc3545;
    }

    .agent-communication.ubuntu-agent {
        border-left-color: #fd7e14;
    }

    .agent-communication.enterprise-agent {
        border-left-color: #6f42c1;
    }

    .agent-communication.oracle-agent {
        border-left-color: #d63384;
    }

    .agent-communication.risk-coordinator {
        border-left-color: #198754;
    }

    .agent-communication.orchestrator-agent {
        border-left-color: #20c997;
    }

    /* Task type styling */
    .agent-communication.task-inventory {
        background: linear-gradient(90deg, #f8f9fa 0%, #e3f2fd 100%);
    }

    .agent-communication.task-eol {
        background: linear-gradient(90deg, #f8f9fa 0%, #fff3e0 100%);
    }

    .agent-communication.task-tool {
        background: linear-gradient(90deg, #f8f9fa 0%, #f3e5f5 100%);
    }

    .agent-communication.task-error {
        background: linear-gradient(90deg, #f8f9fa 0%, #ffebee 100%);
    }

    .agent-communication.task-complete {
        background: linear-gradient(90deg, #f8f9fa 0%, #e8f5e8 100%);
    }

    /* Status styling */
    .agent-communication.status-completed {
        border-left-width: 4px;
    }

    .agent-communication.status-failed {
        border-left-width: 4px;
        border-left-style: dashed;
    }

    .task-summary {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 1rem;
        text-align: center;
    }

    .task-summary-header {
        font-size: 0.95em;
        color: #0d6efd;
    }

    .comm-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: 2rem;
    }

    /* Ensure layout stacks when space is tight */
    @media (max-width: 1200px) {
        .comm-header {
            flex-direction: column;
            align-items: stretch;
            gap: 0.25rem;
        }

        .comm-agent {
            order: 1;
            width: 100%;
            margin-right: 0;
        }

        .comm-timestamp {
            order: 2;
            align-self: flex-start;
        }

        .comm-task-info {
            order: 3;
            width: 100%;
        }
    }

    .comm-timestamp {
        font-size: 0.8em;
        color: #6c757d;
        order: 1;
        white-space: nowrap;
        margin-top: 0.2rem;
        flex-shrink: 0;
    }

    .comm-agent {
        font-weight: bold;
        color: #495057;
        order: 2;
        flex: 1 1 auto;
        min-width: 200px;
        margin-right: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .comm-task-info {
        order: 3;
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
        align-items: flex-start;
        margin-top: 0.2rem;
        flex-shrink: 1;
        min-width: 0;
    }

    .task-type-badge {
        font-size: 0.7em;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-weight: bold;
        text-transform: uppercase;
        white-space: nowrap;
        display: inline-block;
        margin: 0.1rem 0;
    }

    .status-badge {
        font-size: 0.7em;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-weight: bold;
        white-space: nowrap;
        display: inline-block;
        margin: 0.1rem 0;
    }

    .task-type-badge.task-inventory {
        background: #e3f2fd;
        color: #1565c0;
    }

    .task-type-badge.task-eol {
        background: #fff3e0;
        color: #ef6c00;
    }

    .task-type-badge.task-tool {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .task-type-badge.task-comm {
        background: #e8f5e8;
        color: #2e7d32;
    }

    .task-type-badge.task-error {
        background: #ffebee;
        color: #c62828;
    }

    .task-type-badge.task-complete {
        background: #e8f5e8;
        color: #388e3c;
    }

    .task-type-badge.task-general {
        background: #f5f5f5;
        color: #424242;
    }

    .status-badge.status-completed {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.status-failed {
        background: #f8d7da;
        color: #721c24;
    }

    .status-badge.status-progress {
        background: #d1ecf1;
        color: #0c5460;
    }

    .status-badge.status-unknown {
        background: #e2e3e5;
        color: #383d41;
    }

    .comm-action {
        font-style: italic;
        color: #6c757d;
        margin-bottom: 0.75rem;
        font-size: 0.9em;
        line-height: 1.4;
        word-wrap: break-word;
        overflow-wrap: break-word;
        clear: both;
    }

    .comm-data {
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 3px;
        font-size: 0.8em;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
        border: 1px solid #e9ecef;
    }

    .comm-message {
        background: #e7f3ff;
        padding: 0.75rem;
        border-radius: 3px;
        border-left: 3px solid #0066cc;
        font-size: 0.85em;
        white-space: pre-wrap;
        margin-top: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    /* Enhanced Request/Response Styles */
    .comm-request-response {
        margin-top: 0.75rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .comm-request-section,
    .comm-response-section {
        background: white;
        border-radius: 4px;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
        font-size: 0.9em;
    }

    .request-content,
    .response-content {
        font-size: 0.85em;
    }

    .request-item,
    .response-item {
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
    }

    .request-item:last-child,
    .response-item:last-child {
        margin-bottom: 0;
    }

    .confidence-badge {
        background: #28a745;
        color: white;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: bold;
    }

    .eol-date,
    .support-date {
        font-weight: bold;
        color: #dc3545;
    }

    .status-completed .response-item:first-child {
        color: #28a745;
    }

    .status-failed .response-item:first-child {
        color: #dc3545;
    }

    .status-in_progress .response-item:first-child {
        color: #ffc107;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .comm-request-response {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
    }

    .task-data-structured {
        background: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 0.5rem;
    }

    .data-metric {
        margin-bottom: 0.25rem;
        font-size: 0.85em;
    }

    .data-preview {
        background: #f8f9fa;
        padding: 0.5rem;
        border-radius: 3px;
        margin-bottom: 0.5rem;
        font-family: monospace;
        font-size: 0.8em;
    }

    .data-error {
        color: #dc3545;
        background: #f8d7da;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        margin-bottom: 0.25rem;
        font-size: 0.85em;
    }

    @media (max-width: 768px) {
        .comm-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .comm-task-info {
            order: 1;
            width: 100%;
            justify-content: flex-start;
        }

        .comm-agent {
            order: 2;
            width: 100%;
        }

        .comm-timestamp {
            order: 3;
            width: 100%;
        }
    }

    .example-queries {
        margin-bottom: 1rem;
    }

    .examples-header {
        cursor: pointer;
        user-select: none;
        padding: 0.5rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .examples-header:hover {
        background: #e9ecef;
    }

    .examples-toggle {
        font-size: 0.8em;
        transition: transform 0.2s;
    }

    .examples-toggle.collapsed {
        transform: rotate(-90deg);
    }

    .examples-content {
        transition: all 0.3s ease-out;
        overflow: hidden;
    }

    .examples-content.collapsed {
        max-height: 0;
        padding: 0;
        margin: 0;
        opacity: 0;
    }

    .examples-content:not(.collapsed) {
        max-height: 200px;
        opacity: 1;
    }

    .example-query {
        display: inline-block;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
    }

    .example-query:hover {
        background: #e9ecef;
        transform: translateY(-1px);
    }

    .status-indicator {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
    }

    .status-autogen {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .confirmation-buttons {
        margin: 1rem 0;
        padding: 1rem;
        background: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 8px;
    }

    .confirmation-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    .confirmation-text {
        flex: 1;
        color: #856404;
    }

    .confirmation-actions {
        flex-shrink: 0;
    }

    .confirmation-actions .btn {
        margin-left: 0.5rem;
    }

    @media (max-width: 768px) {
        .confirmation-container {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }

        .confirmation-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .confirmation-actions .btn {
            margin-left: 0;
            flex: 1;
        }
    }

    .paginated-content {
        position: relative;
        width: 100%;
    }

    .content-preview {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        padding: 0.75rem;
        margin-top: 0.5rem;
        font-size: 0.9em;
        color: #856404;
        width: 100%;
    }

    .content-summary {
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .paginated-content-area {
        min-height: 200px;
        width: 100%;
        max-height: 600px;
        overflow-y: auto;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background: white;
        margin: 0.5rem 0;
    }

    /* Modern Pagination Container - Updated from inventory.html design */
    .pagination-container {
        background: white;
        border-radius: var(--radius-lg, 12px);
        padding: var(--spacing-lg, 1.5rem);
        margin: var(--spacing-lg, 1.5rem) 0;
        border: 1px solid var(--gray-200, #e2e8f0);
        box-shadow: var(--shadow-sm, 0 1px 3px rgba(0, 0, 0, 0.1));
        width: 100%;
    }

    .pagination-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spacing-lg, 1.5rem);
        flex-wrap: wrap;
        width: 100%;
        max-width: 100%;
    }

    .pagination-info-section {
        display: flex;
        align-items: center;
        gap: var(--spacing-md, 1rem);
        flex-wrap: wrap;
        min-width: 0;
        flex: 1;
    }

    .pagination-summary {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm, 0.5rem);
        white-space: nowrap;
        flex-shrink: 0;
        color: var(--gray-600, #64748b);
        font-size: var(--font-size-sm, 0.875rem);
        font-weight: 500;
    }

    .pagination-summary-title {
        font-weight: 600;
        color: var(--gray-900, #1e293b);
        margin-right: var(--spacing-sm, 0.5rem);
    }

    .pagination-summary-stats {
        display: flex;
        gap: var(--spacing-md, 1rem);
        font-size: var(--font-size-sm, 0.875rem);
        color: var(--gray-600, #64748b);
    }

    .pagination-nav-row {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .pagination .page-link {
        color: var(--primary-color, #3b82f6);
        border: 1px solid var(--gray-200, #e2e8f0);
        padding: var(--spacing-sm, 0.5rem) var(--spacing-md, 1rem);
        border-radius: var(--radius-md, 8px);
        margin: 0 2px;
        transition: all 0.2s ease;
        font-weight: 500;
        min-width: 40px;
        text-align: center;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .pagination .page-item.active .page-link {
        background-color: var(--primary-color, #3b82f6);
        border-color: var(--primary-color, #3b82f6);
        color: white;
        font-weight: 600;
        box-shadow: var(--shadow-sm, 0 1px 3px rgba(0, 0, 0, 0.1));
    }

    .pagination .page-link:hover {
        background-color: var(--primary-light, #dbeafe);
        border-color: var(--primary-color, #3b82f6);
        color: var(--primary-color, #3b82f6);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm, 0 1px 3px rgba(0, 0, 0, 0.1));
    }

    .pagination .page-link:disabled,
    .pagination .page-item.disabled .page-link {
        background-color: var(--gray-100, #f1f5f9);
        border-color: var(--gray-200, #e2e8f0);
        color: var(--gray-400, #94a3b8);
        cursor: not-allowed;
        transform: none;
    }

    .pagination .page-link:disabled:hover,
    .pagination .page-item.disabled .page-link:hover {
        background-color: var(--gray-100, #f1f5f9);
        border-color: var(--gray-200, #e2e8f0);
        color: var(--gray-400, #94a3b8);
        transform: none;
        box-shadow: none;
    }

    /* Content preview styling */
    .content-preview {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #f59e0b;
        border-radius: var(--radius-lg, 8px);
        padding: var(--spacing-lg, 1rem);
        margin-bottom: var(--spacing-lg, 1rem);
    }

    .content-summary {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-lg, 0.75rem);
        margin-bottom: var(--spacing-sm, 0.5rem);
        flex-wrap: wrap;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .pagination-controls {
            flex-direction: column;
            align-items: stretch;
            gap: var(--spacing-md, 1rem);
        }

        .pagination-info-section {
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: var(--spacing-sm, 0.5rem);
        }

        .pagination {
            justify-content: center;
        }

        .pagination .page-link {
            padding: var(--spacing-xs, 0.25rem) var(--spacing-sm, 0.5rem);
            font-size: var(--font-size-sm, 0.875rem);
        }

        .content-summary {
            flex-direction: column;
            gap: var(--spacing-sm, 0.5rem);
        }
    }

    @media (max-width: 576px) {
        .pagination-summary-stats {
            flex-direction: column;
            gap: var(--spacing-xs, 0.25rem);
            text-align: center;
        }

        .pagination .page-link {
            min-width: 32px;
            padding: var(--spacing-xs, 0.25rem);
        }
    }

    /* Additional pagination styling removed - using inventory.html based design above */

    .page-current-display {
        font-size: 1.2em;
        font-weight: 700;
    }

    .page-divider {
        opacity: 0.8;
        font-size: 0.9em;
        margin: 0 0.25rem;
    }

    .page-total-display {
        opacity: 0.9;
    }

    .pagination-navigation {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        justify-content: center;
        width: 100%;
        /* Use full width for better content display */
        flex-wrap: nowrap;
        overflow-x: auto;
    }

    .pagination-nav-btn {
        border: none;
        background: white;
        color: #3b82f6;
        padding: 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
        height: 40px;
        font-size: 0.875rem;
        border: 2px solid #e2e8f0;
        position: relative;
        overflow: hidden;
    }

    .pagination-nav-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.5s;
    }

    .pagination-nav-btn:hover::before {
        left: 100%;
    }

    .pagination-nav-btn:hover:not(.disabled) {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .pagination-nav-btn.active {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border-color: #3b82f6;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
    }

    .pagination-nav-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #f1f5f9;
        color: #94a3b8;
        border-color: #f1f5f9;
    }

    .pagination-nav-btn.disabled:hover {
        transform: none;
        box-shadow: none;
    }

    .pagination-page-grid {
        display: flex;
        gap: 0.25rem;
        margin: 0 0.5rem;
    }

    .pagination-quick-jump {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
        background: white;
        padding: 0.5rem;
        border-radius: 8px;
        border: 2px solid #e2e8f0;
        min-width: 140px;
        /* Ensure consistent width */
        justify-content: center;
    }

    .pagination-jump-label {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 500;
    }

    .pagination-jump-input {
        width: 50px;
        height: 32px;
        padding: 0.25rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        text-align: center;
        font-size: 0.875rem;
        font-weight: 600;
        color: #1e293b;
        background: white;
        transition: all 0.2s ease;
    }

    .pagination-jump-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .pagination-jump-go {
        padding: 0.5rem 0.75rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .pagination-jump-go:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
    }

    /* Responsive Pagination */
    @media (max-width: 992px) {
        .pagination-navigation {
            width: 100%;
            /* Use full width on smaller screens */
        }

        .pagination-quick-jump {
            min-width: 120px;
            /* Smaller on tablets */
        }
    }

    @media (max-width: 768px) {
        .pagination-container {
            margin-top: 1rem;
            padding: 0.75rem;
        }

        .pagination-controls {
            gap: 0.75rem;
        }

        .pagination-nav-row {
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }

        .pagination-page-indicator {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            order: 1;
            width: 100%;
            justify-content: center;
        }

        .pagination-navigation {
            flex: none;
            order: 2;
            max-width: 100%;
        }

        .pagination-nav-btn {
            min-width: 36px;
            height: 36px;
            padding: 0.5rem;
            font-size: 0.8rem;
        }

        .pagination-page-grid {
            flex-wrap: wrap;
            justify-content: center;
        }

        .pagination-quick-jump {
            flex: none;
            order: 3;
            min-width: auto;
            width: auto;
        }

        .pagination-jump-input {
            width: 45px;
            height: 28px;
            font-size: 0.8rem;
        }
    }

    @media (max-width: 576px) {
        .pagination-container {
            padding: 0.5rem;
        }

        .pagination-nav-row {
            flex-direction: column;
            gap: 0.75rem;
        }

        .pagination-navigation,
        .pagination-quick-jump {
            width: 100%;
            justify-content: center;
        }

        .pagination-summary-stats {
            flex-direction: column;
            gap: 0.25rem;
        }

        .pagination-page-indicator {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }

        .pagination-nav-btn {
            min-width: 32px;
            height: 32px;
            font-size: 0.75rem;
        }

        .pagination-jump-input {
            width: 40px;
            height: 26px;
            font-size: 0.75rem;
        }

        /* Simplify on very small screens */
        .pagination-page-grid {
            display: none;
        }

        .pagination-summary-stats>span:not(:first-child) {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .autogen-container {
            flex-direction: column;
            height: auto;
            min-height: 800px;
        }

        .agent-panel {
            height: 350px;
            min-height: 350px;
            order: 2;
        }

        .agent-panel.collapsed {
            height: auto;
            min-height: auto;
            width: 100%;
            min-width: 100%;
        }

        .chat-section {
            height: 70vh;
            min-height: 500px;
            order: 1;
        }

        .chat-section.full-width {
            height: calc(100vh - 200px);
            min-height: 600px;
        }

        .section-header .header-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }

        .section-header .toggle-btn {
            font-size: 1em;
        }
    }
</style>
<!-- Sync: Agent communications styles from eol.html to ensure visual parity -->
<style>
    /* Enhanced Communication Styling (synced from eol.html) */
    .eol-response-enhanced {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem;
    }

    .response-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.75rem;
        text-align: center;
    }

    .response-details {
        display: grid;
        gap: 0.5rem;
    }

    .detail-item {
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 3px solid #17a2b8;
        font-size: 0.85rem;
    }

    .message-communication,
    .general-communication {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 0.75rem;
    }

    .action-info,
    .input-info,
    .output-info {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .basic-communication {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        padding: 0.75rem;
    }

    .basic-communication .comm-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    .basic-communication .comm-content {
        font-size: 0.85rem;
        color: #495057;
    }

    .basic-communication .timestamp {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .agent-communication {
        margin-bottom: 1rem;
        padding: 1rem;
        border-left: 3px solid #6c757d;
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        word-wrap: break-word;
        overflow-wrap: break-word;
        clear: both;
        max-width: 100%;
        box-sizing: border-box;
    }

    .agent-communication.inventory-agent {
        border-left-color: #0d6efd;
    }

    .agent-communication.microsoft-agent {
        border-left-color: #dc3545;
    }

    .agent-communication.ubuntu-agent {
        border-left-color: #fd7e14;
    }

    .agent-communication.enterprise-agent {
        border-left-color: #6f42c1;
    }

    .agent-communication.oracle-agent {
        border-left-color: #d63384;
    }

    .agent-communication.risk-coordinator {
        border-left-color: #198754;
    }

    .agent-communication.orchestrator-agent {
        border-left-color: #20c997;
    }

    /* Task type styling */
    .agent-communication.task-inventory {
        background: linear-gradient(90deg, #f8f9fa 0%, #e3f2fd 100%);
    }

    .agent-communication.task-eol {
        background: linear-gradient(90deg, #f8f9fa 0%, #fff3e0 100%);
    }

    .agent-communication.task-tool {
        background: linear-gradient(90deg, #f8f9fa 0%, #f3e5f5 100%);
    }

    .agent-communication.task-error {
        background: linear-gradient(90deg, #f8f9fa 0%, #ffebee 100%);
    }

    .agent-communication.task-complete {
        background: linear-gradient(90deg, #f8f9fa 0%, #e8f5e8 100%);
    }

    /* Status styling */
    .agent-communication.status-completed {
        border-left-width: 4px;
    }

    .agent-communication.status-failed {
        border-left-width: 4px;
        border-left-style: dashed;
    }

    .task-summary {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 1rem;
        text-align: center;
    }

    .task-summary-header {
        font-size: 0.95em;
        color: #0d6efd;
    }

    .comm-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: 2rem;
    }

    /* Ensure layout stacks when space is tight */
    @media (max-width: 1200px) {
        .comm-header {
            flex-direction: column;
            align-items: stretch;
            gap: 0.25rem;
        }

        .comm-agent {
            order: 1;
            width: 100%;
            margin-right: 0;
        }

        .comm-timestamp {
            order: 2;
            align-self: flex-start;
        }

        .comm-task-info {
            order: 3;
            width: 100%;
        }
    }

    .comm-timestamp {
        font-size: 0.8em;
        color: #6c757d;
        order: 1;
        white-space: nowrap;
        margin-top: 0.2rem;
        flex-shrink: 0;
    }

    .comm-agent {
        font-weight: bold;
        color: #495057;
        order: 2;
        flex: 1 1 auto;
        min-width: 200px;
        margin-right: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .comm-task-info {
        order: 3;
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
        align-items: flex-start;
        margin-top: 0.2rem;
        flex-shrink: 1;
        min-width: 0;
    }

    .task-type-badge {
        font-size: 0.7em;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-weight: bold;
        text-transform: uppercase;
        white-space: nowrap;
        display: inline-block;
        margin: 0.1rem 0;
    }

    .status-badge {
        font-size: 0.7em;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-weight: bold;
        white-space: nowrap;
        display: inline-block;
        margin: 0.1rem 0;
    }

    .task-type-badge.task-inventory {
        background: #e3f2fd;
        color: #1565c0;
    }

    .task-type-badge.task-eol {
        background: #fff3e0;
        color: #ef6c00;
    }

    .task-type-badge.task-tool {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .task-type-badge.task-comm {
        background: #e8f5e8;
        color: #2e7d32;
    }

    .task-type-badge.task-error {
        background: #ffebee;
        color: #c62828;
    }

    .task-type-badge.task-complete {
        background: #e8f5e8;
        color: #388e3c;
    }

    .task-type-badge.task-general {
        background: #f5f5f5;
        color: #424242;
    }

    .status-badge.status-completed {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.status-failed {
        background: #f8d7da;
        color: #721c24;
    }

    .status-badge.status-progress {
        background: #d1ecf1;
        color: #0c5460;
    }

    .status-badge.status-unknown {
        background: #e2e3e5;
        color: #383d41;
    }

    .comm-action {
        font-style: italic;
        color: #6c757d;
        margin-bottom: 0.75rem;
        font-size: 0.9em;
        line-height: 1.4;
        word-wrap: break-word;
        overflow-wrap: break-word;
        clear: both;
    }

    .comm-data {
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 3px;
        font-size: 0.8em;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        overflow-x: auto;
        margin-top: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
        border: 1px solid #e9ecef;
        max-width: 100%;
        box-sizing: border-box;
    }

    .comm-message {
        background: #e7f3ff;
        padding: 0.75rem;
        border-radius: 3px;
        border-left: 3px solid #0066cc;
        font-size: 0.85em;
        white-space: pre-wrap;
        margin-top: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        box-sizing: border-box;
        overflow-x: auto;
    }

    /* Enhanced Request/Response Styles */
    .comm-request-response {
        margin-top: 0.75rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }

    .comm-request-section,
    .comm-response-section {
        background: white;
        border-radius: 4px;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        min-width: 0;
        overflow: hidden;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
        font-size: 0.9em;
    }

    .request-content,
    .response-content {
        font-size: 0.85em;
        max-width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
    }

    .request-item,
    .response-item {
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
    }

    .request-item:last-child,
    .response-item:last-child {
        margin-bottom: 0;
    }

    .confidence-badge {
        background: #28a745;
        color: white;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: bold;
    }

    .eol-date,
    .support-date {
        font-weight: bold;
        color: #dc3545;
    }

    .status-completed .response-item:first-child {
        color: #28a745;
    }

    .status-failed .response-item:first-child {
        color: #dc3545;
    }

    .status-in_progress .response-item:first-child {
        color: #ffc107;
    }

    @media (max-width: 768px) {
        .comm-request-response {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
    }

    /* Agent Communications Container Width Control */
    .agent-communications {
        max-width: 100%;
        overflow-x: hidden;
        box-sizing: border-box;
        /* Fixed height with scroll for better layout consistency */
        height: 450px;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .interaction-card {
        max-width: 100%;
        overflow-x: hidden;
        box-sizing: border-box;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .json-display {
        max-width: 100%;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        font-family: monospace;
        font-size: 0.8em;
        background: #f8f9fa;
        padding: 0.5rem;
        border-radius: 3px;
        border: 1px solid #e9ecef;
        box-sizing: border-box;
    }
</style>

<!-- Chat Hero Section -->
<div class="hero-section fade-in">
    <div class="hero-content">
        <div class="row align-items-center">
            <div class="col-lg-12">
                <h1 class="hero-title">
                    <i class="fas fa-robot me-3"></i>
                    AI Assistant
                </h1>
                <p class="hero-subtitle">
                    Intelligent conversational interface powered by multi-agent orchestration.
                    Ask questions about your software inventory, get EOL analysis, and receive expert recommendations.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Chat Interface -->
<div class="container-fluid px-0">
    <div class="chat-container fade-in">
        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <h5 class="mb-0">
                    <i class="fas fa-comments me-2"></i>
                    Multi-Agent Conversation
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2" id="conversationStats">Ready to start</span>
                    <button class="btn btn-sm btn-outline-light" onclick="clearConversation()">
                        <i class="fas fa-trash me-1"></i>Clear
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-muted py-5">
                    <div class="mb-3">
                        <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                    </div>
                    <h5>Welcome to the AI Assistant!</h5>
                    <p class="mb-4">Ask about your software inventory, EOL risks, or get expert recommendations.</p>
                </div>
            </div>

            <div class="chat-input-area">
                <!-- Quick actions moved above input -->
                <div class="quick-actions mb-3">
                    <!-- <div class="quick-action" onclick="sendQuickMessage('Show my inventory')">
                    <i class="fas fa-list me-1"></i>Show my inventory
                </div> -->
                    <div class="quick-action" onclick="sendQuickMessage('What software do I have in my inventory?')">
                        <i class="fas fa-exclamation-triangle me-1"></i>What software do I have in my inventory?
                    </div>
                    <div class="quick-action"
                        onclick="sendQuickMessage('What operating systems do I have in my inventory?')">
                        <i class="fab fa-windows me-1"></i>What OS versions do I have in my inventory?
                    </div>
                    <div class="quick-action" onclick="sendQuickMessage('Show my OS inventory with EOL dates')">
                        <i class="fas fa-desktop me-1"></i><i class="fas fa-calendar-times me-1"></i>Show my OS
                        inventory with EOL dates
                    </div>
                    <div class="quick-action"
                        onclick="sendQuickMessage('What is the EOL date of Windows Server 2016?')">
                        <i class="fas fa-server me-1"></i><i class="fas fa-calendar-times me-1"></i>What is the EOL date
                        of Windows Server 2016?
                    </div>
                </div>

                <!-- Main input field -->
                <div class="input-group-modern">
                    <textarea class="form-control chat-input" id="messageInput"
                        placeholder="Type your message here... (Press Ctrl+Enter to send)" rows="1"
                        onkeydown="handleKeyDown(event)" oninput="autoResizeTextarea(this)"></textarea>
                    <button class="btn btn-primary send-button" onclick="sendMessage()" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Communications (moved below chat, non-collapsible) -->
    <div class="card mt-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5><i class="fas fa-comments"></i> Live Agent Communications</h5>
                    <small class="text-muted">Real-time view of AutoGen tasks and agent coordination during
                        searches</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="clearCommunicationsStream()">
                    <i class="fas fa-broom"></i> Clear
                </button>
            </div>
            <div id="communicationsDebugInfo" style="font-size: 0.8em; color: #6c757d; margin-top: 0.5rem;">
                🔄 Polling: <span id="pollingStatus">Inactive</span> |
                📊 Count: <span id="communicationCount">0</span> |
                🕒 Last Update: <span id="lastUpdate">Never</span>
            </div>
        </div>
        <div class="card-body" style="overflow-x: hidden; max-width: 100%;">
            <div id="communicationsStream" class="agent-communications"
                style="max-width: 100%; overflow-x: hidden; height: 450px; overflow-y: auto;">
                <div class="text-center text-muted py-3">
                    <i class="fas fa-robot fa-2x mb-2"></i>
                    <p>⚙️ AutoGen tasks and results will appear here</p>
                    <p><small>Watch real-time task execution and agent coordination during searches</small></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize Enhanced Agent Communication Handler
    let currentSessionId = null;
    let totalExchanges = 0;
    let agentsInvolved = [];

    // Real-time communication polling variables
    let communicationPollingInterval = null;
    let lastCommunicationCount = 0;
    let searchInProgress = false;

    // Toggle to control whether the chat pane should auto-scroll when new messages arrive.
    // Set to false to disable automatic scrolling (user preference: manual scroll).
    // let CHAT_AUTO_SCROLL = false;

    // Wrapper helpers that delegate to the shared AgentCommunicationHandler when available
    function appendToCommunicationsStream(content) {
        try {
            // Prefer the tidy AgentComm namespace when available
            if (window.AgentComm && typeof window.AgentComm.createHandler === 'function') {
                const handler = window.AgentComm.createHandler('communicationsStream');
                if (handler && typeof handler.addInteraction === 'function') {
                    handler.addInteraction('📋 System', String(content), 'text');
                    return;
                }
            }
        } catch (e) {
            console.error('appendToCommunicationsStream wrapper error:', e);
        }
    }

    // Real-time communication polling functions
    async function startCommunicationPolling() {
        console.log('🚀 Starting real-time communication polling for chat');

        // Update debug info
        const pollingStatus = document.getElementById('pollingStatus');
        if (pollingStatus) pollingStatus.textContent = 'Active';

        if (communicationPollingInterval) {
            clearInterval(communicationPollingInterval);
        }

        communicationPollingInterval = setInterval(async () => {
            if (!searchInProgress) {
                console.log('🛑 Search completed, stopping polling');
                clearInterval(communicationPollingInterval);
                communicationPollingInterval = null;

                // Update debug info
                const pollingStatus = document.getElementById('pollingStatus');
                if (pollingStatus) pollingStatus.textContent = 'Completed';
                return;
            }

            try {
                const response = await fetch('/api/communications/chat');
                const data = await response.json();

                // Update debug info
                const communicationCount = document.getElementById('communicationCount');
                const lastUpdate = document.getElementById('lastUpdate');
                if (communicationCount) communicationCount.textContent = data.count || 0;
                if (lastUpdate) lastUpdate.textContent = new Date().toLocaleTimeString();

                if (data.success && data.communications && data.count > lastCommunicationCount) {
                    console.log(`📡 New communications detected: ${data.count} (was ${lastCommunicationCount})`);
                    const newCommunications = data.communications.slice(lastCommunicationCount);

                    // Display new communications
                    if (typeof displayAgentCommunications === 'function') {
                        displayAgentCommunications(newCommunications, {
                            containerId: 'communicationsStream',
                            showFlow: true,
                            autoExpand: false,
                            autoScroll: false,
                            append: true  // Append instead of replace
                        });
                    }

                    lastCommunicationCount = data.count;
                }
            } catch (error) {
                console.error('💥 Error polling communications:', error);

                // Update debug info
                const lastUpdate = document.getElementById('lastUpdate');
                if (lastUpdate) lastUpdate.textContent = 'Error';
            }
        }, 2000); // Poll every 2 seconds
    }

    function stopCommunicationPolling() {
        console.log('🛑 Stopping real-time communication polling');
        if (communicationPollingInterval) {
            clearInterval(communicationPollingInterval);
            communicationPollingInterval = null;
        }
        searchInProgress = false;

        // Update debug info
        const pollingStatus = document.getElementById('pollingStatus');
        if (pollingStatus) pollingStatus.textContent = 'Inactive';
    }

    async function clearCommunicationsStream() {
        try {
            // First, clear the backend orchestrator communications log
            const response = await fetch('/api/communications/chat/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                console.error('Backend chat communications clear failed:', response.statusText);
            }

            // Reset polling counter
            lastCommunicationCount = 0;

            // Reset debug info
            const communicationCount = document.getElementById('communicationCount');
            const lastUpdate = document.getElementById('lastUpdate');
            if (communicationCount) communicationCount.textContent = '0';
            if (lastUpdate) lastUpdate.textContent = 'Cleared';

        } catch (error) {
            console.error('Error clearing backend chat communications:', error.message);
        }

        // try {
        //     if (window.AgentComm && typeof window.AgentComm.createHandler === 'function') {
        //         const handler = window.AgentComm.createHandler('communicationsStream');
        //         if (handler && typeof handler.clearDisplay === 'function') {
        //             handler.clearDisplay();
        //         }
        //     }
        // } catch (e) {
        //     console.error('clearCommunicationsStream wrapper error:', e);
        // }

        // Clear interactions using AgentComm if available
        if (window.AgentComm && typeof window.AgentComm.clearAllCommunications === 'function') {
            window.AgentComm.clearAllCommunications();
        }

        // Clear any AgentComm handlers that might have cached data
        if (window.AgentComm && typeof window.AgentComm.clearHandler === 'function') {
            try {
                window.AgentComm.clearHandler('communicationsStream');
            } catch (e) {
                // Silent fail - not critical
            }
        }

        const stream = document.getElementById('communicationsStream');
        if (stream) {
            stream.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-robot fa-2x mb-3"></i>
                <p>⚙️ AutoGen tasks and results will appear here</p>
                <p><small>Watch real-time task execution and agent coordination during conversations</small></p>
            </div>
        `;
        }
    }

    // Enhanced Agent Communication Functions
    function updateConversationStats() {
        const statsElement = document.getElementById('conversationStats');
        if (statsElement) {
            statsElement.textContent = `${totalExchanges} exchanges`;
        }
    }

    function updateCommStats() {
        const statsElement = document.getElementById('commStats');
        if (statsElement) {
            statsElement.textContent = `${agentsInvolved.length} agents involved`;
        }
    }

    // Initialize when document loads
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize the communications panel
        clearCommunicationsStream();

        // Ensure spinner is hidden on page load
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) {
            spinner.style.display = 'none';
        }
    });

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function sendExampleQuery(query) {
        document.getElementById('messageInput').value = query;
        sendMessage();
    }

    function sendQuickMessage(query) {
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.value = query;
            sendMessage();
        }
    }

    function clearConversation() {
        // Clear the chat messages
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="text-center text-muted py-5">
                    <div class="mb-3">
                        <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                    </div>
                    <h5>Welcome to the AI Assistant!</h5>
                    <p class="mb-4">Ask about your software inventory, EOL risks, or get expert recommendations.</p>
                </div>
            `;
        }

        // Clear the communications stream
        clearCommunicationsStream();

        // Reset conversation stats
        totalExchanges = 0;
        agentsInvolved = [];
        currentSessionId = null;
        updateConversationStats();
    }

    // Handle keyboard shortcuts for message input
    function handleKeyDown(event) {
        const textarea = event.target;

        // Handle Ctrl+Enter or Cmd+Enter to send message
        if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
            return;
        }

        // Auto-resize textarea on input
        setTimeout(() => {
            autoResizeTextarea(textarea);
        }, 0);
    }

    // Auto-resize textarea function
    function autoResizeTextarea(textarea) {
        // Reset height to auto to get the scroll height
        textarea.style.height = 'auto';

        // Set the height to the scroll height, with min and max limits
        const minHeight = 40; // Minimum height in pixels
        const maxHeight = 200; // Maximum height in pixels
        const newHeight = Math.min(Math.max(textarea.scrollHeight, minHeight), maxHeight);

        textarea.style.height = newHeight + 'px';

        // Add scrollbar if content exceeds max height
        if (textarea.scrollHeight > maxHeight) {
            textarea.style.overflowY = 'auto';
        } else {
            textarea.style.overflowY = 'hidden';
        }
    }

    // Helper functions for send button state management
    function setSendButtonLoading() {
        const sendButton = document.getElementById('sendButton');
        const sendButtonIcon = sendButton.querySelector('i');
        sendButtonIcon.className = 'fas fa-spinner fa-spin';
        sendButton.disabled = true;
    }

    function setSendButtonReady() {
        const sendButton = document.getElementById('sendButton');
        const sendButtonIcon = sendButton.querySelector('i');
        sendButtonIcon.className = 'fas fa-paper-plane';
        sendButton.disabled = false;
    }

    async function sendMessage(confirmed = false, originalMessage = null) {
        const messageInput = document.getElementById('messageInput');
        const message = originalMessage || messageInput.value.trim();

        if (!message) return;

        // Clear input and set loading state
        if (!originalMessage) {
            messageInput.value = '';
        }
        setSendButtonLoading();

        // Add user message to chat (only if not a confirmation)
        if (!confirmed) {
            addMessageToChat('user', message);

            // Clear previous communications and start real-time polling
            await clearCommunicationsStream();
            searchInProgress = true;
            await startCommunicationPolling();
        }

        try {
            const requestBody = {
                message: message,
                use_autogen: true,
                timeout_seconds: 150  // Match with frontend timeout but leave buffer
            };

            // Add confirmation parameters if this is a confirmed request
            if (confirmed && originalMessage) {
                requestBody.confirmed = true;
                requestBody.original_message = originalMessage;
            }

            // Create abort controller for timeout handling
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 180000); // 180 second timeout (3 minutes) for inventory operations

            const response = await fetch('/api/autogen-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                let errorData;
                try {
                    const errorText = await response.text();
                    if (errorText.trim()) {
                        errorData = JSON.parse(errorText);
                    } else {
                        errorData = { detail: `HTTP ${response.status}: ${response.statusText}` };
                    }
                } catch (parseError) {
                    errorData = { detail: `HTTP ${response.status}: ${response.statusText}` };
                }
                throw new Error(errorData.detail || 'Network error');
            }

            let data;
            try {
                const responseText = await response.text();

                if (!responseText.trim()) {
                    console.error('Empty response received from server');
                    throw new Error('Empty response from server');
                }

                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error('JSON Parse Error:', parseError);
                console.error('Response status:', response.status);
                console.error('Response text length:', responseText?.length || 0);
                throw new Error(`Invalid response format from server (${parseError.message})`);
            }

            // Update session info
            currentSessionId = data.session_id;
            totalExchanges = data.total_exchanges;
            agentsInvolved = data.agents_involved;

            // Update stats
            updateConversationStats();
            updateCommStats();

            // Handle confirmation required
            if (data.confirmation_required && data.pending_message) {
                addMessageToChat('agent', data.response);
                showConfirmationButtons(data.pending_message);
                setSendButtonReady();
                return;
            }

            // Handle confirmation declined
            if (data.confirmation_declined) {
                addMessageToChat('agent', data.response);
                setSendButtonReady();
                return;
            }

            // Add agent response to chat
            addMessageToChat('agent', data.response);

            // Show fast path indicator if used
            if (data.fast_path) {
                const indicator = document.createElement('small');
                indicator.style.color = '#28a745';
                indicator.style.fontStyle = 'italic';
                indicator.textContent = '⚡ Fast path: Direct inventory retrieval';
                document.querySelector('.chat-messages').appendChild(indicator);
            }

            if (data.agent_communications && data.agent_communications.length > 0) {
                if (typeof displayAgentCommunications === 'function') {
                    displayAgentCommunications(data.agent_communications, { containerId: 'communicationsStream', showFlow: true, autoExpand: false, autoScroll: false });
                }
            }
            // Note: We do NOT clear the communications panel here if no communications are provided
            // The communications should persist and accumulate throughout the conversation
            // They are only cleared when a new user message is sent

        } catch (error) {
            console.error('Error:', error);

            let errorMessage;
            if (error.name === 'AbortError') {
                errorMessage = '❌ Request timed out. The server took too long to respond. Please try again.';
            } else if (error.message.includes('Invalid response format')) {
                errorMessage = '❌ Server response error. The server returned invalid data. Please try again.';
            } else if (error.message.includes('Empty response')) {
                errorMessage = '❌ Empty server response. The server did not return any data. Please try again.';
            } else {
                errorMessage = `❌ Error: ${error.message}. Please try again.`;
            }

            addMessageToChat('agent', errorMessage);

        } finally {
            // Stop real-time polling
            stopCommunicationPolling();

            // Restore send button to ready state
            setSendButtonReady();
            messageInput.focus();
        }
    }

    function addMessageToChat(type, content) {
        const chatMessages = document.getElementById('chatMessages');

        // Clear welcome message on first real message
        const welcomeMessage = chatMessages.querySelector('.text-center.text-muted.py-5');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }

        // Create message group container
        const messageGroup = document.createElement('div');
        messageGroup.className = 'message-group';

        // Create message bubble
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble ${type === 'user' ? 'message-user' : 'message-assistant'}`;

        // Create message header with timestamp
        const messageHeader = document.createElement('div');
        messageHeader.className = 'message-header';
        messageHeader.innerHTML = `
            <span class="message-sender">${type === 'user' ? 'You' : 'AI Assistant'}</span>
            <span class="message-time">${new Date().toLocaleTimeString()}</span>
        `;

        // Create message content
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        // Check if content is long enough to need pagination
        const shouldPaginate = shouldContentBePaginated(content);

        if (shouldPaginate) {
            const paginatedContent = createPaginatedContent(content);
            messageContent.appendChild(paginatedContent);
        } else {
            // Format content with basic markdown support
            const formattedContent = formatMessageContent(content);
            messageContent.innerHTML = formattedContent;
        }

        // Assemble the message
        messageDiv.appendChild(messageHeader);
        messageDiv.appendChild(messageContent);
        messageGroup.appendChild(messageDiv);

        chatMessages.appendChild(messageGroup);

        // Auto-scroll to the new message
        messageGroup.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    function shouldContentBePaginated(content) {
        const lines = content.split('\n');
        const words = content.split(' ');
        const characters = content.length;

        // Paginate if content is large
        return lines.length > 30 || words.length > 500 || characters > 3000;
    }

    function createPaginatedContent(content) {
        const container = document.createElement('div');
        container.className = 'paginated-content';

        // Split content into logical pages
        const pages = splitContentIntoPages(content);

        let currentPage = 0;

        // Content display area
        const contentArea = document.createElement('div');
        contentArea.className = 'paginated-content-area';

        // Pagination controls
        const paginationContainer = document.createElement('div');
        paginationContainer.className = 'pagination-container';

        // Content preview for context
        const contentPreview = document.createElement('div');
        contentPreview.className = 'content-preview';
        contentPreview.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
        contentPreview.style.border = '1px solid #f59e0b';
        contentPreview.style.borderRadius = '8px';
        contentPreview.style.padding = '1rem';
        contentPreview.style.marginBottom = '1rem';
        contentPreview.innerHTML = `
            <div class="content-summary" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-file-text" style="color: #d97706; font-size: 1.2em;"></i>
                    <span style="font-weight: 700; color: #92400e;">Large Response</span>
                </div>
                <div style="display: flex; gap: 1rem; font-size: 0.9rem; color: #b45309;">
                    <span><i class="fas fa-layer-group" style="margin-right: 0.25rem;"></i>${pages.length} pages</span>
                    <span><i class="fas fa-list-ol" style="margin-right: 0.25rem;"></i>${content.split('\n').length} lines</span>
                    <span><i class="fas fa-font" style="margin-right: 0.25rem;"></i>${content.split(' ').length} words</span>
                </div>
            </div>
            <div style="text-align: center; font-size: 0.9em; color: #a16207;">
                <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                Content has been paginated for better readability. Use the navigation controls below.
            </div>
        `;

        function updatePage() {
            const formattedContent = formatMessageContent(pages[currentPage]);
            contentArea.innerHTML = formattedContent;
            updatePaginationControls();
        }

        function updatePaginationControls() {
            const controls = document.createElement('div');
            controls.className = 'pagination-controls';

            // Info section (left side)
            const infoSection = document.createElement('div');
            infoSection.className = 'pagination-info-section';

            // Summary stats
            const summary = document.createElement('div');
            summary.className = 'pagination-summary';
            summary.innerHTML = `
                <span class="pagination-summary-title">
                    <i class="fas fa-file-alt" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                    Pagination Overview
                </span>
            `;

            const stats = document.createElement('div');
            stats.className = 'pagination-summary-stats';
            stats.innerHTML = `
                <span><strong>${pages.length}</strong> pages</span>
                <span><strong>${content.split('\n').length}</strong> lines</span>
                <span><strong>${content.split(' ').length}</strong> words</span>
                <span>Page <strong>${currentPage + 1}</strong> of <strong>${pages.length}</strong></span>
            `;

            infoSection.appendChild(summary);
            infoSection.appendChild(stats);

            // Navigation section (right side)
            const navSection = document.createElement('nav');
            navSection.setAttribute('aria-label', 'Content pagination');

            const paginationList = document.createElement('ul');
            paginationList.className = 'pagination pagination-sm mb-0';

            // Previous button
            const prevItem = document.createElement('li');
            prevItem.className = `page-item${currentPage === 0 ? ' disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevLink.setAttribute('aria-label', 'Previous');
            if (currentPage > 0) {
                prevLink.onclick = (e) => {
                    e.preventDefault();
                    currentPage--;
                    updatePage();
                };
            }
            prevItem.appendChild(prevLink);
            paginationList.appendChild(prevItem);

            // First page (if not near beginning)
            if (currentPage > 2) {
                const firstItem = document.createElement('li');
                firstItem.className = 'page-item';
                const firstLink = document.createElement('a');
                firstLink.className = 'page-link';
                firstLink.href = '#';
                firstLink.textContent = '1';
                firstLink.onclick = (e) => {
                    e.preventDefault();
                    currentPage = 0;
                    updatePage();
                };
                firstItem.appendChild(firstLink);
                paginationList.appendChild(firstItem);

                if (currentPage > 3) {
                    const ellipsisItem = document.createElement('li');
                    ellipsisItem.className = 'page-item disabled';
                    const ellipsisLink = document.createElement('span');
                    ellipsisLink.className = 'page-link';
                    ellipsisLink.textContent = '…';
                    ellipsisItem.appendChild(ellipsisLink);
                    paginationList.appendChild(ellipsisItem);
                }
            }

            // Page numbers around current page
            const startPage = Math.max(0, currentPage - 1);
            const endPage = Math.min(pages.length - 1, currentPage + 1);

            for (let i = startPage; i <= endPage; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item${i === currentPage ? ' active' : ''}`;
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i + 1;
                if (i !== currentPage) {
                    pageLink.onclick = (e) => {
                        e.preventDefault();
                        currentPage = i;
                        updatePage();
                    };
                }
                pageItem.appendChild(pageLink);
                paginationList.appendChild(pageItem);
            }

            // Last page (if not near end)
            if (currentPage < pages.length - 3) {
                if (currentPage < pages.length - 4) {
                    const ellipsisItem = document.createElement('li');
                    ellipsisItem.className = 'page-item disabled';
                    const ellipsisLink = document.createElement('span');
                    ellipsisLink.className = 'page-link';
                    ellipsisLink.textContent = '…';
                    ellipsisItem.appendChild(ellipsisLink);
                    paginationList.appendChild(ellipsisItem);
                }

                const lastItem = document.createElement('li');
                lastItem.className = 'page-item';
                const lastLink = document.createElement('a');
                lastLink.className = 'page-link';
                lastLink.href = '#';
                lastLink.textContent = pages.length;
                lastLink.onclick = (e) => {
                    e.preventDefault();
                    currentPage = pages.length - 1;
                    updatePage();
                };
                lastItem.appendChild(lastLink);
                paginationList.appendChild(lastItem);
            }

            // Next button
            const nextItem = document.createElement('li');
            nextItem.className = `page-item${currentPage === pages.length - 1 ? ' disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextLink.setAttribute('aria-label', 'Next');
            if (currentPage < pages.length - 1) {
                nextLink.onclick = (e) => {
                    e.preventDefault();
                    currentPage++;
                    updatePage();
                };
            }
            nextItem.appendChild(nextLink);
            paginationList.appendChild(nextItem);

            navSection.appendChild(paginationList);

            // Assemble the controls
            controls.appendChild(infoSection);
            controls.appendChild(navSection);

            // Clear and update pagination container
            paginationContainer.innerHTML = '';
            paginationContainer.appendChild(controls);
        }

        // Initial setup
        container.appendChild(contentPreview);
        container.appendChild(contentArea);
        container.appendChild(paginationContainer);

        updatePage();

        return container;
    }

    function splitContentIntoPages(content) {
        const lines = content.split('\n');
        const pages = [];
        const pageSize = 25; // Show 25 lines per page

        // Try to split at logical boundaries (headers, sections, etc.)
        let currentPage = [];
        let currentPageLines = 0;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const nextLine = i < lines.length - 1 ? lines[i + 1] : null;

            // Check if we should start a new page
            const isLogicalBreak = (
                line.startsWith('#') ||  // Markdown headers
                line.startsWith('**') ||  // Bold sections
                line.startsWith('✅') ||  // Check marks
                line.startsWith('❌') ||  // X marks
                line.startsWith('🔍') ||  // Search icons
                line.startsWith('📊') ||  // Chart icons
                line.startsWith('---') ||  // Horizontal rules
                line.startsWith('===') ||  // Horizontal rules
                (line.trim() === '' && currentPageLines > 0 && nextLine && nextLine.trim() !== '' &&
                    (nextLine.startsWith('#') || nextLine.startsWith('**') || nextLine.startsWith('✅') ||
                        nextLine.startsWith('❌') || nextLine.startsWith('🔍') || nextLine.startsWith('📊')))
            );

            // Force page break if we're getting too long, regardless of logical breaks
            const shouldForceBreak = currentPageLines >= pageSize;

            if ((shouldForceBreak || (currentPageLines >= Math.floor(pageSize * 0.8) && isLogicalBreak)) && currentPage.length > 0) {
                pages.push(currentPage.join('\n'));
                currentPage = [line];
                currentPageLines = 1;
            } else {
                currentPage.push(line);
                currentPageLines++;
            }
        }

        // Add the last page
        if (currentPage.length > 0) {
            pages.push(currentPage.join('\n'));
        }

        // Ensure we have at least one page
        if (pages.length === 0) {
            pages.push(content);
        }

        return pages;
    }

    function formatMessageContent(content) {
        // Basic markdown formatting including links
        return content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
            .replace(/\n/g, '<br>');
    }

    function formatInventoryAsTable(content) {
        // Re-enabled for inventory table support
        // HTML tables are now generated directly by the inventory tools
        return content; // Pass through HTML content as-is
    }

    function formatSectionAsTable(content, preferredHeaders = null) {
        // Re-enabled for table support  
        return content; // Pass through HTML content as-is
    }

    function enableTablePagination(tableId, pageSize = 25) {
        /**
         * Enable pagination for inventory tables
         */
        const table = document.getElementById(tableId);
        if (!table) {
            console.warn('Table not found for pagination:', tableId);
            return;
        }

        const tbody = table.querySelector('tbody');
        if (!tbody) {
            console.warn('Table body not found for pagination:', tableId);
            return;
        }

        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length <= pageSize) {
            // No pagination needed if rows fit in one page
            return;
        }

        let currentPage = 1;
        const totalPages = Math.ceil(rows.length / pageSize);

        // Create pagination container
        const paginationContainer = document.createElement('div');
        paginationContainer.className = 'pagination-container mt-3 d-flex justify-content-between align-items-center';
        paginationContainer.innerHTML = `
            <div class="pagination-info">
                <small class="text-muted">
                    Showing <span id="${tableId}-start">1</span> to 
                    <span id="${tableId}-end">${Math.min(pageSize, rows.length)}</span> of 
                    <span id="${tableId}-total">${rows.length}</span> items
                </small>
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="${tableId}-pagination">
                    <li class="page-item" id="${tableId}-prev">
                        <a class="page-link" href="#" onclick="changePage('${tableId}', ${currentPage - 1}); return false;">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    <li class="page-item" id="${tableId}-next">
                        <a class="page-link" href="#" onclick="changePage('${tableId}', ${currentPage + 1}); return false;">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        `;

        // Insert pagination container after table
        table.parentNode.insertBefore(paginationContainer, table.nextSibling);

        // Function to update page display
        window.changePage = function (tableId, page) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const totalPages = Math.ceil(rows.length / pageSize);

            if (page < 1 || page > totalPages) return;

            currentPage = page;

            // Hide all rows
            rows.forEach(row => row.style.display = 'none');

            // Show rows for current page
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            for (let i = start; i < end && i < rows.length; i++) {
                rows[i].style.display = '';
            }

            // Update pagination info
            document.getElementById(`${tableId}-start`).textContent = start + 1;
            document.getElementById(`${tableId}-end`).textContent = Math.min(end, rows.length);
            document.getElementById(`${tableId}-total`).textContent = rows.length;

            // Update pagination buttons
            const prevBtn = document.getElementById(`${tableId}-prev`);
            const nextBtn = document.getElementById(`${tableId}-next`);

            if (currentPage <= 1) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }

            if (currentPage >= totalPages) {
                nextBtn.classList.add('disabled');
            } else {
                nextBtn.classList.remove('disabled');
            }
        };

        // Initialize first page
        window.changePage(tableId, 1);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Delegate to shared agent communication handler when available.
    // Keep a lightweight fallback to render basic communications if the shared script isn't loaded.
    function displayAgentCommunications(communications, options = {}) {
        console.log('🎯 Chat displayAgentCommunications: Delegating to centralized handler');

        // Use the centralized handler from agent-communication.js
        if (window.AgentComm && typeof window.AgentComm.display === 'function') {
            const defaultOptions = {
                containerId: 'communicationsStream',
                showFlow: false,  // Chat-style: single column
                autoExpand: false, // Chat-style: don't auto-expand for rapid updates
                autoScroll: false  // Chat-style: manual scroll control
            };
            const finalOptions = Object.assign({}, defaultOptions, options);

            console.log('✅ Using centralized AgentComm.display with options:', finalOptions);
            window.AgentComm.display(communications, finalOptions);
        } else {
            console.error('❌ AgentComm.display not available, falling back to basic display');
            // Basic fallback
            const commContainer = document.getElementById(options.containerId || 'communicationsStream');
            if (commContainer) {
                if (!communications || communications.length === 0) {
                    if (!options.append) {
                        commContainer.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p><strong>No Agent Communications</strong></p>
                            <p>This conversation completed without detailed agent interactions to display.</p>
                            <p><small>For detailed multi-agent interactions, agent-communication.js handler is required.</small></p>
                        </div>`;
                    }
                } else {
                    if (!options.append) {
                        commContainer.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3 text-warning"></i>
                            <p><strong>Agent Communication Handler Not Available</strong></p>
                            <p>Found ${communications.length} communications but display handler failed to load.</p>
                            <p><small>Check console for details. Include agent-communication.js for full functionality.</small></p>
                        </div>`;
                    }
                }
            }
        }
    }

    // Global function to toggle interaction cards
    window.toggleChatInteraction = function (interactionId) {
        const content = document.getElementById(`content_${interactionId}`);
        const toggle = document.getElementById(`toggle_${interactionId}`);

        if (content && toggle) {
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                toggle.className = 'fas fa-chevron-down';
            }
        }
    };
</script>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/agent-communication.js"></script>
{% endblock %}